<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>å°ç£è‚¡ç¥¨AIå°ˆæ¥­åŠ©ç† V5.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", "Microsoft JhengHei", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background: linear-gradient(135deg, #1a1f35 0%, #2a324f 100%); 
            color: #e8edf3; 
            line-height: 1.7; 
            min-height: 100vh; 
            font-size: 16px; /* åŸºç¤å­—é«”å¤§å° */
        }
        .container { 
            max-width: 1100px; 
            margin: 15px auto; /* æ‰‹æ©Ÿä¸Šæ¸›å°‘ä¸Šä¸‹é‚Šè· */
            padding: 20px; /* æ‰‹æ©Ÿä¸Šæ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(145deg, rgba(42, 50, 79, 0.95) 0%, rgba(33, 39, 63, 0.98) 100%); 
            border-radius: 20px; 
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3), 0 8px 25px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08); 
            border: 1px solid rgba(179, 148, 74, 0.2); 
            backdrop-filter: blur(10px); 
        }
        h1 { 
            text-align: center; 
            margin-bottom: 15px; /* æ¸›å°‘ä¸‹é‚Šè· */
            background: linear-gradient(90deg, #d4b97a 0%, #e8d09d 50%, #d4b97a 100%); 
            -webkit-background-clip: text; 
            background-clip: text; 
            color: transparent; 
            font-size: 2.0rem; /* æ‰‹æ©Ÿä¸Šæ¸›å°å­—é«” */
            font-weight: 700; 
            letter-spacing: 0.5px; 
            text-shadow: 0 2px 15px rgba(212, 185, 122, 0.2); 
            position: relative; 
            padding-bottom: 10px; /* æ¸›å°‘å…§é‚Šè· */
        }
        h1::after { 
            content: ''; 
            position: absolute; 
            bottom: 0; 
            left: 30%; 
            width: 40%; 
            height: 2px; 
            background: linear-gradient(90deg, transparent, #d4b97a, transparent); 
            border-radius: 1px; 
        }
        h2 { 
            margin-top: 30px; /* æ¸›å°‘ä¸Šé‚Šè· */
            margin-bottom: 15px; /* æ¸›å°‘ä¸‹é‚Šè· */
            color: #d4b97a; 
            font-size: 1.5rem; /* æ‰‹æ©Ÿä¸Šæ¸›å°å­—é«” */
            font-weight: 600; 
            padding-left: 15px; 
            position: relative; 
            letter-spacing: 0.3px; 
        }
        h2::before { 
            content: ''; 
            position: absolute; 
            left: 0; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 3px; 
            height: 60%; 
            background: linear-gradient(to bottom, #d4b97a, transparent); 
            border-radius: 1.5px; 
        }
        .disclaimer { 
            background: linear-gradient(135deg, rgba(212, 185, 122, 0.08) 0%, rgba(42, 50, 79, 0.2) 100%); 
            border: 1px solid rgba(212, 185, 122, 0.15); 
            border-radius: 16px; 
            padding: 20px; /* æ¸›å°‘å…§é‚Šè· */
            margin-bottom: 25px; /* æ¸›å°‘ä¸‹é‚Šè· */
            position: relative; 
            overflow: hidden; 
        }
        .disclaimer::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(90deg, transparent, rgba(212, 185, 122, 0.03), transparent); 
            transform: translateX(-100%); 
            animation: shimmer 4s infinite; 
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .disclaimer h3 { 
            color: #d4b97a; 
            margin-bottom: 10px; /* æ¸›å°‘ä¸‹é‚Šè· */
            font-size: 1.2rem; /* æ‰‹æ©Ÿä¸Šæ¸›å°å­—é«” */
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 8px; /* æ¸›å°‘é–“è· */
        }
        .disclaimer h3::before { 
            content: 'âš ï¸'; 
            font-size: 1.0rem; /* æ¸›å°åœ–æ¨™å¤§å° */
        }
        .disclaimer ul { 
            margin-left: 15px; /* æ¸›å°‘å·¦é‚Šè· */
            color: #c8d1e0; 
        }
        .disclaimer li { 
            margin-bottom: 8px; /* æ¸›å°‘ä¸‹é‚Šè· */
            font-size: 0.95rem; /* æ¸›å°å­—é«” */
            padding-left: 8px; /* æ¸›å°‘å…§é‚Šè· */
            position: relative; 
        }
        .disclaimer li::before { 
            content: 'â€¢'; 
            color: #d4b97a; 
            font-weight: bold; 
            position: absolute; 
            left: -12px; /* èª¿æ•´ä½ç½® */
        }
        .section-note { 
            font-size: 1.0rem; /* æ¸›å°å­—é«” */
            color: #b8c5d8; 
            margin-bottom: 20px; /* æ¸›å°‘ä¸‹é‚Šè· */
            padding: 15px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(42, 50, 79, 0.6); 
            border-radius: 14px; 
            border-left: 3px solid #d4b97a; 
            line-height: 1.6; /* æ¸›å°‘è¡Œé«˜ */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); 
        }
        .form-group { 
            margin-bottom: 20px; /* æ¸›å°‘ä¸‹é‚Šè· */
        }
        label { 
            display: block; 
            margin-bottom: 8px; /* æ¸›å°‘ä¸‹é‚Šè· */
            font-weight: 600; 
            color: #d4b97a; 
            font-size: 1.0rem; /* æ¸›å°å­—é«” */
            letter-spacing: 0.2px; 
        }
        input[type="text"], input[type="number"], input[type="date"], select, textarea { 
            width: 100%; 
            padding: 12px 15px; /* æ¸›å°‘å…§é‚Šè· */
            border: 1px solid rgba(212, 185, 122, 0.2); 
            border-radius: 10px; 
            font-size: 1.0rem; /* æ¸›å°å­—é«” */
            background: rgba(33, 39, 63, 0.7); 
            color: #e8edf3; 
            transition: all 0.3s ease; 
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.2); 
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
            -webkit-appearance: none; /* ç§»é™¤iOSé»˜èªæ¨£å¼ */
            appearance: none;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #d4b97a; 
            box-shadow: 0 0 0 3px rgba(212, 185, 122, 0.1), inset 0 2px 6px rgba(0, 0, 0, 0.2); 
            background: rgba(42, 50, 79, 0.8); 
        }
        textarea { 
            height: 100px; /* æ¸›å°é«˜åº¦ */
            resize: vertical; 
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace; 
            line-height: 1.5; 
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
        }
        .row { 
            display: flex; 
            gap: 15px; /* æ¸›å°‘é–“è· */
            margin-bottom: 20px; /* æ¸›å°‘ä¸‹é‚Šè· */
        }
        .row > * { 
            flex: 1; 
        }
        button { 
            display: block; 
            width: 100%; 
            padding: 14px; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(135deg, #d4b97a 0%, #b89c5e 100%); 
            color: #1a1f35; 
            border: none; 
            border-radius: 10px; 
            font-size: 1.0rem; /* æ¸›å°å­—é«” */
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 6px 20px rgba(212, 185, 122, 0.25); 
            letter-spacing: 0.3px; 
            position: relative; 
            overflow: hidden; 
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
            min-width: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
            touch-action: manipulation; /* å„ªåŒ–è§¸æ§è¡Œç‚º */
        }
        button::before { 
            content: ''; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            width: 0; 
            height: 0; 
            border-radius: 50%; 
            background: rgba(255, 255, 255, 0.15); 
            transform: translate(-50%, -50%); 
            transition: width 0.6s, height 0.6s; 
        }
        button:hover::before { 
            width: 300px; 
            height: 300px; 
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 25px rgba(212, 185, 122, 0.35); 
            background: linear-gradient(135deg, #e8d09d 0%, #d4b97a 100%); 
        }
        button:active { 
            transform: translateY(0); 
            box-shadow: 0 4px 15px rgba(212, 185, 122, 0.25); 
        }
        button:disabled { 
            background: #4a536d; 
            color: #8a94b3; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        .button-group { 
            display: flex; 
            gap: 12px; /* æ¸›å°‘é–“è· */
            margin-top: 15px; /* æ¸›å°‘ä¸Šé‚Šè· */
        }
        button.secondary { 
            background: linear-gradient(135deg, #4a536d 0%, #3a435d 100%); 
            color: #e8edf3; 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); 
        }
        button.secondary:hover { 
            background: linear-gradient(135deg, #5a637d 0%, #4a536d 100%); 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25); 
        }
        button.success { 
            background: linear-gradient(135deg, #38a169 0%, #2d8f5c 100%); 
            color: white; 
            box-shadow: 0 6px 15px rgba(56, 161, 105, 0.25); 
        }
        button.success:hover { 
            background: linear-gradient(135deg, #48b179 0%, #38a169 100%); 
            box-shadow: 0 10px 20px rgba(56, 161, 105, 0.3); 
        }
        .note { 
            font-size: 0.85rem; /* æ¸›å°å­—é«” */
            color: #a8b5ca; 
            margin-top: 6px; /* æ¸›å°‘ä¸Šé‚Šè· */
            line-height: 1.4; /* æ¸›å°‘è¡Œé«˜ */
            font-style: italic; 
            padding-left: 8px; /* æ¸›å°‘å…§é‚Šè· */
            border-left: 2px solid rgba(212, 185, 122, 0.3); 
        }
        .notice { 
            font-size: 0.95rem; /* æ¸›å°å­—é«” */
            color: #d8e1f0; 
            margin-top: 12px; /* æ¸›å°‘ä¸Šé‚Šè· */
            padding: 12px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(212, 185, 122, 0.08); 
            border-radius: 10px; 
            border-left: 3px solid #d4b97a; 
        }
        .results { 
            display: none; 
            padding: 30px; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(145deg, rgba(42, 50, 79, 0.95) 0%, rgba(33, 39, 63, 0.98) 100%); 
            border-radius: 20px; 
            border: 1px solid rgba(212, 185, 122, 0.15); 
            margin-top: 30px; /* æ¸›å°‘ä¸Šé‚Šè· */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.05); 
        }
        .results.show { 
            display: block; 
            animation: fadeIn 0.5s ease-out; 
        }
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        .results p { 
            margin-bottom: 12px; /* æ¸›å°‘ä¸‹é‚Šè· */
            font-size: 1.0rem; /* æ¸›å°å­—é«” */
            padding: 8px 0; /* æ¸›å°‘å…§é‚Šè· */
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); 
        }
        .results strong { 
            color: #d4b97a; 
            font-weight: 600; 
        }
        .recommendation.buy { 
            color: #ff6b6b; 
            font-weight: bold; 
            font-size: 1.1rem; /* æ¸›å°å­—é«” */
            padding: 6px 12px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(255, 107, 107, 0.1); 
            border-radius: 10px; 
            display: inline-block; 
            border-left: 3px solid #ff6b6b; 
        }
        .recommendation.sell { 
            color: #51cf66; 
            font-weight: bold; 
            font-size: 1.1rem; /* æ¸›å°å­—é«” */
            padding: 6px 12px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(81, 207, 102, 0.1); 
            border-radius: 10px; 
            display: inline-block; 
            border-left: 3px solid #51cf66; 
        }
        .recommendation.hold { 
            color: #ffd43b; 
            font-weight: bold; 
            font-size: 1.1rem; /* æ¸›å°å­—é«” */
            padding: 6px 12px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(255, 212, 59, 0.1); 
            border-radius: 10px; 
            display: inline-block; 
            border-left: 3px solid #ffd43b; 
        }
        .rsi-value.oversold { 
            color: #51cf66; 
            font-weight: bold; 
            padding: 5px 10px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(81, 207, 102, 0.1); 
            border-radius: 8px; 
            display: inline-block; 
            border: 1px solid rgba(81, 207, 102, 0.2); 
        }
        .rsi-value.overbought { 
            color: #ff6b6b; 
            font-weight: bold; 
            padding: 5px 10px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(255, 107, 107, 0.1); 
            border-radius: 8px; 
            display: inline-block; 
            border: 1px solid rgba(255, 107, 107, 0.2); 
        }
        .rsi-value.neutral { 
            color: #a8b5ca; 
            font-weight: bold; 
            padding: 5px 10px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(168, 181, 202, 0.1); 
            border-radius: 8px; 
            display: inline-block; 
            border: 1px solid rgba(168, 181, 202, 0.2); 
        }
        .warning { 
            color: #ff6b6b; 
            font-weight: bold; 
            padding: 8px 15px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(255, 107, 107, 0.1); 
            border-radius: 10px; 
            border-left: 3px solid #ff6b6b; 
        }
        .alert-box { 
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(42, 50, 79, 0.2) 100%); 
            border: 1px solid rgba(255, 107, 107, 0.2); 
            border-radius: 14px; 
            padding: 15px; /* æ¸›å°‘å…§é‚Šè· */
            margin: 15px 0; /* æ¸›å°‘é‚Šè· */
            color: #ff6b6b; 
        }
        .ai-query-section { 
            margin-top: 20px; /* æ¸›å°‘ä¸Šé‚Šè· */
            padding: 20px; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(145deg, rgba(212, 185, 122, 0.05) 0%, rgba(42, 50, 79, 0.2) 100%); 
            border-radius: 18px; 
            border: 1px solid rgba(212, 185, 122, 0.15); 
        }
        .ai-platform-select { 
            margin-bottom: 15px; /* æ¸›å°‘ä¸‹é‚Šè· */
        }
        .api-key-section { 
            display: none; 
            margin-top: 15px; /* æ¸›å°‘ä¸Šé‚Šè· */
            padding: 15px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(42, 50, 79, 0.6); 
            border-radius: 14px; 
            border: 1px solid rgba(212, 185, 122, 0.15); 
        }
        .api-key-row { 
            display: flex; 
            gap: 12px; /* æ¸›å°‘é–“è· */
            align-items: flex-end; 
        }
        .api-key-input-group { 
            flex: 1; 
            position: relative; 
        }
        .api-key-input-group input[type="text"], .api-key-input-group input[type="password"] { 
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace; 
            font-size: 0.85rem; /* æ¸›å°å­—é«” */
            letter-spacing: 0.5px; 
            min-width: 0; 
            width: 100%; 
            padding: 12px 15px; /* æ¸›å°‘å…§é‚Šè· */
            border: 1px solid rgba(212, 185, 122, 0.2); 
            border-radius: 10px; 
            font-size: 1.0rem; /* æ¸›å°å­—é«” */
            background: rgba(33, 39, 63, 0.7); 
            color: #e8edf3; 
            transition: all 0.3s ease; 
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.2); 
        }
        .api-verify-btn { 
            flex: 0 0 auto; 
            width: 160px; /* æ¸›å°å¯¬åº¦ */
            margin-top: 0; 
        }
        .api-status { 
            margin-top: 8px; /* æ¸›å°‘ä¸Šé‚Šè· */
            padding: 8px; /* æ¸›å°‘å…§é‚Šè· */
            border-radius: 8px; 
            font-size: 0.85rem; /* æ¸›å°å­—é«” */
            display: none; 
        }
        .api-status.success { 
            background: rgba(81, 207, 102, 0.1); 
            border: 1px solid rgba(81, 207, 102, 0.2); 
            color: #51cf66; 
        }
        .api-status.error { 
            background: rgba(255, 107, 107, 0.1); 
            border: 1px solid rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
        }
        .api-key-help { 
            margin-top: 6px; /* æ¸›å°‘ä¸Šé‚Šè· */
            font-size: 0.8rem; /* æ¸›å°å­—é«” */
            color: #a8b5ca; 
        }
        .api-key-help a { 
            color: #d4b97a; 
            text-decoration: none; 
            border-bottom: 1px dotted rgba(212, 185, 122, 0.5); 
            transition: all 0.2s ease; 
        }
        .api-key-help a:hover { 
            color: #e8d09d; 
            border-bottom: 1px solid rgba(232, 208, 157, 0.8); 
        }
        .query-section { 
            margin-top: 15px; /* æ¸›å°‘ä¸Šé‚Šè· */
        }
        .query-input-row { 
            display: flex; 
            gap: 12px; /* æ¸›å°‘é–“è· */
            align-items: flex-end; 
        }
        .query-input-group { 
            flex: 1; 
        }
        .query-submit-btn { 
            flex: 0 0 auto; 
            width: 140px; /* æ¸›å°å¯¬åº¦ */
        }
        .ai-response-section { 
            margin-top: 15px; /* æ¸›å°‘ä¸Šé‚Šè· */
            padding: 15px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(33, 39, 63, 0.7); 
            border-radius: 14px; 
            border: 1px solid rgba(212, 185, 122, 0.15); 
            min-height: 150px; /* æ¸›å°é«˜åº¦ */
            max-height: 400px; /* æ¸›å°æœ€å¤§é«˜åº¦ */
            overflow-y: auto; 
            display: none; 
        }
        .ai-response-section.show { 
            display: block; 
        }
        .ai-response-section h4 { 
            color: #d4b97a; 
            margin-bottom: 12px; /* æ¸›å°‘ä¸‹é‚Šè· */
            font-size: 1.1rem; /* æ¸›å°å­—é«” */
        }
        .ai-response-content { 
            color: #e8edf3; 
            line-height: 1.6; /* æ¸›å°‘è¡Œé«˜ */
            white-space: pre-wrap; 
            word-wrap: break-word; 
        }
        .loading-spinner { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border: 3px solid rgba(212, 185, 122, 0.3); 
            border-top-color: #d4b97a; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            to { 
                transform: rotate(360deg); 
            } 
        }
        .company-type-section { 
            margin-bottom: 25px; /* æ¸›å°‘ä¸‹é‚Šè· */
            padding: 20px; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(135deg, rgba(212, 185, 122, 0.08) 0%, rgba(42, 50, 79, 0.2) 100%); 
            border-radius: 16px; 
            border: 1px solid rgba(212, 185, 122, 0.15); 
        }
        .company-type-options { 
            display: flex; 
            gap: 12px; /* æ¸›å°‘é–“è· */
            margin-top: 12px; /* æ¸›å°‘ä¸Šé‚Šè· */
            flex-wrap: wrap; 
        }
        .company-type-btn { 
            flex: 1; 
            min-width: 100px; /* æ¸›å°æœ€å°å¯¬åº¦ */
            padding: 12px; /* æ¸›å°‘å…§é‚Šè· */
            border: 2px solid rgba(212, 185, 122, 0.3); 
            border-radius: 10px; 
            background: rgba(33, 39, 63, 0.6); 
            color: #e8edf3; 
            font-size: 0.95rem; /* æ¸›å°å­—é«” */
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-align: center; 
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
        }
        .company-type-btn:hover { 
            background: rgba(42, 50, 79, 0.8); 
            border-color: #d4b97a; 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(212, 185, 122, 0.2); 
        }
        .company-type-btn.active { 
            background: linear-gradient(135deg, #d4b97a 0%, #b89c5e 100%); 
            color: #1a1f35; 
            border-color: #d4b97a; 
        }
        .hot-stocks { 
            margin: 20px 0; /* æ¸›å°‘é‚Šè· */
            padding: 15px; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(135deg, rgba(42, 50, 79, 0.6) 0%, rgba(33, 39, 63, 0.8) 100%); 
            border-radius: 14px; 
            border: 1px solid rgba(212, 185, 122, 0.15); 
        }
        .hot-stocks h4 { 
            margin-bottom: 12px; /* æ¸›å°‘ä¸‹é‚Šè· */
            color: #d4b97a; 
            font-size: 1.1rem; /* æ¸›å°å­—é«” */
            font-weight: 600; 
        }
        .hot-stocks select { 
            width: 100%; 
            padding: 10px 14px; /* æ¸›å°‘å…§é‚Šè· */
            border: 1px solid rgba(212, 185, 122, 0.2); 
            border-radius: 10px; 
            font-size: 0.95rem; /* æ¸›å°å­—é«” */
            background: rgba(33, 39, 63, 0.7); 
            color: #e8edf3; 
            transition: all 0.3s ease; 
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.2); 
            cursor: pointer; 
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
        }
        .hot-stocks select:focus { 
            outline: none; 
            border-color: #d4b97a; 
            box-shadow: 0 0 0 3px rgba(212, 185, 122, 0.1), inset 0 2px 6px rgba(0, 0, 0, 0.2); 
            background: rgba(42, 50, 79, 0.8); 
        }
        .hot-stocks option { 
            background: #2a324f; 
            color: #e8edf3; 
            padding: 8px; 
        }
        .hot-stocks option[value=""] { 
            color: #a8b5ca; 
            font-style: italic; 
        }
        .hot-stocks option.group-header { 
            background: #1a1f35; 
            color: #d4b97a; 
            font-weight: bold; 
            font-size: 0.95rem; /* æ¸›å°å­—é«” */
            padding: 8px; /* æ¸›å°‘å…§é‚Šè· */
        }
        .indicator-toggle { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            cursor: pointer; 
            color: #d4b97a; 
            font-size: 0.95rem; /* æ¸›å°å­—é«” */
            margin-top: 8px; /* æ¸›å°‘ä¸Šé‚Šè· */
            padding: 6px 10px; /* æ¸›å°‘å…§é‚Šè· */
            border-radius: 8px; 
            background: rgba(212, 185, 122, 0.1); 
            border: 1px solid rgba(212, 185, 122, 0.2); 
            transition: all 0.3s ease; 
            width: 100%; 
            box-sizing: border-box; 
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
        }
        .indicator-toggle:hover { 
            background: rgba(212, 185, 122, 0.15); 
        }
        .indicator-toggle .toggle-icon { 
            transition: transform 0.3s ease; 
            font-size: 0.8rem; /* æ¸›å°å­—é«” */
        }
        .indicator-toggle.expanded .toggle-icon { 
            transform: rotate(90deg); 
        }
        .indicator-note { 
            display: none; 
            margin-top: 8px; 
            margin-bottom: 15px; /* æ¸›å°‘ä¸‹é‚Šè· */
            padding: 12px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(42, 50, 79, 0.6); 
            border-radius: 10px; 
            border-left: 3px solid #d4b97a; 
            line-height: 1.5; /* æ¸›å°‘è¡Œé«˜ */
            width: 100%; 
            box-sizing: border-box; 
        }
        .indicator-note.show { 
            display: block; 
            animation: fadeIn 0.3s ease-out; 
        }
        .price-suggestion-section { 
            margin-top: 20px; /* æ¸›å°‘ä¸Šé‚Šè· */
            margin-bottom: 20px; /* æ¸›å°‘ä¸‹é‚Šè· */
            padding: 20px; /* æ¸›å°‘å…§é‚Šè· */
            border-radius: 14px; 
            border: 1px solid; 
        }
        .user-settings { 
            background: linear-gradient(135deg, rgba(42, 50, 79, 0.7) 0%, rgba(33, 39, 63, 0.8) 100%); 
            border-color: rgba(212, 185, 122, 0.3); 
            margin-bottom: 15px; /* æ¸›å°‘ä¸‹é‚Šè· */
        }
        .ai-suggestions { 
            background: linear-gradient(135deg, rgba(212, 185, 122, 0.05) 0%, rgba(42, 50, 79, 0.7) 100%); 
            border-color: rgba(212, 185, 122, 0.2); 
        }
        .price-suggestion-section h4 { 
            margin-bottom: 15px; /* æ¸›å°‘ä¸‹é‚Šè· */
            color: #d4b97a; 
            font-size: 1.2rem; /* æ¸›å°å­—é«” */
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 8px; /* æ¸›å°‘é–“è· */
        }
        .user-settings h4::before { 
            content: 'ğŸ‘¤'; 
            font-size: 1.1rem; /* æ¸›å°åœ–æ¨™å¤§å° */
        }
        .ai-suggestions h4::before { 
            content: 'ğŸ¤–'; 
            font-size: 1.1rem; /* æ¸›å°åœ–æ¨™å¤§å° */
        }
        .price-suggestion-section p { 
            margin-bottom: 10px; /* æ¸›å°‘ä¸‹é‚Šè· */
            padding: 6px 0; /* æ¸›å°‘å…§é‚Šè· */
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); 
        }
        .selected-stock-display { 
            background: linear-gradient(135deg, rgba(212, 185, 122, 0.15) 0%, rgba(42, 50, 79, 0.3) 100%); 
            border: 2px solid rgba(212, 185, 122, 0.4); 
            border-radius: 12px; 
            padding: 15px; /* æ¸›å°‘å…§é‚Šè· */
            font-size: 1.1rem; /* æ¸›å°å­—é«” */
            font-weight: bold; 
            color: #d4b97a; 
            text-align: center; 
            margin: 12px 0; /* æ¸›å°‘é‚Šè· */
            box-shadow: 0 4px 20px rgba(212, 185, 122, 0.2); 
            letter-spacing: 1px; 
        }
        .stop-loss-warning { 
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(42, 50, 79, 0.2) 100%); 
            border: 1px solid rgba(255, 107, 107, 0.2); 
            border-radius: 14px; 
            padding: 12px; /* æ¸›å°‘å…§é‚Šè· */
            margin: 8px 0; /* æ¸›å°‘é‚Šè· */
            color: #ff6b6b; 
            font-size: 0.95rem; /* æ¸›å°å­—é«” */
        }
        .market-chart-container { 
            display: none; 
            margin-top: 20px; /* æ¸›å°‘ä¸Šé‚Šè· */
            padding: 20px; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(135deg, rgba(42, 50, 79, 0.7) 0%, rgba(33, 39, 63, 0.9) 100%); 
            border-radius: 14px; 
            border: 1px solid rgba(212, 185, 122, 0.2); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); 
            position: relative; 
        }
        .market-chart-container.show { 
            display: block; 
            animation: fadeIn 0.5s ease-out; 
        }
        .chart-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; /* æ¸›å°‘ä¸‹é‚Šè· */
        }
        .chart-header h4 { 
            color: #d4b97a; 
            font-size: 1.2rem; /* æ¸›å°å­—é«” */
            margin: 0; 
        }
        .chart-close-btn { 
            background: rgba(255, 107, 107, 0.1); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.2); 
            padding: 6px 12px; /* æ¸›å°‘å…§é‚Šè· */
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.85rem; /* æ¸›å°å­—é«” */
            transition: all 0.3s ease; 
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
        }
        .chart-close-btn:hover { 
            background: rgba(255, 107, 107, 0.2); 
        }
        .chart-wrapper { 
            position: relative; 
            width: 100%; 
            height: 350px; /* æ¸›å°é«˜åº¦ */
            background: rgba(33, 39, 63, 0.5); 
            border-radius: 10px; 
            overflow: hidden; 
            touch-action: pan-x pan-y pinch-zoom; /* å„ªåŒ–è§¸æ§æ‰‹å‹¢ */
        }
        #marketComparisonChart { 
            width: 100%; 
            height: 100%; 
            cursor: crosshair; 
            touch-action: pan-x pan-y pinch-zoom; /* å„ªåŒ–è§¸æ§æ‰‹å‹¢ */
        }
        .chart-vertical-line { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 1px; 
            background: rgba(212, 185, 122, 0.4); 
            pointer-events: none; 
            z-index: 999; 
            display: none; 
        }
        .chart-data-point { 
            position: absolute; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            border: 2px solid white; 
            pointer-events: none; 
            z-index: 998; 
            display: none; 
        }
        .chart-data-point.stock { 
            background: #ff6b6b; 
            border-color: #ff6b6b; 
        }
        .chart-data-point.market { 
            background: #51cf66; 
            border-color: #51cf66; 
        }
        .chart-legend { 
            display: flex; 
            justify-content: center; 
            gap: 15px; /* æ¸›å°‘é–“è· */
            margin-top: 12px; /* æ¸›å°‘ä¸Šé‚Šè· */
            flex-wrap: wrap; 
        }
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 6px; /* æ¸›å°‘é–“è· */
            font-size: 0.85rem; /* æ¸›å°å­—é«” */
        }
        .legend-color { 
            width: 10px; /* æ¸›å°å¤§å° */
            height: 10px; /* æ¸›å°å¤§å° */
            border-radius: 50%; 
        }
        .legend-stock { 
            background: #ff6b6b; 
        }
        .legend-market { 
            background: #51cf66; 
        }
        .chart-loading { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100%; 
            color: #a8b5ca; 
            font-size: 1.0rem; /* æ¸›å°å­—é«” */
        }
        .chart-loading .loading-spinner { 
            margin-right: 8px; /* æ¸›å°‘å³é‚Šè· */
        }
        .professional-analysis-btn { 
            margin-top: 15px; /* æ¸›å°‘ä¸Šé‚Šè· */
            margin-bottom: 15px; /* æ¸›å°‘ä¸‹é‚Šè· */
            width: auto; 
            max-width: 280px; /* æ¸›å°æœ€å¤§å¯¬åº¦ */
            padding: 10px 16px; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(135deg, #4a536d 0%, #3a435d 100%); 
            color: #e8edf3; 
            border: 1px solid rgba(212, 185, 122, 0.3); 
            border-radius: 10px; 
            font-size: 0.95rem; /* æ¸›å°å­—é«” */
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px; /* æ¸›å°‘é–“è· */
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
            /* ä¿®æ”¹ï¼šç¢ºä¿æŒ‰éˆ•é»˜èªé¡¯ç¤º */
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        .professional-analysis-btn.hidden { 
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        .professional-analysis-btn:hover { 
            background: linear-gradient(135deg, #5a637d 0%, #4a536d 100%); 
            border-color: #d4b97a; 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(212, 185, 122, 0.2); 
        }
        .professional-analysis-btn .toggle-icon { 
            transition: transform 0.3s ease; 
            font-size: 0.8rem; /* æ¸›å°å­—é«” */
        }
        .professional-analysis-btn.expanded .toggle-icon { 
            transform: rotate(90deg); 
        }
        .professional-analysis-table { 
            display: none; 
            margin-top: 15px; /* æ¸›å°‘ä¸Šé‚Šè· */
            padding: 20px; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(135deg, rgba(212, 185, 122, 0.08) 0%, rgba(42, 50, 79, 0.2) 100%); 
            border-radius: 14px; 
            border: 1px solid rgba(212, 185, 122, 0.15); 
            animation: fadeIn 0.5s ease-out; 
        }
        .professional-analysis-table.show { 
            display: block; 
        }
        .professional-analysis-table h5 { 
            color: #d4b97a; 
            margin-bottom: 12px; /* æ¸›å°‘ä¸‹é‚Šè· */
            font-size: 1.1rem; /* æ¸›å°å­—é«” */
            font-weight: 600; 
            text-align: center; 
        }
        .analysis-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 8px; /* æ¸›å°‘ä¸Šé‚Šè· */
            font-size: 0.85rem; /* æ¸›å°å­—é«” */
        }
        .analysis-table th { 
            background: linear-gradient(135deg, rgba(212, 185, 122, 0.2) 0%, rgba(42, 50, 79, 0.3) 100%); 
            color: #d4b97a; 
            font-weight: 600; 
            padding: 10px 8px; /* æ¸›å°‘å…§é‚Šè· */
            text-align: center; 
            border: 1px solid rgba(212, 185, 122, 0.2); 
        }
        .analysis-table td { 
            padding: 8px; /* æ¸›å°‘å…§é‚Šè· */
            text-align: center; 
            border: 1px solid rgba(212, 185, 122, 0.1); 
            color: #e8edf3; 
            line-height: 1.4; /* æ¸›å°‘è¡Œé«˜ */
        }
        .analysis-table tr:nth-child(even) { 
            background: rgba(33, 39, 63, 0.4); 
        }
        .analysis-table tr:nth-child(odd) { 
            background: rgba(42, 50, 79, 0.4); 
        }
        .analysis-table tr:hover { 
            background: rgba(212, 185, 122, 0.1); 
        }
        .analysis-table .situation-1 td:first-child { 
            color: #51cf66; 
            font-weight: bold; 
        }
        .analysis-table .situation-2 td:first-child { 
            color: #a8b5ca; 
            font-weight: bold; 
        }
        .analysis-table .situation-3 td:first-child { 
            color: #ffd43b; 
            font-weight: bold; 
        }
        .analysis-table .situation-4 td:first-child { 
            color: #ff6b6b; 
            font-weight: bold; 
        }
        .market-calendar-section { 
            margin-bottom: 20px; /* æ¸›å°‘ä¸‹é‚Šè· */
            padding: 20px; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(135deg, rgba(42, 50, 79, 0.7) 0%, rgba(33, 39, 63, 0.9) 100%); 
            border-radius: 14px; 
            border: 1px solid rgba(212, 185, 122, 0.2); 
            display: none; 
        }
        .market-calendar-section.show { 
            display: block; 
        }
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; /* æ¸›å°‘ä¸‹é‚Šè· */
            padding-bottom: 12px; /* æ¸›å°‘å…§é‚Šè· */
            border-bottom: 1px solid rgba(212, 185, 122, 0.2); 
        }
        .calendar-header h4 { 
            color: #d4b97a; 
            font-size: 1.2rem; /* æ¸›å°å­—é«” */
            margin: 0; 
        }
        .calendar-nav { 
            display: flex; 
            gap: 8px; /* æ¸›å°‘é–“è· */
        }
        .calendar-nav-btn { 
            padding: 6px 12px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(212, 185, 122, 0.1); 
            border: 1px solid rgba(212, 185, 122, 0.2); 
            border-radius: 8px; 
            color: #e8edf3; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
        }
        .calendar-nav-btn:hover { 
            background: rgba(212, 185, 122, 0.2); 
            border-color: #d4b97a; 
        }
        .calendar-nav-btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        .calendar-container { 
            overflow-x: auto; 
            margin-bottom: 12px; /* æ¸›å°‘ä¸‹é‚Šè· */
            -webkit-overflow-scrolling: touch; /* iOSæ»¾å‹•å„ªåŒ– */
        }
        .calendar-table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 600px; /* æ¸›å°æœ€å°å¯¬åº¦ */
        }
        .calendar-table th { 
            padding: 10px 6px; /* æ¸›å°‘å…§é‚Šè· */
            text-align: center; 
            background: rgba(33, 39, 63, 0.8); 
            color: #d4b97a; 
            font-weight: 600; 
            border: 1px solid rgba(212, 185, 122, 0.1); 
            font-size: 0.9rem; /* æ¸›å°å­—é«” */
        }
        .calendar-table td { 
            padding: 10px 6px; /* æ¸›å°‘å…§é‚Šè· */
            text-align: center; 
            border: 1px solid rgba(212, 185, 122, 0.1); 
            min-height: 70px; /* æ¸›å°æœ€å°é«˜åº¦ */
            vertical-align: top; 
            position: relative; 
            font-size: 0.85rem; /* æ¸›å°å­—é«” */
        }
        .calendar-date { 
            position: absolute; 
            top: 4px; /* èª¿æ•´ä½ç½® */
            right: 4px; /* èª¿æ•´ä½ç½® */
            font-size: 0.8rem; /* æ¸›å°å­—é«” */
            color: #a8b5ca; 
        }
        .calendar-data { 
            margin-top: 20px; /* æ¸›å°‘ä¸Šé‚Šè· */
            display: flex; 
            flex-direction: column; 
            gap: 4px; /* æ¸›å°‘é–“è· */
            align-items: center; 
        }
        .data-item { 
            display: flex; 
            align-items: center; 
            gap: 5px; /* æ¸›å°‘é–“è· */
            padding: 3px 6px; /* æ¸›å°‘å…§é‚Šè· */
            border-radius: 6px; 
            font-size: 0.75rem; /* æ¸›å°å­—é«” */
            width: 100%; 
            justify-content: center; 
        }
        .data-item.stock { 
            background: rgba(255, 107, 107, 0.15); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3); 
        }
        .data-item.market { 
            background: rgba(81, 207, 102, 0.15); 
            color: #51cf66; 
            border: 1px solid rgba(81, 207, 102, 0.3); 
        }
        .data-item.no-data { 
            background: rgba(168, 181, 202, 0.1); 
            color: #a8b5ca; 
            font-style: italic; 
            border: 1px dashed rgba(168, 181, 202, 0.3); 
        }
        .data-item.weekend { 
            background: rgba(42, 50, 79, 0.5); 
            color: #8a94b3; 
            font-style: italic; 
        }
        .data-icon { 
            font-size: 0.7rem; /* æ¸›å°åœ–æ¨™å¤§å° */
        }
        .data-value { 
            font-weight: 600; 
        }
        .calendar-day.holiday { 
            background: rgba(42, 50, 79, 0.3); 
        }
        .calendar-day.weekend { 
            background: rgba(33, 39, 63, 0.4); 
        }
        .calendar-day.trading-day { 
            background: rgba(42, 50, 79, 0.2); 
        }
        .calendar-day.trading-day:hover { 
            background: rgba(42, 50, 79, 0.4); 
            cursor: pointer; 
        }
        .calendar-day.selected { 
            background: rgba(212, 185, 122, 0.15); 
            border: 2px solid rgba(212, 185, 122, 0.4); 
        }
        .calendar-legend { 
            display: flex; 
            justify-content: center; 
            gap: 15px; /* æ¸›å°‘é–“è· */
            margin-top: 12px; /* æ¸›å°‘ä¸Šé‚Šè· */
            flex-wrap: wrap; 
        }
        .legend-item-calendar { 
            display: flex; 
            align-items: center; 
            gap: 6px; /* æ¸›å°‘é–“è· */
            font-size: 0.75rem; /* æ¸›å°å­—é«” */
        }
        .legend-color-calendar { 
            width: 10px; /* æ¸›å°å¤§å° */
            height: 10px; /* æ¸›å°å¤§å° */
            border-radius: 3px; 
        }
        .legend-stock-calendar { 
            background: rgba(255, 107, 107, 0.3); 
            border: 1px solid rgba(255, 107, 107, 0.5); 
        }
        .legend-market-calendar { 
            background: rgba(81, 207, 102, 0.3); 
            border: 1px solid rgba(81, 207, 102, 0.5); 
        }
        .legend-weekend-calendar { 
            background: rgba(33, 39, 63, 0.4); 
            border: 1px solid rgba(168, 181, 202, 0.3); 
        }
        .calendar-stats { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 12px; /* æ¸›å°‘ä¸Šé‚Šè· */
            padding: 12px; /* æ¸›å°‘å…§é‚Šè· */
            background: rgba(33, 39, 63, 0.5); 
            border-radius: 10px; 
            font-size: 0.8rem; /* æ¸›å°å­—é«” */
        }
        .stat-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; /* æ¸›å°‘é–“è· */
        }
        .stat-value { 
            font-size: 1.1rem; /* æ¸›å°å­—é«” */
            font-weight: bold; 
            color: #d4b97a; 
        }
        .stat-label { 
            color: #a8b5ca; 
        }
        .date-range-display { 
            text-align: center; 
            margin-bottom: 12px; /* æ¸›å°‘ä¸‹é‚Šè· */
            color: #d4b97a; 
            font-size: 1.0rem; /* æ¸›å°å­—é«” */
            font-weight: 600; 
        }
        .chart-controls { 
            display: flex; 
            gap: 12px; /* æ¸›å°‘é–“è· */
            margin-bottom: 15px; /* æ¸›å°‘ä¸‹é‚Šè· */
        }
        .chart-control-btn { 
            padding: 10px 16px; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(135deg, #4a536d 0%, #3a435d 100%); 
            border: 1px solid rgba(212, 185, 122, 0.3); 
            border-radius: 8px; 
            color: #e8edf3; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            min-width: 110px; /* æ¸›å°æœ€å°å¯¬åº¦ */
            text-align: center; 
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
        }
        .chart-control-btn:hover { 
            background: linear-gradient(135deg, #5a637d 0%, #4a536d 100%); 
            border-color: #d4b97a; 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(212, 185, 122, 0.2); 
        }
        .chart-control-btn.active { 
            background: linear-gradient(135deg, #d4b97a 0%, #b89c5e 100%); 
            color: #1a1f35; 
            border-color: #d4b97a; 
        }
        .analysis-controls { 
            display: flex; 
            gap: 8px; /* æ¸›å°‘é–“è· */
            margin-bottom: 12px; /* æ¸›å°‘ä¸‹é‚Šè· */
        }
        .analysis-select { 
            padding: 6px 10px; /* æ¸›å°‘å…§é‚Šè· */
            border: 1px solid rgba(212, 185, 122, 0.3); 
            border-radius: 6px; 
            background: rgba(33, 39, 63, 0.7); 
            color: #e8edf3; 
            font-size: 0.85rem; /* æ¸›å°å­—é«” */
            min-width: 90px; /* æ¸›å°æœ€å°å¯¬åº¦ */
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
        }
        .analysis-select:focus { 
            outline: none; 
            border-color: #d4b97a; 
        }
        .select-all-btn.active { 
            background: linear-gradient(135deg, #38a169 0%, #2d8f5c 100%); 
            color: white; 
        }
        
        /* ä¿®æ”¹ï¼šæµ®å‹•è¦–çª—è‡ªé©æ‡‰å¤§å° - æ”¹é€²ç‰ˆæœ¬ */
        #realTimeDataDisplay { 
            position: fixed !important; 
            background: rgba(33, 39, 63, 0.98) !important; 
            border: 2px solid rgba(212, 185, 122, 0.8) !important; 
            border-radius: 10px !important; 
            padding: 12px 15px !important; 
            color: #e8edf3 !important; 
            font-size: 0.85rem !important;
            pointer-events: none !important; 
            z-index: 10000 !important; 
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6) !important; 
            backdrop-filter: blur(15px) !important; 
            width: auto !important;  /* æ”¹ç‚ºè‡ªå‹•å¯¬åº¦ */
            max-width: 300px !important;  /* æ¡Œé¢é»˜èªæœ€å¤§å¯¬åº¦ */
            min-width: 200px !important;  /* æœ€å°å¯¬åº¦ */
            display: none !important; 
            transition: opacity 0.3s ease, transform 0.3s ease !important; 
            opacity: 0.95 !important;
            visibility: hidden !important;
            overflow: visible !important;
            transform-origin: top left !important;
            /* ä½¿ç”¨å½ˆæ€§ä½ˆå±€è‡ªå‹•èª¿æ•´ */
            flex-direction: column !important;
            box-sizing: border-box !important;
        }
        
        /* ç¢ºä¿æµ®å‹•è¦–çª—é¡¯ç¤ºæ™‚æœ‰æ­£ç¢ºçš„å±¬æ€§ */
        #realTimeDataDisplay.show {
            display: flex !important;
            visibility: visible !important;
        }
        
        #realTimeDataDisplay .info-header { 
            display: flex !important; 
            justify-content: space-between !important; 
            align-items: center !important; 
            margin-bottom: 8px !important;  /* æ¸›å°‘ä¸‹é‚Šè· */
            padding-bottom: 6px !important;  /* æ¸›å°‘å…§é‚Šè· */
            border-bottom: 2px solid rgba(212, 185, 122, 0.5) !important; 
            flex-shrink: 0 !important;
        }
        
        #realTimeDataDisplay .info-date { 
            color: #d4b97a !important; 
            font-weight: bold !important; 
            font-size: 0.95rem !important; 
            line-height: 1.2 !important;
        }
        
        #realTimeDataDisplay .info-index { 
            color: #a8b5ca !important; 
            font-size: 0.8rem !important; 
            line-height: 1.2 !important;
        }
        
        #realTimeDataDisplay .info-body { 
            margin: 10px 0 !important; /* æ¸›å°‘é‚Šè· */
            flex-grow: 1 !important;
            overflow: visible !important;  /* æ”¹ç‚ºvisibleï¼Œç„¡æ»¾å‹•æ¢ */
            max-height: none !important;  /* ç§»é™¤é«˜åº¦é™åˆ¶ */
            padding-right: 5px !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        #realTimeDataDisplay .info-row { 
            display: flex !important; 
            justify-content: space-between !important; 
            align-items: center !important; 
            margin: 6px 0 !important; /* æ¸›å°‘é‚Šè· */
            padding: 5px 0 !important; /* æ¸›å°‘å…§é‚Šè· */
            border-bottom: 1px solid rgba(255, 255, 255, 0.15) !important; 
            min-height: 22px !important; /* æ¸›å°æœ€å°é«˜åº¦ */
        }
        
        #realTimeDataDisplay .info-label { 
            color: #a8b5ca !important; 
            font-size: 0.85rem !important; 
            display: flex !important; 
            align-items: center !important; 
            gap: 5px !important; /* æ¸›å°‘é–“è· */
            white-space: nowrap !important;
            flex-shrink: 0 !important;
        }
        
        #realTimeDataDisplay .color-dot { 
            width: 8px !important; 
            height: 8px !important; 
            border-radius: 50% !important; 
            display: inline-block !important; 
            flex-shrink: 0 !important;
        }
        
        #realTimeDataDisplay .info-value { 
            color: #e8edf3 !important; 
            font-weight: bold !important; 
            font-size: 0.9rem !important; 
            text-align: right !important;
            max-width: 60% !important;
            word-break: break-word !important;
            flex-shrink: 1 !important;
            white-space: nowrap !important;
        }
        
        #realTimeDataDisplay .info-divider { 
            height: 2px !important;
            background: rgba(255, 255, 255, 0.2) !important; 
            margin: 10px 0 !important; /* æ¸›å°‘é‚Šè· */
            flex-shrink: 0 !important;
        }
        
        #realTimeDataDisplay .info-footer { 
            margin-top: 8px !important;  /* æ¸›å°‘ä¸Šé‚Šè· */
            font-size: 0.75rem !important; 
            color: #8a94b3 !important; 
            text-align: center !important; 
            padding-top: 6px !important;  /* æ¸›å°‘å…§é‚Šè· */
            border-top: 1px solid rgba(255, 255, 255, 0.1) !important; 
            flex-shrink: 0 !important;
        }
        
        /* ä¿®æ”¹ï¼šè‚¡ç¥¨åç¨±é¡¯ç¤ºæ¨£å¼ */
        #realTimeDataDisplay .stock-name-header {
            font-size: 1.0rem !important; 
            color: #ff6b6b !important;
            font-weight: bold !important;
            margin-bottom: 8px !important; /* æ¸›å°‘ä¸‹é‚Šè· */
            text-align: center !important;
            border-bottom: 2px solid rgba(255, 107, 107, 0.4) !important;
            padding-bottom: 5px !important; /* æ¸›å°‘å…§é‚Šè· */
            background: linear-gradient(90deg, rgba(255, 107, 107, 0.1), rgba(212, 185, 122, 0.1), rgba(255, 107, 107, 0.1)) !important;
            border-radius: 6px !important;
            padding: 6px !important; /* æ¸›å°‘å…§é‚Šè· */
            flex-shrink: 0 !important;
        }
        
        #realTimeDataDisplay .stock-price-display {
            font-size: 1.1rem !important; 
            font-weight: bold !important;
            color: #ffffff !important;
            margin: 3px 0 !important; /* æ¸›å°‘é‚Šè· */
            background: rgba(255, 107, 107, 0.1) !important;
            padding: 5px 6px !important; /* æ¸›å°‘å…§é‚Šè· */
            border-radius: 6px !important;
            border: 1px solid rgba(255, 107, 107, 0.3) !important;
            text-align: center !important;
            flex-shrink: 0 !important;
        }
        
        #realTimeDataDisplay .market-index-display {
            font-size: 1.1rem !important; 
            font-weight: bold !important;
            color: #ffffff !important;
            margin: 3px 0 !important; /* æ¸›å°‘é‚Šè· */
            background: rgba(81, 207, 102, 0.1) !important;
            padding: 5px 6px !important; /* æ¸›å°‘å…§é‚Šè· */
            border-radius: 6px !important;
            border: 1px solid rgba(81, 207, 102, 0.3) !important;
            text-align: center !important;
            flex-shrink: 0 !important;
        }
        
        /* ä¿®æ”¹ï¼šä¸Šæ¼²ç‚ºç´…è‰²ï¼Œä¸‹è·Œç‚ºç¶ è‰² */
        #realTimeDataDisplay .change-display {
            font-size: 0.85rem !important; 
            margin-left: 5px !important; /* æ¸›å°‘å·¦é‚Šè· */
            padding: 2px 4px !important; /* æ¸›å°‘å…§é‚Šè· */
            border-radius: 4px !important;
            white-space: nowrap !important;
        }
        
        #realTimeDataDisplay .change-positive {
            background-color: rgba(255, 107, 107, 0.25) !important;
            color: #ff6b6b !important;
            border: 1px solid rgba(255, 107, 107, 0.5) !important;
        }
        
        #realTimeDataDisplay .change-negative {
            background-color: rgba(81, 207, 102, 0.25) !important;
            color: #51cf66 !important;
            border: 1px solid rgba(81, 207, 102, 0.5) !important;
        }
        
        /* æ–°å¢ï¼šæ™ºèƒ½ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .autocomplete-wrapper {
            position: relative;
            flex: 1;
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(33, 39, 63, 0.95);
            border: 1px solid rgba(212, 185, 122, 0.3);
            border-radius: 0 0 10px 10px;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .autocomplete-list.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            color: #e8edf3;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .autocomplete-item:hover {
            background: rgba(212, 185, 122, 0.1);
        }
        
        .autocomplete-item.active {
            background: rgba(212, 185, 122, 0.2);
        }
        
        .autocomplete-item .stock-code {
            color: #d4b97a;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .autocomplete-item .stock-name {
            flex: 1;
            margin-left: 10px;
            font-size: 0.95rem;
        }
        
        .autocomplete-item .stock-type {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(42, 50, 79, 0.6);
            color: #a8b5ca;
        }
        
        .autocomplete-item .stock-type.twse {
            background: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
        }
        
        .autocomplete-item .stock-type.tpex {
            background: rgba(81, 207, 102, 0.15);
            color: #51cf66;
        }
        
        .autocomplete-item .stock-type.emerging {
            background: rgba(255, 212, 59, 0.15);
            color: #ffd43b;
        }
        
        .autocomplete-info {
            font-size: 0.85rem;
            color: #a8b5ca;
            padding: 8px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(42, 50, 79, 0.5);
        }
        
        /* å¹³æ¿è¨­å‚™ */
        @media (max-width: 1024px) {
            .container {
                margin: 12px auto;
                padding: 18px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .chart-wrapper {
                height: 300px;
            }
            
            .professional-analysis-btn {
                max-width: 100%;
            }
            
            #realTimeDataDisplay {
                max-width: 280px !important;
                font-size: 0.8rem !important;
                padding: 10px 12px !important;
            }
            
            #realTimeDataDisplay .info-date { 
                font-size: 0.95rem !important; 
            }
            
            #realTimeDataDisplay .info-value { 
                font-size: 0.95rem !important; 
            }
            
            #realTimeDataDisplay .stock-name-header {
                font-size: 1.0rem !important;
            }
            
            #realTimeDataDisplay .stock-price-display,
            #realTimeDataDisplay .market-index-display {
                font-size: 1.1rem !important;
            }
        }
        
        @media (max-width: 768px) {
            .container { 
                margin: 10px; 
                padding: 15px; 
                border-radius: 15px;
            }
            
            h1 { 
                font-size: 1.6rem; 
                margin-bottom: 12px;
                padding-bottom: 8px;
            }
            
            h2 { 
                font-size: 1.2rem; 
                margin-top: 25px;
                margin-bottom: 12px;
            }
            
            .row, .api-key-row, .query-input-row { 
                flex-direction: column; 
                gap: 12px; 
            }
            
            .api-verify-btn, .query-submit-btn { 
                width: 100%; 
            }
            
            .company-type-options { 
                flex-direction: column; 
            }
            
            .company-type-btn { 
                width: 100%; 
            }
            
            .indicator-toggle, .indicator-note { 
                width: 100%; 
            }
            
            .chart-wrapper { 
                height: 250px; 
            }
            
            .professional-analysis-btn { 
                width: 100%; 
                max-width: 100%; 
            }
            
            .analysis-table { 
                font-size: 0.8rem; 
            }
            
            .analysis-table th, .analysis-table td { 
                padding: 6px 4px; 
            }
            
            .calendar-header { 
                flex-direction: column; 
                gap: 12px; 
                align-items: stretch; 
            }
            
            .calendar-nav { 
                justify-content: center; 
            }
            
            .calendar-stats { 
                flex-direction: column; 
                gap: 12px; 
            }
            
            .calendar-table th, .calendar-table td { 
                padding: 6px 3px; 
                font-size: 0.8rem; 
            }
            
            .data-item { 
                font-size: 0.7rem; 
                padding: 2px 3px; 
            }
            
            .chart-controls { 
                flex-direction: column; 
            }
            
            .analysis-controls { 
                flex-direction: column; 
            }
            
            /* å¹³æ¿è¨­å‚™è‡ªé©æ‡‰ */
            #realTimeDataDisplay { 
                max-width: 250px !important; 
                font-size: 0.75rem !important; 
                padding: 8px 10px !important;
            }
            
            #realTimeDataDisplay .info-header {
                margin-bottom: 6px !important;
                padding-bottom: 4px !important;
            }
            
            #realTimeDataDisplay .info-date { 
                font-size: 0.9rem !important; 
            }
            
            #realTimeDataDisplay .info-index {
                font-size: 0.75rem !important;
            }
            
            #realTimeDataDisplay .info-value { 
                font-size: 0.9rem !important; 
                max-width: 55% !important; /* æ¸›å°‘å³å´å¯¬åº¦ */
            }
            
            #realTimeDataDisplay .info-label {
                font-size: 0.8rem !important;
                max-width: 45% !important; /* å¢åŠ å·¦å´å¯¬åº¦ */
            }
            
            #realTimeDataDisplay .stock-name-header { 
                font-size: 0.9rem !important; 
                margin-bottom: 6px !important;
                padding: 5px !important;
            }
            
            #realTimeDataDisplay .stock-price-display,
            #realTimeDataDisplay .market-index-display { 
                font-size: 1.0rem !important; 
                padding: 4px 5px !important;
                margin: 2px 0 !important;
            }
            
            #realTimeDataDisplay .info-row {
                margin: 4px 0 !important;
                padding: 3px 0 !important;
                min-height: 20px !important;
            }
            
            #realTimeDataDisplay .color-dot {
                width: 6px !important;
                height: 6px !important;
            }
            
            #realTimeDataDisplay .info-divider {
                margin: 8px 0 !important;
            }
            
            #realTimeDataDisplay .change-display {
                font-size: 0.7rem !important;
                margin-left: 3px !important;
                padding: 1px 3px !important;
            }
            
            #realTimeDataDisplay .info-footer {
                font-size: 0.7rem !important;
                margin-top: 6px !important;
                padding-top: 4px !important;
            }
        }
        
        @media (max-width: 480px) {
            .container { 
                margin: 8px; 
                padding: 12px; 
                border-radius: 12px;
            }
            
            h1 { 
                font-size: 1.4rem; 
                margin-bottom: 10px;
                padding-bottom: 6px;
            }
            
            h2 { 
                font-size: 1.1rem; 
                margin-top: 20px;
                margin-bottom: 10px;
            }
            
            .chart-wrapper { 
                height: 200px; 
            }
            
            .analysis-table { 
                font-size: 0.75rem; 
            }
            
            .analysis-table th, .analysis-table td { 
                padding: 5px 3px; 
            }
            
            .calendar-table { 
                min-width: 450px; 
            }
            
            .calendar-table th, .calendar-table td { 
                padding: 5px 2px; 
                font-size: 0.75rem; 
            }
            
            .data-item { 
                font-size: 0.65rem; 
                padding: 2px 3px; 
            }
            
            /* æ‰‹æ©Ÿè¨­å‚™è‡ªé©æ‡‰ */
            #realTimeDataDisplay { 
                max-width: 220px !important; 
                font-size: 0.7rem !important; 
                padding: 6px 8px !important;
            }
            
            #realTimeDataDisplay .info-date { 
                font-size: 0.85rem !important; 
            }
            
            #realTimeDataDisplay .info-index {
                font-size: 0.7rem !important;
            }
            
            #realTimeDataDisplay .info-value { 
                font-size: 0.85rem !important; 
                max-width: 50% !important;
            }
            
            #realTimeDataDisplay .info-label {
                font-size: 0.75rem !important;
                max-width: 50% !important;
            }
            
            #realTimeDataDisplay .stock-name-header { 
                font-size: 0.85rem !important; 
                margin-bottom: 4px !important;
                padding: 4px !important;
            }
            
            #realTimeDataDisplay .stock-price-display,
            #realTimeDataDisplay .market-index-display { 
                font-size: 0.95rem !important; 
                padding: 3px 4px !important;
                margin: 1px 0 !important;
            }
            
            #realTimeDataDisplay .info-row {
                margin: 3px 0 !important;
                padding: 2px 0 !important;
                min-height: 18px !important;
            }
            
            #realTimeDataDisplay .info-divider {
                margin: 6px 0 !important;
                height: 1px !important;
            }
            
            /* é‡å°å°å±å¹•å„ªåŒ–æŒ‰éˆ• */
            button, .btn, input[type="button"] {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            /* å„ªåŒ–è¼¸å…¥æ¡†åœ¨å°å±å¹•ä¸Šçš„é¡¯ç¤º */
            input, select, textarea {
                font-size: 16px; /* é˜²æ­¢iOSç¸®æ”¾ */
                padding: 10px 12px;
            }
        }
        
        @media (max-width: 360px) {
            h1 {
                font-size: 1.2rem;
            }
            
            h2 {
                font-size: 1.0rem;
            }
            
            .chart-wrapper {
                height: 180px;
            }
            
            #realTimeDataDisplay {
                max-width: 200px !important;
                font-size: 0.65rem !important;
                padding: 5px 6px !important;
            }
            
            #realTimeDataDisplay .info-date { 
                font-size: 0.8rem !important; 
            }
            
            #realTimeDataDisplay .info-index {
                font-size: 0.65rem !important;
            }
            
            #realTimeDataDisplay .info-value { 
                font-size: 0.8rem !important; 
            }
            
            #realTimeDataDisplay .info-label {
                font-size: 0.7rem !important;
            }
            
            #realTimeDataDisplay .stock-name-header { 
                font-size: 0.8rem !important; 
            }
            
            #realTimeDataDisplay .stock-price-display,
            #realTimeDataDisplay .market-index-display { 
                font-size: 0.9rem !important; 
            }
            
            .company-type-btn {
                font-size: 0.9rem;
                padding: 10px;
            }
        }
        
        /* æ©«å±å„ªåŒ– */
        @media (orientation: landscape) and (max-height: 500px) {
            .container {
                padding: 10px;
                margin: 8px auto;
            }
            
            h1 {
                font-size: 1.4rem;
                margin-bottom: 8px;
            }
            
            h2 {
                font-size: 1.1rem;
                margin-top: 15px;
                margin-bottom: 8px;
            }
            
            .chart-wrapper {
                height: 180px;
            }
            
            .form-group {
                margin-bottom: 12px;
            }
            
            .button-group {
                margin-top: 10px;
            }
            
            /* æ©«å±æ™‚æµ®å‹•è¦–çª—å„ªåŒ– */
            #realTimeDataDisplay {
                max-width: 250px !important;
                font-size: 0.7rem !important;
                padding: 6px 8px !important;
            }
            
            #realTimeDataDisplay .stock-name-header {
                font-size: 0.85rem !important;
            }
            
            /* åœ¨æ©«å±æ™‚æ¸›å°‘è¡Œé–“è· */
            #realTimeDataDisplay .info-row {
                margin: 2px 0 !important;
                padding: 1px 0 !important;
            }
        }
        
        ::-webkit-scrollbar { 
            width: 8px; /* æ¸›å°æ»¾å‹•æ¢å¯¬åº¦ */
        }
        
        ::-webkit-scrollbar-track { 
            background: rgba(42, 50, 79, 0.4); 
            border-radius: 4px; 
        }
        
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, #d4b97a, #b89c5e); 
            border-radius: 4px; 
        }
        
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, #e8d09d, #d4b97a); 
        }
        
        /* è§¸æ§å„ªåŒ– */
        * {
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šé«˜äº® */
            -webkit-touch-callout: none; /* ç¦æ­¢é•·æŒ‰èœå–® */
        }
        
        /* ç¢ºä¿è§¸æ§å…ƒç´ æœ‰è¶³å¤ çš„é»æ“Šå€åŸŸ */
        button, 
        input[type="button"], 
        input[type="submit"], 
        select,
        .company-type-btn,
        .indicator-toggle,
        .chart-control-btn,
        .calendar-nav-btn,
        .professional-analysis-btn {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* å„ªåŒ–è§¸æ§åé¥‹ */
        button:active,
        .company-type-btn:active,
        .chart-control-btn:active,
        .calendar-nav-btn:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>å°ç£è‚¡ç¥¨AIå°ˆæ¥­åŠ©ç† V5.0</h1>
        <div class="section-note">æ­¤å·¥å…·ä½¿ç”¨äººå·¥æ™ºèƒ½ç®—æ³•ä»¥åŠå°ˆæ¥­åˆ¤æ–·å·¥å…·åˆ†æã€‚<br>æ”¯æŒ:ä¸Šå¸‚å…¬å¸(TWSE)ã€ä¸Šæ«ƒå…¬å¸(TPEx/OTC)ã€èˆˆæ«ƒå…¬å¸ã€‚</div>
        <form id="stockForm">
            <h2>ä¸€ã€å…¬å¸é¡å‹</h2>
            <div class="company-type-section">
                <div class="company-type-options">
                    <button type="button" class="company-type-btn" data-type="twse">ä¸Šå¸‚å…¬å¸</button>
                    <button type="button" class="company-type-btn" data-type="tpex">ä¸Šæ«ƒå…¬å¸</button>
                    <button type="button" class="company-type-btn" data-type="emerging">èˆˆæ«ƒå…¬å¸</button>
                    <button type="button" class="company-type-btn" data-type="auto">è‡ªå‹•æª¢æ¸¬</button>
                </div>
                <p class="note">èªªæ˜:é¸æ“‡å…¬å¸é¡å‹å¾Œ,ç³»çµ±æœƒé¡¯ç¤ºç›¸æ‡‰çš„è‚¡ç¥¨é¸é …ã€‚é¸æ“‡"è‡ªå‹•æª¢æ¸¬"å¯è®“ç³»çµ±æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼è‡ªå‹•åˆ¤æ–·ã€‚</p>
            </div>
            <h2>äºŒã€é¸æ“‡è‚¡ç¥¨</h2>
            <div class="form-group">
                <label for="manualInput">ç›´æ¥è¼¸å…¥ä»£ç¢¼æˆ–åç¨±</label>
                <div class="row">
                    <div class="autocomplete-wrapper">
                        <input type="text" id="manualInput" name="manualInput" placeholder="ä¾‹å¦‚:2330 æˆ– å°ç©é›»">
                        <div class="autocomplete-list" id="autocompleteList"></div>
                    </div>
                    <button type="button" id="manualSearchBtn">æœå°‹è‚¡ç¥¨</button>
                </div>
                <p class="note">èªªæ˜:è¼¸å…¥ä»£ç¢¼æˆ–åç¨±é—œéµå­—å¾Œé»æ“Šæœå°‹,ç³»çµ±å°‡è‡ªå‹•å¡«å…¥å°æ‡‰è³‡æ–™ã€‚</p>
            </div>
            <div class="form-group" id="industryGroup">
                <label for="industry">é¸æ“‡é¡è‚¡(åƒ…ä¸Šå¸‚å…¬å¸å¯ç”¨)</label>
                <select id="industry">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>
                <p class="note" id="industryNote">èªªæ˜:é¡è‚¡ç¯©é¸åƒ…é©ç”¨æ–¼ä¸Šå¸‚å…¬å¸,ä¸Šæ«ƒ/èˆˆæ«ƒå…¬å¸è«‹ä½¿ç”¨ä¸Šæ–¹æœå°‹åŠŸèƒ½ã€‚</p>
            </div>
            <div class="form-group" id="stockSelectGroup">
                <label for="stockSelect">å¾æ¸…å–®é¸æ“‡</label>
                <select id="stockSelect">
                    <option value="">è«‹å…ˆé¸æ“‡å…¬å¸é¡å‹</option>
                </select>
                <p class="note">èªªæ˜:é¸æ“‡å…¬å¸é¡å‹å¾Œ,æ­¤è™•æœƒé¡¯ç¤ºå°æ‡‰çš„è‚¡ç¥¨æ¸…å–®ã€‚</p>
            </div>
            <div class="hot-stocks">
                <h4>å¿«é€Ÿæœå°‹(ç†±é–€è‚¡ç¥¨)</h4>
                <select id="hotStockSelect">
                    <option value="">-- è«‹é¸æ“‡ç†±é–€è‚¡ç¥¨ --</option>
                </select>
                <p class="note">èªªæ˜:æœ€è¿‘æŸ¥è©¢çš„è‚¡ç¥¨æœƒé¡¯ç¤ºåœ¨æœ€å‰é¢,æ–¹ä¾¿å¿«é€Ÿé¸æ“‡ã€‚</p>
            </div>
            <div class="form-group">
                <label for="stockCode">ç”¨æˆ¶å·²é¸è‚¡ç¥¨åç¨±ä»£ç¢¼</label>
                <div class="selected-stock-display" id="selectedStockDisplay">å°šæœªé¸æ“‡è‚¡ç¥¨</div>
                <input type="text" id="stockCode" name="stockCode" placeholder="é¸æ“‡è‚¡ç¥¨å¾Œè‡ªå‹•å¸¶å…¥,æˆ–æ‰‹å‹•è¼¸å…¥" required style="display: none;">
            </div>
            <h2>ä¸‰ã€æ­·å²è³‡æ–™æŠ“å–</h2>
            <div class="row">
                <div class="form-group">
                    <label for="startDate">é–‹å§‹æ—¥æœŸ(å«)</label>
                    <input id="startDate" type="date" required>
                </div>
                <div class="form-group">
                    <label for="endDate">çµæŸæ—¥æœŸ(å«)</label>
                    <input id="endDate" type="date" required>
                </div>
            </div>
            <div class="button-group">
                <button type="button" id="fetchBtn">æŠ“å–æ­·å²æ”¶ç›¤åƒ¹</button>
                <button type="button" id="clearFetchBtn" class="secondary">æ¸…é™¤</button>
                <button type="button" id="marketCompareBtn" class="success">å¤§ç›¤å°æ¯”åˆ†æ</button>
            </div>
            <div class="notice" id="fetchNote"></div>
            <div class="market-chart-container" id="marketChartContainer">
                <div class="chart-header">
                    <h4>å¤§ç›¤å°æ¯”åˆ†æåœ–è¡¨</h4>
                    <div class="chart-controls">
                        <button type="button" class="chart-control-btn" id="calendarToggleBtn">äº¤æ˜“æ—¥æ›†</button>
                        <button type="button" class="chart-control-btn" id="chartToggleBtn">æ›²ç·šåœ–è¡¨</button>
                    </div>
                </div>
                <div class="market-calendar-section" id="marketCalendarSection">
                    <div class="calendar-header">
                        <h4>äº¤æ˜“æ—¥æ›†è¦–è¦ºåŒ–</h4>
                        <div class="calendar-nav">
                            <button type="button" class="calendar-nav-btn" id="prevMonthBtn">ä¸Šå€‹æœˆ</button>
                            <button type="button" class="calendar-nav-btn" id="nextMonthBtn">ä¸‹å€‹æœˆ</button>
                        </div>
                    </div>
                    <div class="date-range-display" id="dateRangeDisplay">æ­£åœ¨è¼‰å…¥æ—¥æœŸè³‡æ–™...</div>
                    <div class="calendar-container">
                        <table class="calendar-table" id="calendarTable">
                            <thead>
                                <tr>
                                    <th>é€±ä¸€</th>
                                    <th>é€±äºŒ</th>
                                    <th>é€±ä¸‰</th>
                                    <th>é€±å››</th>
                                    <th>é€±äº”</th>
                                </tr>
                            </thead>
                            <tbody id="calendarBody"></tbody>
                        </table>
                    </div>
                    <div class="calendar-stats" id="calendarStats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalDays">0</div>
                            <div class="stat-label">ç¸½å¤©æ•¸</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="tradingDays">0</div>
                            <div class="stat-label">äº¤æ˜“æ—¥</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stockDataDays">0</div>
                            <div class="stat-label">å€‹è‚¡æ•¸æ“š</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="marketDataDays">0</div>
                            <div class="stat-label">å¤§ç›¤æ•¸æ“š</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="selectedDays">0</div>
                            <div class="stat-label">å·²é¸å¤©æ•¸</div>
                        </div>
                    </div>
                    <div class="calendar-legend">
                        <div class="legend-item-calendar">
                            <div class="legend-color-calendar legend-stock-calendar"></div>
                            <span>å€‹è‚¡æ•¸æ“š</span>
                        </div>
                        <div class="legend-item-calendar">
                            <div class="legend-color-calendar legend-market-calendar"></div>
                            <span>å¤§ç›¤æ•¸æ“š</span>
                        </div>
                        <div class="legend-item-calendar">
                            <div class="legend-color-calendar legend-weekend-calendar"></div>
                            <span>é€±æœ«/å‡æ—¥</span>
                        </div>
                    </div>
                </div>
                <div class="chart-wrapper" id="chartWrapper" style="display: none;">
                    <div class="chart-loading" id="chartLoading">
                        <div class="loading-spinner"></div>
                        <span>è«‹é»æ“Š"ç”Ÿæˆå°æ¯”åœ–è¡¨"æŒ‰éˆ•å‰µå»ºåœ–è¡¨</span>
                    </div>
                    <canvas id="marketComparisonChart"></canvas>
                    <div class="chart-vertical-line" id="chartVerticalLine"></div>
                    <div class="chart-data-point stock" id="chartDataPointStock"></div>
                    <div class="chart-data-point market" id="chartDataPointMarket"></div>
                </div>
                <div class="chart-legend" id="chartLegend" style="display: none;">
                    <div class="legend-item">
                        <div class="legend-color legend-stock"></div>
                        <span>å€‹è‚¡èµ°å‹¢</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-market"></div>
                        <span>å¤§ç›¤æŒ‡æ•¸(åŠ æ¬ŠæŒ‡æ•¸)</span>
                    </div>
                </div>
                <button type="button" class="professional-analysis-btn" id="professionalAnalysisBtn">
                    <span class="toggle-icon">â–¶</span>
                    <span>å°ˆæ¥­æŠ•è³‡åˆ†æèªªæ˜</span>
                </button>
                <div class="professional-analysis-table" id="professionalAnalysisTable">
                    <h5>å°ˆæ¥­æŠ•è³‡äººå¼·å¼±åˆ†æèªªæ˜</h5>
                    <div class="analysis-controls">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label style="font-size: 0.9rem; color: #d4b97a;">å€‹è‚¡è¶¨å‹¢</label>
                            <select class="analysis-select" id="stockMovement">
                                <option value="big_up">å¤§æ¼²</option>
                                <option value="medium_up">ä¸­æ¼²</option>
                                <option value="small_up">å°æ¼²</option>
                                <option value="small_down">å°è·Œ</option>
                                <option value="medium_down">ä¸­è·Œ</option>
                                <option value="big_down">å¤§è·Œ</option>
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label style="font-size: 0.9rem; color: #d4b97a;">å¤§ç›¤è¶¨å‹¢</label>
                            <select class="analysis-select" id="marketMovement">
                                <option value="big_up">å¤§æ¼²</option>
                                <option value="medium_up">ä¸­æ¼²</option>
                                <option value="small_up">å°æ¼²</option>
                                <option value="small_down">å°è·Œ</option>
                                <option value="medium_down">ä¸­è·Œ</option>
                                <option value="big_down">å¤§è·Œ</option>
                            </select>
                        </div>
                    </div>
                    <div id="analysisResult" style="margin-top: 20px; padding: 20px; background: rgba(42, 50, 79, 0.6); border-radius: 10px; border-left: 3px solid #d4b97a;">
                        è«‹é¸æ“‡å€‹è‚¡èˆ‡å¤§ç›¤çš„æ¼²è·Œæƒ…æ³
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="historicalPrices">æ­·å²æ”¶ç›¤åƒ¹(ä»¥é€—è™Ÿåˆ†éš”,æœ€å°‘éœ€ 14 å¤©è¨ˆç®— RSI)</label>
                <textarea id="historicalPrices" name="historicalPrices" placeholder="é»æ“Šã€ŒæŠ“å–æ­·å²æ”¶ç›¤åƒ¹ã€è‡ªå‹•å¡«å…¥,æˆ–æ‰‹å‹•è¼¸å…¥,ä¾‹å¦‚:100,102,105,98,110" required></textarea>
                <p class="note">èªªæ˜:æ­·å²æ”¶ç›¤åƒ¹æŒ‰æ™‚é–“é †åº,ç”¨é€—è™Ÿåˆ†éš”ã€‚<strong>å»ºè­°è‡³å°‘ 30 å¤©ä»¥æä¾›è¼ƒé«˜æº–ç¢ºæ€§</strong>(ç³»çµ±è¨­å®š3å€‹æœˆ,ç”¨æˆ¶å¯ä»¥æ‰‹å‹•é¸æ“‡æœŸé–“)ã€‚</p>
            </div>
            <div class="form-group">
                <label for="currentPrice">ç•¶å‰åƒ¹æ ¼</label>
                <input type="number" id="currentPrice" name="currentPrice" step="0.01" placeholder="ä¾‹å¦‚:150.00" required>
            </div>
            <div class="form-group">
                <label for="historicalDays">æ­·å²æ•¸æ“šæœŸé–“(å¤©)</label>
                <input type="number" id="historicalDays" name="historicalDays" placeholder="è‡ªå‹•è¨ˆç®—" readonly>
            </div>
            <div class="row">
                <div class="form-group">
                    <label for="historicalLow">æ­·å²æœ€ä½åƒ¹</label>
                    <input type="number" id="historicalLow" name="historicalLow" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly>
                </div>
                <div class="form-group">
                    <label for="historicalHigh">æ­·å²æœ€é«˜åƒ¹</label>
                    <input type="number" id="historicalHigh" name="historicalHigh" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly>
                </div>
            </div>
            <div class="form-group">
                <label for="historicalAvg">æ­·å²å¹³å‡åƒ¹</label>
                <input type="number" id="historicalAvg" name="historicalAvg" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly>
            </div>
            <h2>å››ã€äº¤æ˜“åƒæ•¸è¨­å®š</h2>
            <div class="form-group">
                <label for="buyPrice">è²·å…¥åƒ¹æ ¼</label>
                <input type="number" id="buyPrice" name="buyPrice" step="0.01" placeholder="ä¾‹å¦‚:130.00(è‹¥æœªè²·å…¥è«‹ç•™ç©º)">
                <p class="note">èªªæ˜:è«‹è¼¸å…¥æ‚¨è²·å…¥æˆ–å¯¦éš›é è²·å…¥çš„åƒ¹æ ¼,ç”¨æ–¼è¨ˆç®—æ­¢æåƒ¹å’Œæœ€ä½³è³£å‡ºåƒ¹ã€‚</p>
            </div>
            <div class="form-group">
                <label for="stopLoss">æ­¢æç™¾åˆ†æ¯”(%)</label>
                <input type="number" id="stopLoss" name="stopLoss" step="0.1" placeholder="ä¾‹å¦‚:5" min="3" max="15" value="5">
                <p class="note">èªªæ˜:å»ºè­°è¨­å®šç‚º 3-15%,æ ¹æ“šå€‹äººé¢¨éšªæ‰¿å—èƒ½åŠ›èª¿æ•´ã€‚</p>
            </div>
            <div class="form-group">
                <label for="profitTarget">ç›ˆåˆ©ç›®æ¨™ç™¾åˆ†æ¯”(%)</label>
                <input type="number" id="profitTarget" name="profitTarget" step="0.1" placeholder="ä¾‹å¦‚:10" min="5" max="50" value="10">
                <p class="note">èªªæ˜:å»ºè­°è¨­å®šç‚º 5-50%,æ ¹æ“šå¸‚å ´æ³¢å‹•æ€§èª¿æ•´ã€‚</p>
            </div>
            <div class="form-group">
                <label for="transactionCost">äº¤æ˜“æˆæœ¬ç™¾åˆ†æ¯”(%)</label>
                <input type="number" id="transactionCost" name="transactionCost" step="0.01" placeholder="ä¾‹å¦‚:0.5" min="0.3" max="1" value="0.5">
                <p class="note">èªªæ˜:å°ç£è‚¡å¸‚äº¤æ˜“æˆæœ¬ç´„ 0.3-0.6%(å«æ‰‹çºŒè²»èˆ‡è­‰äº¤ç¨…)ã€‚</p>
            </div>
            <div class="form-group">
                <label for="slippage">æ»‘é»ç™¾åˆ†æ¯”(%)</label>
                <input type="number" id="slippage" name="slippage" step="0.01" placeholder="ä¾‹å¦‚:0.2" min="0" max="1" value="0.2">
                <p class="note">èªªæ˜:å¯¦éš›æˆäº¤åƒ¹èˆ‡é æœŸåƒ¹æ ¼çš„åå·®,å»ºè­° 0.1-0.5%ã€‚</p>
            </div>
            <div class="form-group">
                <label for="leverage">æ§“æ¡¿å€æ•¸</label>
                <input type="number" id="leverage" name="leverage" step="0.1" placeholder="ä¾‹å¦‚:1(ç„¡æ§“æ¡¿)" min="1" max="3" value="1">
                <p class="note">èªªæ˜:1 è¡¨ç¤ºç„¡æ§“æ¡¿,å°è‚¡èè³‡æœ€é«˜ç´„ 2.5 å€ã€‚<strong>æ§“æ¡¿å¢åŠ é¢¨éšª,è«‹è¬¹æ…ä½¿ç”¨</strong>ã€‚</p>
            </div>
            <div class="form-group">
                <label for="marketTrend">å¸‚å ´è¶¨å‹¢èª¿æ•´(%)</label>
                <input type="number" id="marketTrend" name="marketTrend" step="0.1" placeholder="ä¾‹å¦‚:10(ç‰›å¸‚),-10(ç†Šå¸‚)" min="-30" max="30" value="0">
                <p class="note">èªªæ˜:æ ¹æ“šå¤§ç›¤èµ°å‹¢èª¿æ•´(å¦‚åŠ æ¬ŠæŒ‡æ•¸),æ­£æ•¸ç‚ºç‰›å¸‚,è² æ•¸ç‚ºç†Šå¸‚ã€‚å»ºè­°ç¯„åœ -30% åˆ° +30%ã€‚</p>
                <button type="button" id="aiQueryBtn" style="margin-top: 15px;">AI æŸ¥è©¢å‹•æ…‹æ¶ˆæ¯</button>
                <div class="ai-query-section" id="aiQuerySection" style="display: none;">
                    <div class="ai-platform-select">
                        <label for="aiPlatform">é¸æ“‡ AI å¹³å°</label>
                        <select id="aiPlatform">
                            <option value="">-- è«‹é¸æ“‡ AI å¹³å° --</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="openai">GPT (OpenAI)</option>
                            <option value="claude">Claude (Anthropic)</option>
                            <option value="gemini">Gemini (Google)</option>
                            <option value="grok">Grok (xAI)</option>
                        </select>
                    </div>
                    <div class="api-key-section" id="apiKeySection">
                        <div class="api-key-row">
                            <div class="api-key-input-group">
                                <label for="apiKeyInput">API Key</label>
                                <input type="text" id="apiKeyInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„ API Key (è¼¸å…¥ä¸€æ¬¡å¾Œæœƒè‡ªå‹•å„²å­˜åœ¨æœ¬æ©Ÿ)">
                            </div>
                            <button type="button" class="api-verify-btn success" id="apiVerifyBtn">é€£ç·šé©—è­‰/å„²å­˜</button>
                        </div>
                        <div class="api-key-help">ç²å– API Key: <a href="#" id="apiKeyLink" target="_blank">é»æ“Šé€™è£¡å‰å¾€æ‰€é¸AIå¹³å°å®˜ç¶²</a></div>
                        <div class="api-status" id="apiStatus"></div>
                    </div>
                    <div class="query-section">
                        <div class="query-input-row">
                            <div class="query-input-group">
                                <label for="queryInput">AI æŸ¥è©¢æç¤ºè© (å¯ç·¨è¼¯ä¿®æ”¹)</label>
                                <textarea id="queryInput" placeholder="ç³»çµ±æœƒè‡ªå‹•å¡«å…¥é è¨­æç¤ºè©ï¼Œæ‚¨å¯ä»¥è‡ªè¡Œä¿®æ”¹..." style="min-height: 100px;"></textarea>
                            </div>
                            <button type="button" class="query-submit-btn success" id="querySubmitBtn" disabled>ç¢ºèªæŸ¥è©¢</button>
                        </div>
                        <div class="note">é è¨­æç¤ºè©: "ä½ æ˜¯æˆ‘çš„AIåŠ©ç†ï¼Œåˆ†ææˆ‘é¸æ“‡çš„è‚¡ç¥¨çš„è‚¡åƒ¹è¶¨å‹¢ï¼Œåšå‡ºä¸å°‘æ–¼å…­å€‹é‡é»æ•´ç†ï¼Œä¸¦æŒ‰ç…§-30ï½+30çš„å€é–“åšå‡ºç¸½è©•åˆ†"</div>
                    </div>
                    <div class="ai-response-section" id="aiResponseSection">
                        <h4>AI å›è¦†å ±å‘Š</h4>
                        <div class="ai-response-content" id="aiResponseContent"></div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="expectedWinRate">é æœŸå‹ç‡(%)</label>
                <input type="number" id="expectedWinRate" name="expectedWinRate" step="1" placeholder="ä¾‹å¦‚:50(å¯é¸)" min="20" max="80">
                <p class="note">èªªæ˜:<strong>é¸å¡«</strong>ã€‚å¦‚æœæ‚¨æœ‰å¯¦éš›å›æ¸¬æ•¸æ“š,å¯è¼¸å…¥é æœŸå‹ç‡ã€‚ç•™ç©ºå‰‡ç”±ç³»çµ±æ ¹æ“šæŠ€è¡“æŒ‡æ¨™æ¨ä¼°(ä½†æ¨ä¼°å€¼å¯èƒ½ä¸æº–ç¢º)ã€‚</p>
            </div>
            <div class="form-group">
                <label for="volatility">æ³¢å‹•ç‡(%)</label>
                <input type="number" id="volatility" name="volatility" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly>
                <p class="note">èªªæ˜:æ ¹æ“šæ­·å²æ”¶ç›¤åƒ¹è‡ªå‹•è¨ˆç®—å¹´åŒ–æ³¢å‹•ç‡ã€‚</p>
            </div>
            <div class="form-group">
                <button type="submit">è¨ˆç®—åˆ†æçµæœ</button>
            </div>
        </form>
        <div id="results" class="results">
            <h2>è¨ˆç®—çµæœ</h2>
            <p><strong>è‚¡ç¥¨ä»£ç¢¼:</strong> <span id="resultStockCode"></span></p>
            <p><strong>ç•¶å‰åƒ¹æ ¼:</strong> <span id="resultCurrentPrice"></span></p>
            <p><strong>å¯¦éš›è²·å…¥åƒ¹æ ¼:</strong> <span id="actualBuyPrice"></span></p>
            <div id="dataWarning" style="display: none;" class="alert-box"></div>
            <p><strong>ç¶œåˆè©•åˆ†:</strong> <span id="scoreValue"></span></p>
            <p><strong>æ¨è–¦:</strong> <span id="recommendation" class="recommendation"></span></p>
            <h3 style="margin-top: 25px; margin-bottom: 15px;">æŠ€è¡“æŒ‡æ¨™</h3>
            <p id="rsiWarning" style="display: none;" class="warning">è­¦å‘Š:æ­·å²è³‡æ–™ä¸è¶³ 14 å¤©,RSI è¨ˆç®—å¯èƒ½ä¸æº–ç¢º!</p>
            <p><strong>RSI(ç›¸å°å¼·å¼±æŒ‡æ•¸):</strong> <span id="rsiValue" class="rsi-value"></span></p>
            <div class="indicator-toggle" id="rsiToggle">
                <span class="toggle-icon">â–¶</span>
                <span>RSI æŒ‡æ¨™èªªæ˜</span>
            </div>
            <div class="indicator-note" id="rsiNote">
                <strong>RSI æŒ‡æ¨™èªªæ˜:</strong><br>
                â€¢ RSI < 30(è¶…è³£):è‚¡åƒ¹å¯èƒ½è¢«ä½ä¼°,é©åˆé€¢ä½è²·é€²<br>
                â€¢ RSI 30-40(åè¶…è³£):è‚¡åƒ¹ç›¸å°åä½,å¯ç•™æ„åå½ˆæ©Ÿæœƒ<br>
                â€¢ RSI 40-60(ä¸­æ€§):å¸‚å ´å¤šç©ºåŠ›é‡ç›¸å°å‡è¡¡<br>
                â€¢ RSI 60-70(åè¶…è²·):è‚¡åƒ¹ç›¸å°åé«˜,æ³¨æ„å›èª¿é¢¨éšª<br>
                â€¢ RSI > 70(è¶…è²·):è‚¡åƒ¹å¯èƒ½éé«˜,è¬¹æ…è¿½é«˜æˆ–è€ƒæ…®è³£å‡º
            </div>
            <p id="macdInfo" style="display: none;"><strong>MACD ä¿¡è™Ÿ:</strong> <span id="macdSignal"></span></p>
            <div class="indicator-toggle" id="macdToggle" style="display: none;">
                <span class="toggle-icon">â–¶</span>
                <span>MACD æŒ‡æ¨™èªªæ˜</span>
            </div>
            <div class="indicator-note" id="macdNote">
                <strong>MACD æŒ‡æ¨™èªªæ˜:</strong><br>
                â€¢ é»ƒé‡‘äº¤å‰:çŸ­æœŸè¶¨å‹¢ç”±å¼±è½‰å¼·,å½¢æˆè²·å…¥ä¿¡è™Ÿ,å»ºè­°çµåˆå…¶ä»–æŒ‡æ¨™ç¢ºèª<br>
                â€¢ æ­»äº¡äº¤å‰:çŸ­æœŸè¶¨å‹¢ç”±å¼·è½‰å¼±,å½¢æˆè³£å‡ºä¿¡è™Ÿ,å»ºè­°è€ƒæ…®æ¸›å€‰æˆ–è§€æœ›<br>
                â€¢ å¤šé ­æ ¼å±€(MACD > Signal):çŸ­æœŸè¶¨å‹¢å‘ä¸Š,å¯æŒçºŒæŒæœ‰æˆ–é€¢ä½åŠ ç¢¼<br>
                â€¢ ç©ºé ­æ ¼å±€(MACD < Signal):çŸ­æœŸè¶¨å‹¢å‘ä¸‹,å»ºè­°è§€æœ›æˆ–ç­‰å¾…è¶¨å‹¢åè½‰<br>
                â€¢ ä¸­æ€§:è¶¨å‹¢ä¸æ˜ç¢º,å»ºè­°ç­‰å¾…æ›´æ¸…æ™°çš„ä¿¡è™Ÿ
            </div>
            <h3 style="margin-top: 25px; margin-bottom: 15px;">åƒ¹æ ¼å»ºè­°</h3>
            <div class="price-suggestion-section user-settings">
                <h4>ç”¨æˆ¶è¨­å®šçµæœ</h4>
                <p><strong>ç”¨æˆ¶è²·å…¥åƒ¹:</strong> <span id="customBuyPrice"></span></p>
                <p><strong>ç”¨æˆ¶æ­¢æåƒ¹:</strong> <span id="customStopLossPrice"></span></p>
                <p><strong>ç›ˆåˆ©ç›®æ¨™åƒ¹:</strong> <span id="customSellPrice"></span></p>
            </div>
            <div class="price-suggestion-section ai-suggestions">
                <h4>AI å»ºè­°çµæœ</h4>
                <p><strong>AIå»ºè­°è²·å…¥åƒ¹:</strong> <span id="aiSuggestedBuyPrice"></span></p>
                <p><strong>AIä¼°ç®—ç›ˆåˆ©è³£å‡ºåƒ¹:</strong> <span id="aiSellPrice"></span></p>
                <p><strong>AIå»ºè­°æ­¢æåƒ¹:</strong> <span id="aiStopLossPrice"></span></p>
                <div id="stopLossWarning" class="stop-loss-warning" style="display: none;"></div>
            </div>
            <h3 style="margin-top: 25px; margin-bottom: 15px;">é¢¨éšªç®¡ç†åƒæ•¸</h3>
            <p><strong>å‡±åˆ©æŠ•è³‡æ¯”ä¾‹:</strong> <span id="kellyRatio"></span></p>
            <p><strong>è¨ˆç®—å¾Œå‹ç‡:</strong> <span id="calculatedWinRate"></span></p>
            <p><strong>è¨ˆç®—å¾Œè³ ç‡:</strong> <span id="calculatedOdds"></span></p>
            <p><strong>AIè©•ä¼°å‹ç‡:</strong> <span id="adjustedWinRate"></span></p>
            <p><strong>AIè©•ä¼°è³ ç‡:</strong> <span id="adjustedOdds"></span></p>
            <h3 style="margin-top: 25px; margin-bottom: 15px;">æ³¢å‹•ç‡åˆ†æ</h3>
            <p><strong>æ—¥æ³¢å‹•ç‡:</strong> <span id="dailyVolatility"></span></p>
            <p><strong>å‘¨æ³¢å‹•ç‡:</strong> <span id="weeklyVolatility"></span></p>
            <p><strong>æœˆæ³¢å‹•ç‡:</strong> <span id="monthlyVolatility"></span></p>
            <p><strong>å¹´æ³¢å‹•ç‡:</strong> <span id="annualVolatility"></span></p>
            <div class="disclaimer" style="margin-top: 35px;">
                <h3>âš ï¸ é‡è¦é¢¨éšªè­¦ç¤ºèˆ‡å…è²¬è²æ˜</h3>
                <ul>
                    <li><strong>æœ¬å·¥å…·åƒ…ä¾›åƒè€ƒ,ä¸æ§‹æˆæŠ•è³‡å»ºè­°</strong></li>
                    <li>å‹ç‡è¨ˆç®—åŸºæ–¼æŠ€è¡“æŒ‡æ¨™æ¨ä¼°,<strong>éå¯¦éš›å›æ¸¬çµæœ</strong>,å¯¦éš›å‹ç‡å¯èƒ½å¤§å¹…ä¸åŒ</li>
                    <li>å‡±åˆ©æ¯”ä¾‹ç‚ºç†è«–å€¼,å¯¦éš›äº¤æ˜“æ‡‰æ ¹æ“šå€‹äººé¢¨éšªæ‰¿å—èƒ½åŠ›<strong>å¤§å¹…é™ä½æŠ•è³‡æ¯”ä¾‹</strong></li>
                    <li>æŠ€è¡“åˆ†ææœ‰å…¶å±€é™æ€§,æ‡‰çµåˆåŸºæœ¬é¢ã€å¸‚å ´ç’°å¢ƒèˆ‡è³‡é‡‘ç®¡ç†</li>
                    <li>éå»è¡¨ç¾ä¸ä»£è¡¨æœªä¾†çµæœ,æŠ•è³‡æœ‰é¢¨éšª,è«‹è¬¹æ…è©•ä¼°</li>
                    <li>å»ºè­°:å¯¦éš›æŠ•è³‡é‡‘é¡ä¸æ‡‰è¶…éå‡±åˆ©æ¯”ä¾‹çš„ <strong>1/4 åˆ° 1/2</strong></li>
                </ul>
                <p style="text-align: center; margin-top: 18px; font-size: 1rem; color: #666;">Â© 2025 Joseph PAI ç‰ˆæ¬Šæ‰€æœ‰</p>
            </div>
        </div>
    </div>
    
    <!-- ä¿®æ”¹ï¼šæµ®å‹•è¦–çª—HTMLçµæ§‹ - è‡ªé©æ‡‰å¤§å°çš„æµ®å‹•è¦–çª— -->
    <div class="real-time-data-display" id="realTimeDataDisplay">
        <div class="info-header">
            <div class="info-date" id="realTimeDate">-- æ—¥æœŸ --</div>
            <div class="info-index" id="realTimeIndex">ç¬¬ 0 ç­† / å…± 0 ç­†</div>
        </div>
        <div class="info-body">
            <!-- è‚¡ç¥¨åç¨±é¡¯ç¤º -->
            <div class="stock-name-header" id="realTimeStockName">è‚¡ç¥¨åç¨±</div>
            
            <!-- å€‹è‚¡åƒ¹æ ¼é¡¯ç¤º -->
            <div class="info-row">
                <div class="info-label">
                    <span class="color-dot" style="background: #ff6b6b;"></span>
                    <span id="realTimeStockLabel">å€‹è‚¡åƒ¹æ ¼</span>
                </div>
                <div class="stock-price-display" id="realTimeStockPrice">0.00</div>
            </div>
            
            <!-- å¤§ç›¤æŒ‡æ•¸é¡¯ç¤º -->
            <div class="info-row">
                <div class="info-label">
                    <span class="color-dot" style="background: #51cf66;"></span>
                    <span id="realTimeMarketLabel">å¤§ç›¤æŒ‡æ•¸</span>
                </div>
                <div class="market-index-display" id="realTimeMarketPrice">0.00</div>
            </div>
            
            <div class="info-divider"></div>
            
            <!-- å€‹è‚¡æ—¥æ¼²è·Œ -->
            <div class="info-row">
                <div class="info-label">å€‹è‚¡æ—¥æ¼²è·Œ</div>
                <div class="info-value" id="realTimeStockDailyChange">0.00%</div>
            </div>
            
            <!-- å¤§ç›¤æ—¥æ¼²è·Œ -->
            <div class="info-row">
                <div class="info-label">å¤§ç›¤æ—¥æ¼²è·Œ</div>
                <div class="info-value" id="realTimeMarketDailyChange">0.00%</div>
            </div>
            
            <!-- å€‹è‚¡ç´¯è¨ˆè®ŠåŒ– -->
            <div class="info-row">
                <div class="info-label">å€‹è‚¡ç´¯è¨ˆè®ŠåŒ–</div>
                <div class="info-value" id="realTimeStockChange">0.00%</div>
            </div>
            
            <!-- å¤§ç›¤ç´¯è¨ˆè®ŠåŒ– -->
            <div class="info-row">
                <div class="info-label">å¤§ç›¤ç´¯è¨ˆè®ŠåŒ–</div>
                <div class="info-value" id="realTimeMarketChange">0.00%</div>
            </div>
            
            <!-- ç›¸å°å¼·å¼± -->
            <div class="info-row">
                <div class="info-label">ç›¸å°å¼·å¼±</div>
                <div class="info-value" id="realTimeRelativeStrength">0.00%</div>
            </div>
        </div>
        <div class="info-footer">è·Ÿéš¨æ¸¸æ¨™é¡¯ç¤º - å°ç£è‚¡ç¥¨AIå°ˆæ¥­åŠ©ç†</div>
    </div>
    
    <script>
        let stockData = [];
        let industries = new Set();
        let selectedCompanyType = '';
        let chartInstance = null;
        let stockChartData = [];
        let marketChartData = [];
        let chartDates = [];
        let chartDataPoints = [];
        let currentStockCode = '';
        let currentStockName = '';
        let calendarData = {};
        let selectedDates = new Set();
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        const hotStocks = [
            { code: '2330', name: 'å°ç©é›»', type: 'twse' },{ code: '2454', name: 'è¯ç™¼ç§‘', type: 'twse' },{ code: '2317', name: 'é´»æµ·', type: 'twse' },{ code: '2412', name: 'ä¸­è¯é›»', type: 'twse' },{ code: '2308', name: 'å°é”é›»', type: 'twse' },
            { code: '2882', name: 'åœ‹æ³°é‡‘', type: 'twse' },{ code: '2881', name: 'å¯Œé‚¦é‡‘', type: 'twse' },{ code: '2886', name: 'å…†è±é‡‘', type: 'twse' },{ code: '5871', name: 'ä¸­ç§Ÿ-KY', type: 'twse' },{ code: '3045', name: 'å°ç£å¤§', type: 'twse' },
            { code: '6505', name: 'å°å¡‘åŒ–', type: 'twse' },{ code: '1326', name: 'å°åŒ–', type: 'twse' },{ code: '1101', name: 'å°æ³¥', type: 'twse' },{ code: '2891', name: 'ä¸­ä¿¡é‡‘', type: 'twse' },{ code: '2884', name: 'ç‰å±±é‡‘', type: 'twse' },
            { code: '3008', name: 'å¤§ç«‹å…‰', type: 'twse' },{ code: '3711', name: 'æ—¥æœˆå…‰æŠ•æ§', type: 'twse' },{ code: '2303', name: 'è¯é›»', type: 'twse' },{ code: '2327', name: 'åœ‹å·¨', type: 'twse' },{ code: '2382', name: 'å»£é”', type: 'twse' },
            { code: '6669', name: 'ç·¯ç©', type: 'twse' },{ code: '6415', name: 'çŸ½åŠ›-KY', type: 'twse' },{ code: '6488', name: 'ç’°çƒæ™¶', type: 'tpex' },{ code: '5274', name: 'ä¿¡é©Š', type: 'tpex' },{ code: '5347', name: 'ä¸–ç•Œ', type: 'tpex' },
            { code: '6239', name: 'åŠ›æˆ', type: 'tpex' },{ code: '3105', name: 'ç©©æ‡‹', type: 'tpex' },{ code: '8299', name: 'ç¾¤è¯', type: 'tpex' },{ code: '1560', name: 'ä¸­ç ‚', type: 'tpex' },{ code: '5483', name: 'ä¸­ç¾æ™¶', type: 'tpex' },
            { code: '3376', name: 'æ–°æ—¥èˆˆ', type: 'tpex' },{ code: '3661', name: 'ä¸–èŠ¯-KY', type: 'tpex' }
        ];
        let recentStocks = JSON.parse(localStorage.getItem('recentStocks') || '[]');
        const AI_API_ENDPOINTS = {
            deepseek: 'https://api.deepseek.com/v1/chat/completions',
            openai: 'https://api.openai.com/v1/chat/completions',
            claude: 'https://api.anthropic.com/v1/messages',
            gemini: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent',
            grok: 'https://api.x.ai/v1/chat/completions'
        };
        const AI_PLATFORM_URLS = {
            deepseek: 'https://platform.deepseek.com/api_keys',
            openai: 'https://platform.openai.com/api-keys',
            claude: 'https://console.anthropic.com/settings/keys',
            gemini: 'https://aistudio.google.com/apikey',
            grok: 'https://console.x.ai/account/api-keys'
        };
        
        const analysisScenarios = {
            'big_up_small_up': 'å¼·å‹¢é ˜æ¼²è‚¡ï¼Œå¯è€ƒæ…®åŠ ç¢¼æˆ–æŒæœ‰ï¼Œé—œæ³¨é‡èƒ½æ˜¯å¦æŒçºŒæ”¾å¤§',
            'medium_up_medium_up': 'è·Ÿéš¨å¤§ç›¤æ³¢å‹•ï¼Œå»ºè­°è§€å¯Ÿå€‹è‚¡åŸºæœ¬é¢èˆ‡æŠ€è¡“é¢ï¼Œé©æ™‚èª¿æ•´å€‰ä½',
            'up_down': 'æŠ—è·Œå¼·å‹¢è‚¡ï¼Œå¯èƒ½æ˜¯è³‡é‡‘é¿é¢¨æ¸¯ï¼Œå¯è€ƒæ…®åˆ†æ‰¹å»ºå€‰ä½†æ³¨æ„é¢¨éšª',
            'big_down_small_down': 'å¼±å‹¢è‚¡éœ€ç•™æ„ï¼Œå¯èƒ½é¢è‡¨è³£å£“ï¼Œå»ºè­°æ¸›å€‰æˆ–è¨­å®šåš´æ ¼æ­¢æ',
            'big_up_medium_up': 'å¼·å‹¢è‚¡è¡¨ç¾å„ªæ–¼å¤§ç›¤ï¼Œå¯æŒçºŒæŒæœ‰æˆ–é©åº¦åŠ ç¢¼',
            'small_up_big_up': 'è½å¾Œè£œæ¼²è‚¡ï¼Œéœ€è§€å¯Ÿèƒ½å¦è·Ÿä¸Šå¤§ç›¤æ¼²å‹¢',
            'big_down_medium_down': 'å¼±å‹¢è‚¡è·Œå¹…å¤§æ–¼å¤§ç›¤ï¼Œå»ºè­°æ¸›å€‰è§€æœ›',
            'medium_down_small_down': 'è·Œå¹…èˆ‡å¤§ç›¤ç›¸ç•¶ï¼Œå»ºè­°ç­‰å¾…æ­¢è·Œè¨Šè™Ÿ'
        };

        function getStoredApiKey(platform) { return localStorage.getItem(`ai_api_key_${platform}`); }
        function storeApiKey(platform, apiKey) { const encryptedKey = btoa(apiKey); localStorage.setItem(`ai_api_key_${platform}`, encryptedKey); }
        function getDecryptedApiKey(platform) {
            const encryptedKey = localStorage.getItem(`ai_api_key_${platform}`);
            if (!encryptedKey) return null;
            try { return atob(encryptedKey); } catch (error) { console.error('è§£å¯† API Key å¤±æ•—:', error); return null; }
        }
        function updateApiKeyLink(platform) {
            const link = document.getElementById('apiKeyLink');
            if (platform && AI_PLATFORM_URLS[platform]) {
                link.href = AI_PLATFORM_URLS[platform];
                link.textContent = `é»æ“Šé€™è£¡å‰å¾€ ${platform.charAt(0).toUpperCase() + platform.slice(1)} å®˜ç¶²ç²å–API Key`;
            } else { link.href = '#'; link.textContent = 'è«‹å…ˆé¸æ“‡AIå¹³å°'; }
        }
        async function verifyApiKey(platform, apiKey) {
            const statusEl = document.getElementById('apiStatus');
            statusEl.style.display = 'block';
            statusEl.className = 'api-status';
            statusEl.textContent = 'æ­£åœ¨é©—è­‰é€£ç·š...';
            const apiKeyInput = document.getElementById('apiKeyInput');
            const originalApiKey = apiKeyInput.value;
            try {
                let response;
                const testMessage = "Hello";
                switch(platform) {
                    case 'deepseek':
                        response = await fetch(AI_API_ENDPOINTS[platform], {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: 'deepseek-chat', messages: [{ role: 'user', content: testMessage }], max_tokens: 10 })
                        }); break;
                    case 'openai':
                        response = await fetch(AI_API_ENDPOINTS[platform], {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: 'gpt-3.5-turbo', messages: [{ role: 'user', content: testMessage }], max_tokens: 10 })
                        }); break;
                    case 'claude':
                        response = await fetch(AI_API_ENDPOINTS[platform], {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01' },
                            body: JSON.stringify({ model: 'claude-3-sonnet-20240229', messages: [{ role: 'user', content: testMessage }], max_tokens: 10 })
                        }); break;
                    case 'gemini':
                        response = await fetch(`${AI_API_ENDPOINTS[platform]}?key=${apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: testMessage }] }] })
                        }); break;
                    case 'grok':
                        response = await fetch(AI_API_ENDPOINTS[platform], {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: 'grok-beta', messages: [{ role: 'user', content: testMessage }], max_tokens: 10 })
                        }); break;
                }
                if (response.ok) {
                    storeApiKey(platform, apiKey);
                    statusEl.className = 'api-status success';
                    statusEl.textContent = 'âœ“ é€£ç·šæˆåŠŸ!API Key å·²å„²å­˜åœ¨æœ¬æ©Ÿ';
                    document.getElementById('querySubmitBtn').disabled = false;
                    apiKeyInput.type = 'password';
                    apiKeyInput.value = '********';
                    autoFillDefaultPrompt();
                    return true;
                } else {
                    const errorData = await response.json();
                    statusEl.className = 'api-status error';
                    statusEl.textContent = `âœ— é€£ç·šå¤±æ•—: ${errorData.error?.message || 'ç„¡æ•ˆçš„ API Key'}`;
                    apiKeyInput.type = 'text';
                    apiKeyInput.value = originalApiKey;
                    return false;
                }
            } catch (error) {
                statusEl.className = 'api-status error';
                statusEl.textContent = `âœ— é€£ç·šéŒ¯èª¤: ${error.message}`;
                apiKeyInput.type = 'text';
                apiKeyInput.value = originalApiKey;
                return false;
            }
        }
        function autoFillDefaultPrompt() {
            const stockCode = document.getElementById('stockCode').value.trim();
            const stockName = getStockNameByCode(stockCode);
            const stockInfo = stockName ? `${stockName}${stockCode}` : `è‚¡ç¥¨${stockCode}`;
            const defaultPrompt = `ä½ æ˜¯è³‡æ·±è‚¡ç¥¨åˆ†æå¸«ï¼Œåˆ†æ"${stockInfo}"çš„è‚¡åƒ¹è¶¨å‹¢ï¼Œåšå‡ºä¸å°‘æ–¼å…­å€‹é‡é»æ•´ç†çµ¦æˆ‘ï¼ŒæŒ‰ç…§-30ï½+30çš„å€é–“åšå‡ºç¸½è©•åˆ†`;
            document.getElementById('queryInput').value = defaultPrompt;
        }
        function getStockNameByCode(stockCode) {
            if (!stockCode) return '';
            const foundStock = stockData.find(stock => stock.stock_id === stockCode);
            if (foundStock) { return foundStock.stock_name; }
            const hotStock = hotStocks.find(stock => stock.code === stockCode);
            if (hotStock) { return hotStock.name; }
            return '';
        }
        async function queryAI(platform, apiKey, query) {
            const responseEl = document.getElementById('aiResponseContent');
            responseEl.innerHTML = '<div class="loading-spinner"></div> æ­£åœ¨æŸ¥è©¢ä¸­,è«‹ç¨å€™...';
            document.getElementById('aiResponseSection').classList.add('show');
            try {
                let response;
                let content = '';
                switch(platform) {
                    case 'deepseek':
                        response = await fetch(AI_API_ENDPOINTS[platform], {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: 'deepseek-chat', messages: [{ role: 'user', content: query }], max_tokens: 2000 })
                        });
                        if (response.ok) { const data = await response.json(); content = data.choices[0].message.content; } else { throw new Error('API è«‹æ±‚å¤±æ•—'); }
                        break;
                    case 'openai':
                        response = await fetch(AI_API_ENDPOINTS[platform], {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: 'gpt-4', messages: [{ role: 'user', content: query }], max_tokens: 2000 })
                        });
                        if (response.ok) { const data = await response.json(); content = data.choices[0].message.content; } else { throw new Error('API è«‹æ±‚å¤±æ•—'); }
                        break;
                    case 'claude':
                        response = await fetch(AI_API_ENDPOINTS[platform], {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01' },
                            body: JSON.stringify({ model: 'claude-3-sonnet-20240229', messages: [{ role: 'user', content: query }], max_tokens: 2000 })
                        });
                        if (response.ok) { const data = await response.json(); content = data.content[0].text; } else { throw new Error('API è«‹æ±‚å¤±æ•—'); }
                        break;
                    case 'gemini':
                        response = await fetch(`${AI_API_ENDPOINTS[platform]}?key=${apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: query }] }] })
                        });
                        if (response.ok) { const data = await response.json(); content = data.candidates[0].content.parts[0].text; } else { throw new Error('API è«‹æ±‚å¤±æ•—'); }
                        break;
                    case 'grok':
                        response = await fetch(AI_API_ENDPOINTS[platform], {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: 'grok-beta', messages: [{ role: 'user', content: query }], max_tokens: 2000 })
                        });
                        if (response.ok) { const data = await response.json(); content = data.choices[0].message.content; } else { throw new Error('API è«‹æ±‚å¤±æ•—'); }
                        break;
                }
                responseEl.textContent = content;
            } catch (error) { responseEl.innerHTML = `<div style="color: #ff6b6b;">âŒ æŸ¥è©¢å¤±æ•—: ${error.message}</div>`; }
        }
        async function fetchMarketIndexData(startDate, endDate) {
            try {
                const marketCode = "TAIEX";
                const startDateParam = formatDate(startDate);
                const endDateParam = formatDate(endDate);
                const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${marketCode}&start_date=${startDateParam}&end_date=${endDateParam}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('ç„¡æ³•å–å¾—å¤§ç›¤æ•¸æ“š');
                const json = await res.json();
                if (json.status === 200 && Array.isArray(json.data)) {
                    const marketData = {};
                    json.data.forEach(row => {
                        const date = row.date;
                        const close = row.close === null || row.close === undefined ? '' : String(row.close).replace(/,/g, '').trim();
                        marketData[date] = close === '-' ? '' : close;
                    });
                    return marketData;
                } else { throw new Error('å¤§ç›¤æ•¸æ“šæ ¼å¼ç•°å¸¸'); }
            } catch (error) { console.error('ç²å–å¤§ç›¤æ•¸æ“šå¤±æ•—:', error); return null; }
        }
        async function prepareCalendarData(stockCode, startDate, endDate, historicalPrices) {
            try {
                const marketData = await fetchMarketIndexData(startDate, endDate);
                const stockDetailedData = await fetchStockDetailedData(stockCode, startDate, endDate);
                
                // éæ¿¾æ‰æ²’æœ‰å€‹è‚¡æ•¸æ“šæˆ–å€‹è‚¡æ•¸æ“šç‚º0çš„æ—¥æœŸ
                const allDates = datesBetween(startDate, endDate);
                const validDates = allDates.filter(date => {
                    const stockPrice = stockDetailedData[date];
                    const priceNum = parseFloat(stockPrice);
                    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ­£æ•¸åƒ¹æ ¼
                    return stockPrice && !isNaN(priceNum) && priceNum > 0;
                });
                
                const calendarData = {};
                let totalDays = 0; let tradingDays = 0; let stockDataDays = 0; let marketDataDays = 0;
                
                validDates.forEach(date => {
                    const dateObj = new Date(date);
                    const dayOfWeek = dateObj.getDay();
                    const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                    const stockPrice = stockDetailedData[date];
                    const priceNum = parseFloat(stockPrice);
                    const hasStockData = stockPrice && !isNaN(priceNum) && priceNum > 0;
                    const marketPrice = marketData ? marketData[date] : null;
                    const marketPriceNum = marketPrice ? parseFloat(marketPrice) : null;
                    const hasMarketData = marketPrice && !isNaN(marketPriceNum) && marketPriceNum > 0;
                    const isTradingDay = hasStockData;
                    
                    calendarData[date] = {
                        date: date, year: dateObj.getFullYear(), month: dateObj.getMonth(), day: dateObj.getDate(),
                        dayOfWeek: dayOfWeek, isWeekend: isWeekend, isTradingDay: isTradingDay,
                        stock: { hasData: hasStockData, price: hasStockData ? priceNum : null, change: null },
                        market: { hasData: hasMarketData, price: hasMarketData ? marketPriceNum : null, change: null },
                        selected: false
                    };
                    
                    totalDays++;
                    if (isTradingDay) tradingDays++;
                    if (hasStockData) stockDataDays++;
                    if (hasMarketData) marketDataDays++;
                });
                
                // è¨ˆç®—ç´¯è¨ˆè®ŠåŒ–ç‡
                let firstStockPrice = null;
                let firstMarketPrice = null;
                const sortedDates = Object.keys(calendarData).sort();
                
                // æ‰¾åˆ°ç¬¬ä¸€å€‹æœ‰æ•ˆçš„å€‹è‚¡åƒ¹æ ¼
                for (const date of sortedDates) {
                    const dayData = calendarData[date];
                    if (dayData.stock.hasData && firstStockPrice === null) {
                        firstStockPrice = dayData.stock.price;
                        break;
                    }
                }
                
                // æ‰¾åˆ°ç¬¬ä¸€å€‹æœ‰æ•ˆçš„å¤§ç›¤åƒ¹æ ¼
                for (const date of sortedDates) {
                    const dayData = calendarData[date];
                    if (dayData.market.hasData && firstMarketPrice === null) {
                        firstMarketPrice = dayData.market.price;
                        break;
                    }
                }
                
                // è¨ˆç®—æ¯å€‹æ—¥æœŸçš„ç´¯è¨ˆè®ŠåŒ–ç‡
                sortedDates.forEach(date => {
                    const dayData = calendarData[date];
                    if (dayData.stock.hasData && firstStockPrice !== null) {
                        const cumulativeChange = ((dayData.stock.price - firstStockPrice) / firstStockPrice * 100);
                        dayData.stock.cumulativeChange = cumulativeChange.toFixed(2);
                    }
                    if (dayData.market.hasData && firstMarketPrice !== null) {
                        const cumulativeChange = ((dayData.market.price - firstMarketPrice) / firstMarketPrice * 100);
                        dayData.market.cumulativeChange = cumulativeChange.toFixed(2);
                    }
                });
                
                // è¨ˆç®—æ—¥æ¼²è·Œå¹…
                let prevStockPrice = null;
                let prevMarketPrice = null;
                sortedDates.forEach(date => {
                    const dayData = calendarData[date];
                    if (dayData.stock.hasData) {
                        if (prevStockPrice !== null) {
                            const change = ((dayData.stock.price - prevStockPrice) / prevStockPrice * 100);
                            dayData.stock.change = change.toFixed(2);
                        }
                        prevStockPrice = dayData.stock.price;
                    }
                    if (dayData.market.hasData) {
                        if (prevMarketPrice !== null) {
                            const change = ((dayData.market.price - prevMarketPrice) / prevMarketPrice * 100);
                            dayData.market.change = change.toFixed(2);
                        }
                        prevMarketPrice = dayData.market.price;
                    }
                });
                
                return {
                    data: calendarData,
                    stats: { totalDays: totalDays, tradingDays: tradingDays, stockDataDays: stockDataDays, marketDataDays: marketDataDays }
                };
            } catch (error) { console.error('æº–å‚™æ—¥æ›†æ•¸æ“šå¤±æ•—:', error); throw error; }
        }
        async function fetchStockDetailedData(stockCode, startDate, endDate) {
            try {
                const startDateParam = formatDate(startDate);
                const endDateParam = formatDate(endDate);
                const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${stockCode}&start_date=${startDateParam}&end_date=${endDateParam}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('ç„¡æ³•å–å¾—å€‹è‚¡è©³ç´°æ•¸æ“š');
                const json = await res.json();
                if (json.status === 200 && Array.isArray(json.data)) {
                    const stockData = {};
                    json.data.forEach(row => {
                        const date = row.date;
                        const close = row.close === null || row.close === undefined ? '' : String(row.close).replace(/,/g, '').trim();
                        // åªå„²å­˜æœ‰æ•¸æ“šä¸”ä¸ç‚º0çš„æ—¥æœŸ
                        const closeNum = parseFloat(close);
                        if (close && close !== '-' && close !== '' && !isNaN(closeNum) && closeNum > 0) {
                            stockData[date] = close;
                        }
                    });
                    return stockData;
                } else { throw new Error('å€‹è‚¡è©³ç´°æ•¸æ“šæ ¼å¼ç•°å¸¸'); }
            } catch (error) { console.error('ç²å–å€‹è‚¡è©³ç´°æ•¸æ“šå¤±æ•—:', error); return {}; }
        }
        function generateCalendarHTML(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            const adjustedStartingDay = (startingDay + 6) % 7;
            let html = '';
            let dayCount = 0;
            for (let week = 0; week < 6; week++) {
                html += '<tr>';
                for (let weekday = 0; weekday < 5; weekday++) {
                    const cellIndex = week * 5 + weekday;
                    if (cellIndex < adjustedStartingDay || dayCount >= daysInMonth) { html += '<td class="calendar-day"></td>'; } else {
                        dayCount++;
                        const currentDate = new Date(year, month, dayCount);
                        const dateStr = formatDate(currentDate);
                        const dayData = calendarData[dateStr] || null;
                        let cellClass = 'calendar-day';
                        let cellContent = '';
                        if (dayData) {
                            const isWeekend = dayData.isWeekend;
                            const isTradingDay = dayData.isTradingDay;
                            const hasStockData = dayData.stock.hasData;
                            const hasMarketData = dayData.market.hasData;
                            const isSelected = selectedDates.has(dateStr);
                            if (isWeekend) { cellClass += ' weekend'; } else if (isTradingDay) { cellClass += ' trading-day'; } else { cellClass += ' holiday'; }
                            if (isSelected) { cellClass += ' selected'; }
                            cellContent += `<div class="calendar-date">${dayCount}</div>`;
                            cellContent += '<div class="calendar-data">';
                            if (hasStockData) {
                                const cumulativeChange = dayData.stock.cumulativeChange;
                                const dailyChange = dayData.stock.change;
                                const cumulativeChangeClass = cumulativeChange && parseFloat(cumulativeChange) >= 0 ? 'positive' : 'negative';
                                const dailyChangeClass = dailyChange && parseFloat(dailyChange) >= 0 ? 'positive' : 'negative';
                                cellContent += `
                                    <div class="data-item stock" data-date="${dateStr}" data-type="stock">
                                        <span class="data-icon">ğŸ“ˆ</span>
                                        <span class="data-value">${dayData.stock.price.toFixed(2)}</span>
                                        <div style="font-size:0.7rem;margin-top:2px;">
                                            ç´¯è¨ˆ: <span class="${cumulativeChangeClass}">${cumulativeChange}%</span>
                                            ${dailyChange ? `<br>æ—¥æ¼²è·Œ: <span class="${dailyChangeClass}">${dailyChange}%</span>` : ''}
                                        </div>
                                    </div>
                                `;
                            }
                            if (hasMarketData) {
                                const cumulativeChange = dayData.market.cumulativeChange;
                                const dailyChange = dayData.market.change;
                                const cumulativeChangeClass = cumulativeChange && parseFloat(cumulativeChange) >= 0 ? 'positive' : 'negative';
                                const dailyChangeClass = dailyChange && parseFloat(dailyChange) >= 0 ? 'positive' : 'negative';
                                cellContent += `
                                    <div class="data-item market" data-date="${dateStr}" data-type="market">
                                        <span class="data-icon">ğŸ“Š</span>
                                        <span class="data-value">${dayData.market.price.toFixed(0)}</span>
                                        <div style="font-size:0.7rem;margin-top:2px;">
                                            ç´¯è¨ˆ: <span class="${cumulativeChangeClass}">${cumulativeChange}%</span>
                                            ${dailyChange ? `<br>æ—¥æ¼²è·Œ: <span class="${dailyChangeClass}">${dailyChange}%</span>` : ''}
                                        </div>
                                    </div>
                                `;
                            }
                            if (!hasStockData && !hasMarketData && !isWeekend) { cellContent += `<div class="data-item no-data">ç„¡æ•¸æ“š</div>`; }
                            if (isWeekend) { cellContent += `<div class="data-item weekend">ä¼‘å¸‚</div>`; }
                            cellContent += '</div>';
                        } else {
                            cellClass += ' holiday';
                            cellContent += `<div class="calendar-date">${dayCount}</div>`;
                            cellContent += '<div class="calendar-data">';
                            cellContent += `<div class="data-item no-data">ç„¡æ•¸æ“š</div>`;
                            cellContent += '</div>';
                        }
                        html += `<td class="${cellClass}" data-date="${dateStr}">${cellContent}</td>`;
                    }
                }
                html += '</tr>';
                if (dayCount >= daysInMonth) { break; }
            }
            return html;
        }
        function updateCalendarStats() {
            const totalDays = Object.keys(calendarData).length;
            const tradingDays = Object.values(calendarData).filter(day => day.isTradingDay).length;
            const stockDataDays = Object.values(calendarData).filter(day => day.stock.hasData).length;
            const marketDataDays = Object.values(calendarData).filter(day => day.market.hasData).length;
            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('tradingDays').textContent = tradingDays;
            document.getElementById('stockDataDays').textContent = stockDataDays;
            document.getElementById('marketDataDays').textContent = marketDataDays;
            document.getElementById('selectedDays').textContent = selectedDates.size;
        }
        function updateDateRangeDisplay(startDate, endDate) {
            const startStr = formatDate(startDate);
            const endStr = formatDate(endDate);
            document.getElementById('dateRangeDisplay').textContent = `${startStr} è‡³ ${endStr}`;
        }
        function renderCalendar(year, month) {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = generateCalendarHTML(year, month);
            const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
            document.querySelector('.calendar-header h4').textContent = `äº¤æ˜“æ—¥æ›†è¦–è¦ºåŒ– - ${year}å¹´${monthNames[month]}`;
            updateCalendarStats();
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const currentDate = new Date(year, month, 1);
            const prevDate = new Date(year, month - 1, 1);
            const nextDate = new Date(year, month + 1, 1);
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            prevMonthBtn.disabled = prevDate < startDate;
            nextMonthBtn.disabled = nextDate > endDate;
        }
        
        // ä¿®æ”¹ï¼šç§»é™¤æ—¥æ›†æ‡¸æµ®çª—ç›¸é—œåŠŸèƒ½
        function setupCalendarEventListeners() {
            document.getElementById('prevMonthBtn').addEventListener('click', function() {
                if (this.disabled) return;
                currentCalendarMonth--;
                if (currentCalendarMonth < 0) { currentCalendarMonth = 11; currentCalendarYear--; }
                renderCalendar(currentCalendarYear, currentCalendarMonth);
            });
            document.getElementById('nextMonthBtn').addEventListener('click', function() {
                if (this.disabled) return;
                currentCalendarMonth++;
                if (currentCalendarMonth > 11) { currentCalendarMonth = 0; currentCalendarYear++; }
                renderCalendar(currentCalendarYear, currentCalendarMonth);
            });
            
            // ç§»é™¤æ—¥æ›†é»æ“Šäº‹ä»¶ï¼Œç¦æ­¢æ‰‹å‹•é¸æ“‡æ—¥æœŸ
            document.getElementById('calendarBody').addEventListener('click', function(event) {
                // ä¸å†éŸ¿æ‡‰æ—¥æœŸé¸æ“‡
                event.stopPropagation();
            });
            
            // ä¿®æ”¹ï¼šæ—¥æ›†hoveræ™‚ä¸é¡¯ç¤ºä»»ä½•æ‡¸æµ®çª—
            document.getElementById('calendarBody').addEventListener('mouseover', function(event) {
                // ä»€éº¼éƒ½ä¸åšï¼Œä¸é¡¯ç¤ºæ‡¸æµ®çª—
            });
            
            document.getElementById('calendarBody').addEventListener('mouseout', function() {
                // ä»€éº¼éƒ½ä¸åš
            });
        }
        
        function prepareChartDataFromSelectedDates() {
            // ç¸½æ˜¯ä½¿ç”¨æ‰€æœ‰æœ‰æ•ˆäº¤æ˜“æ—¥
            const allTradingDates = Object.keys(calendarData).filter(dateStr => {
                const dayData = calendarData[dateStr];
                return dayData && dayData.isTradingDay;
            }).sort();
            
            if (allTradingDates.length === 0) { 
                alert('åœ¨é¸å–çš„æ™‚é–“å€æ®µå…§æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆäº¤æ˜“æ—¥'); 
                return null; 
            }
            
            const dates = [];
            const stockPrices = [];
            const marketPrices = [];
            
            allTradingDates.forEach(dateStr => {
                const dayData = calendarData[dateStr];
                if (dayData.stock.hasData || dayData.market.hasData) {
                    dates.push(dateStr);
                    if (dayData.stock.hasData) { 
                        stockPrices.push(dayData.stock.price); 
                    } else { 
                        stockPrices.push(null); 
                    }
                    if (dayData.market.hasData) { 
                        marketPrices.push(dayData.market.price); 
                    } else { 
                        marketPrices.push(null); 
                    }
                }
            });
            
            const validIndices = [];
            for (let i = 0; i < dates.length; i++) {
                if (stockPrices[i] !== null || marketPrices[i] !== null) { 
                    validIndices.push(i); 
                }
            }
            
            if (validIndices.length === 0) { 
                alert('é¸å–çš„æ—¥æœŸä¸­æ²’æœ‰æœ‰æ•ˆçš„åƒ¹æ ¼æ•¸æ“š'); 
                return null; 
            }
            
            const validDates = validIndices.map(i => dates[i]);
            const validStockPrices = validIndices.map(i => stockPrices[i]);
            const validMarketPrices = validIndices.map(i => marketPrices[i]);
            
            const baseStockPrice = validStockPrices.find(price => price !== null && price > 0);
            const baseMarketPrice = validMarketPrices.find(price => price !== null && price > 0);
            
            const stockPercentageData = validStockPrices.map(price => {
                if (price === null || baseStockPrice === null || price === 0) return null;
                return ((price - baseStockPrice) / baseStockPrice * 100);
            });
            
            const marketPercentageData = validMarketPrices.map(price => {
                if (price === null || baseMarketPrice === null || price === 0) return null;
                return ((price - baseMarketPrice) / baseMarketPrice * 100);
            });
            
            return {
                dates: validDates,
                stockData: stockPercentageData,
                marketData: marketPercentageData,
                stockPrices: validStockPrices,
                marketPrices: validMarketPrices
            };
        }
        
        // ä¿®æ”¹ï¼šæ”¹é€²æ•¸æ“šé»ç´¢å¼•è¨ˆç®—ï¼Œè§£æ±ºæ—¥æœŸå°é½Šå•é¡Œ
        function getNearestDataPointIndex(mouseX, chartInstance, chartDataPoints) {
            if (!chartInstance || !chartDataPoints || chartDataPoints.length === 0) return -1;
            
            const chartRect = document.getElementById('marketComparisonChart').getBoundingClientRect();
            const chartWidth = chartRect.width;
            
            // è¨ˆç®—åœ–è¡¨Xè»¸çš„åƒç´ ç¯„åœï¼ˆè€ƒæ…®åˆ°åœ–è¡¨çš„é‚Šè·ï¼‰
            const scales = chartInstance.scales;
            if (!scales || !scales.x) return -1;
            
            // ç²å–åœ–è¡¨Xè»¸çš„åƒç´ ç¯„åœ
            const xPixelStart = scales.x.left;
            const xPixelEnd = scales.x.right;
            const xPixelRange = xPixelEnd - xPixelStart;
            
            // è¨ˆç®—ç›¸å°æ–¼åœ–è¡¨Xè»¸èµ·å§‹ä½ç½®çš„åç§»
            const xOffset = mouseX - xPixelStart;
            
            // å¦‚æœé¼ æ¨™åœ¨åœ–è¡¨Xè»¸ç¯„åœå¤–ï¼Œè¿”å›-1
            if (xOffset < 0 || xOffset > xPixelRange) return -1;
            
            // è¨ˆç®—æ•¸æ“šé»ç´¢å¼•ï¼ˆåŸºæ–¼ç›¸å°ä½ç½®ï¼‰
            const relativePosition = xOffset / xPixelRange;
            const index = Math.round(relativePosition * (chartDataPoints.length - 1));
            
            // ç¢ºä¿ç´¢å¼•åœ¨æœ‰æ•ˆç¯„åœå…§
            return Math.max(0, Math.min(index, chartDataPoints.length - 1));
        }
        
        // ä¿®æ”¹ï¼šæ–°å¢è§¸æ§ç‰ˆæ•¸æ“šé»ç´¢å¼•è¨ˆç®—
        function getNearestDataPointIndexForTouch(touchX, chartInstance, chartDataPoints) {
            if (!chartInstance || !chartDataPoints || chartDataPoints.length === 0) return -1;
            
            const chartRect = document.getElementById('marketComparisonChart').getBoundingClientRect();
            
            // è¨ˆç®—åœ–è¡¨Xè»¸çš„åƒç´ ç¯„åœ
            const scales = chartInstance.scales;
            if (!scales || !scales.x) return -1;
            
            // ç²å–åœ–è¡¨Xè»¸çš„åƒç´ ç¯„åœ
            const xPixelStart = scales.x.left;
            const xPixelEnd = scales.x.right;
            const xPixelRange = xPixelEnd - xPixelStart;
            
            // è¨ˆç®—ç›¸å°æ–¼åœ–è¡¨Xè»¸èµ·å§‹ä½ç½®çš„åç§»
            const xOffset = touchX - chartRect.left - xPixelStart;
            
            // å¦‚æœè§¸æ‘¸é»åœ¨åœ–è¡¨Xè»¸ç¯„åœå¤–ï¼Œè¿”å›-1
            if (xOffset < 0 || xOffset > xPixelRange) return -1;
            
            // è¨ˆç®—æ•¸æ“šé»ç´¢å¼•ï¼ˆåŸºæ–¼ç›¸å°ä½ç½®ï¼‰
            const relativePosition = xOffset / xPixelRange;
            const index = Math.round(relativePosition * (chartDataPoints.length - 1));
            
            // ç¢ºä¿ç´¢å¼•åœ¨æœ‰æ•ˆç¯„åœå…§
            return Math.max(0, Math.min(index, chartDataPoints.length - 1));
        }
        
        // æ·»åŠ å‡½æ•¸ä¾†å„ªåŒ–æµ®å‹•è¦–çª—æ–‡æœ¬é¡¯ç¤º
        function optimizeFloatingWindowText() {
            const realTimeDisplay = document.getElementById('realTimeDataDisplay');
            if (!realTimeDisplay) return;
            
            const windowWidth = window.innerWidth;
            
            // æ ¹æ“šå±å¹•å¯¬åº¦å‹•æ…‹èª¿æ•´
            if (windowWidth < 480) {
                // å°å±å¹•ï¼šç¸®çŸ­æ¨™ç±¤æ–‡æœ¬
                document.getElementById('realTimeStockLabel').textContent = 'å€‹è‚¡';
                document.getElementById('realTimeMarketLabel').textContent = 'å¤§ç›¤';
                
                // ç¢ºä¿è‚¡ç¥¨åç¨±ä¸æœƒå¤ªé•·
                const stockNameElement = document.getElementById('realTimeStockName');
                if (stockNameElement.textContent.length > 15) {
                    stockNameElement.textContent = stockNameElement.textContent.substring(0, 12) + '...';
                }
            } else if (windowWidth < 768) {
                // ä¸­ç­‰å±å¹•
                document.getElementById('realTimeStockLabel').textContent = 'å€‹è‚¡åƒ¹';
                document.getElementById('realTimeMarketLabel').textContent = 'å¤§ç›¤æŒ‡';
            } else {
                // å¤§å±å¹•ï¼šé¡¯ç¤ºå®Œæ•´æ¨™ç±¤
                document.getElementById('realTimeStockLabel').textContent = 'å€‹è‚¡åƒ¹æ ¼';
                document.getElementById('realTimeMarketLabel').textContent = 'å¤§ç›¤æŒ‡æ•¸';
            }
        }
        
        // ä¿®æ”¹ï¼šæ”¹é€²çš„æµ®å‹•è¦–çª—æ›´æ–°å‡½æ•¸
        function updateRealTimeDataDisplay(dataPoint, index, clientX, clientY) {
            const realTimeDisplay = document.getElementById('realTimeDataDisplay');
            
            if (!realTimeDisplay) {
                console.error('æµ®å‹•è¦–çª—å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // å…ˆå„ªåŒ–æ–‡æœ¬é¡¯ç¤º
            optimizeFloatingWindowText();
            
            // ç¢ºä¿æµ®å‹•è¦–çª—é¡¯ç¤º
            realTimeDisplay.classList.add('show');
            realTimeDisplay.style.display = 'flex';
            realTimeDisplay.style.opacity = '1';
            realTimeDisplay.style.pointerEvents = 'none';
            
            // æ›´æ–°æ—¥æœŸ
            document.getElementById('realTimeDate').textContent = dataPoint.date;
            document.getElementById('realTimeIndex').textContent = `ç¬¬ ${index + 1} ç­† / å…± ${chartDataPoints.length} ç­†`;
            
            // æ›´æ–°è‚¡ç¥¨åç¨±
            const stockNameElement = document.getElementById('realTimeStockName');
            if (currentStockName && stockNameElement) {
                stockNameElement.textContent = `${currentStockName}ï¼ˆ${currentStockCode}ï¼‰`;
            } else {
                stockNameElement.textContent = `è‚¡ç¥¨ï¼ˆ${currentStockCode}ï¼‰`;
            }
            
            // é¡¯ç¤ºå€‹è‚¡åƒ¹æ ¼
            if (dataPoint.stockPrice !== null && dataPoint.stockPrice > 0) {
                let stockPriceHtml = dataPoint.stockPrice.toFixed(2);
                if (dataPoint.stockDailyChange !== null && dataPoint.stockDailyChange !== undefined) {
                    const changeValue = parseFloat(dataPoint.stockDailyChange);
                    if (changeValue > 0) {
                        stockPriceHtml = `<span style="color: #ff6b6b; font-weight: bold; font-size: 1.2rem;">${stockPriceHtml}</span> <span class="change-display change-positive" style="font-size: 0.9rem;">+${changeValue.toFixed(2)}% â†—</span>`;
                    } else if (changeValue < 0) {
                        stockPriceHtml = `<span style="color: #51cf66; font-weight: bold; font-size: 1.2rem;">${stockPriceHtml}</span> <span class="change-display change-negative" style="font-size: 0.9rem;">${changeValue.toFixed(2)}% â†˜</span>`;
                    } else {
                        stockPriceHtml = `<span style="font-size: 1.2rem;">${stockPriceHtml}</span>`;
                    }
                } else {
                    stockPriceHtml = `<span style="font-size: 1.2rem;">${stockPriceHtml}</span>`;
                }
                document.getElementById('realTimeStockPrice').innerHTML = stockPriceHtml;
                document.getElementById('realTimeStockChange').textContent = `${dataPoint.stockValue !== null ? dataPoint.stockValue.toFixed(2) : '--'}%`;
            } else {
                document.getElementById('realTimeStockPrice').textContent = 'ç„¡æ•¸æ“š';
                document.getElementById('realTimeStockChange').textContent = '--';
            }
            
            // é¡¯ç¤ºå¤§ç›¤æŒ‡æ•¸
            if (dataPoint.marketPrice !== null && dataPoint.marketPrice > 0) {
                let marketPriceHtml = dataPoint.marketPrice.toFixed(0);
                if (dataPoint.marketDailyChange !== null && dataPoint.marketDailyChange !== undefined) {
                    const changeValue = parseFloat(dataPoint.marketDailyChange);
                    if (changeValue > 0) {
                        marketPriceHtml = `<span style="color: #ff6b6b; font-weight: bold; font-size: 1.2rem;">${marketPriceHtml}</span> <span class="change-display change-positive" style="font-size: 0.9rem;">+${changeValue.toFixed(2)}% â†—</span>`;
                    } else if (changeValue < 0) {
                        marketPriceHtml = `<span style="color: #51cf66; font-weight: bold; font-size: 1.2rem;">${marketPriceHtml}</span> <span class="change-display change-negative" style="font-size: 0.9rem;">${changeValue.toFixed(2)}% â†˜</span>`;
                    } else {
                        marketPriceHtml = `<span style="font-size: 1.2rem;">${marketPriceHtml}</span>`;
                    }
                } else {
                    marketPriceHtml = `<span style="font-size: 1.2rem;">${marketPriceHtml}</span>`;
                }
                document.getElementById('realTimeMarketPrice').innerHTML = marketPriceHtml;
                document.getElementById('realTimeMarketChange').textContent = `${dataPoint.marketValue !== null ? dataPoint.marketValue.toFixed(2) : '--'}%`;
            } else {
                document.getElementById('realTimeMarketPrice').textContent = 'ç„¡æ•¸æ“š';
                document.getElementById('realTimeMarketChange').textContent = '--';
            }
            
            // é¡¯ç¤ºå€‹è‚¡æ—¥æ¼²è·Œ
            const stockDailyChangeElement = document.getElementById('realTimeStockDailyChange');
            if (dataPoint.stockDailyChange !== null && dataPoint.stockDailyChange !== undefined) {
                const changeValue = parseFloat(dataPoint.stockDailyChange);
                if (changeValue > 0) {
                    stockDailyChangeElement.innerHTML = `<span style="color: #ff6b6b; font-weight: bold; font-size: 1.0rem;">+${changeValue.toFixed(2)}%</span>`;
                } else if (changeValue < 0) {
                    stockDailyChangeElement.innerHTML = `<span style="color: #51cf66; font-weight: bold; font-size: 1.0rem;">${changeValue.toFixed(2)}%</span>`;
                } else {
                    stockDailyChangeElement.innerHTML = `<span style="font-size: 1.0rem;">${changeValue.toFixed(2)}%</span>`;
                }
            } else {
                stockDailyChangeElement.innerHTML = `<span style="color: #a8b5ca; font-size: 1.0rem;">--</span>`;
            }
            
            // é¡¯ç¤ºå¤§ç›¤æ—¥æ¼²è·Œ
            const marketDailyChangeElement = document.getElementById('realTimeMarketDailyChange');
            if (dataPoint.marketDailyChange !== null && dataPoint.marketDailyChange !== undefined) {
                const changeValue = parseFloat(dataPoint.marketDailyChange);
                if (changeValue > 0) {
                    marketDailyChangeElement.innerHTML = `<span style="color: #ff6b6b; font-weight: bold; font-size: 1.0rem;">+${changeValue.toFixed(2)}%</span>`;
                } else if (changeValue < 0) {
                    marketDailyChangeElement.innerHTML = `<span style="color: #51cf66; font-weight: bold; font-size: 1.0rem;">${changeValue.toFixed(2)}%</span>`;
                } else {
                    marketDailyChangeElement.innerHTML = `<span style="font-size: 1.0rem;">${changeValue.toFixed(2)}%</span>`;
                }
            } else {
                marketDailyChangeElement.innerHTML = `<span style="color: #a8b5ca; font-size: 1.0rem;">--</span>`;
            }
            
            // é¡¯ç¤ºç›¸å°å¼·å¼±
            const relativeElement = document.getElementById('realTimeRelativeStrength');
            if (dataPoint.stockValue !== null && dataPoint.marketValue !== null && 
                !isNaN(dataPoint.stockValue) && !isNaN(dataPoint.marketValue)) {
                const rs = (dataPoint.stockValue - dataPoint.marketValue).toFixed(2);
                if (parseFloat(rs) > 0) {
                    relativeElement.innerHTML = `<span style="color: #ff6b6b; font-weight: bold; font-size: 1.0rem;">+${rs}%</span>`;
                } else if (parseFloat(rs) < 0) {
                    relativeElement.innerHTML = `<span style="color: #51cf66; font-weight: bold; font-size: 1.0rem;">${rs}%</span>`;
                } else {
                    relativeElement.innerHTML = `<span style="font-size: 1.0rem;">${rs}%</span>`;
                }
            } else {
                relativeElement.innerHTML = `<span style="color: #a8b5ca; font-size: 1.0rem;">æ•¸æ“šä¸å…¨</span>`;
            }
            
            // è¨ˆç®—ä½ç½®ï¼ˆæ”¹é€²çš„è‡ªé©æ‡‰é‚è¼¯ï¼‰
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // å…ˆé¡¯ç¤ºè¦–çª—ä»¥ç²å–å¯¦éš›å°ºå¯¸
            realTimeDisplay.style.visibility = 'visible';
            const infoRect = realTimeDisplay.getBoundingClientRect();
            
            // è¨ˆç®—è¦–çª—é‚Šç·£çš„å®‰å…¨è·é›¢ï¼ˆæ ¹æ“šå±å¹•å°ºå¯¸å‹•æ…‹èª¿æ•´ï¼‰
            const edgePadding = Math.min(20, windowWidth * 0.05); // 5%çš„å±å¹•å¯¬åº¦ï¼Œæœ€å¤§20px
            const minDistanceFromEdge = edgePadding;
            
            // æ ¹æ“šå±å¹•å°ºå¯¸èª¿æ•´æµ®å‹•è¦–çª—ä½ç½®
            let left, top;
            
            // ç¢ºå®šæµ®å‹•è¦–çª—æ‡‰è©²é¡¯ç¤ºåœ¨é¼ æ¨™/è§¸æ‘¸é»çš„å“ªä¸€å´
            const shouldPlaceOnLeft = clientX > windowWidth / 2;
            const shouldPlaceOnTop = clientY > windowHeight / 2;
            
            if (shouldPlaceOnLeft) {
                // é¡¯ç¤ºåœ¨å·¦å´
                left = clientX - infoRect.width - 20;
            } else {
                // é¡¯ç¤ºåœ¨å³å´
                left = clientX + 20;
            }
            
            if (shouldPlaceOnTop) {
                // é¡¯ç¤ºåœ¨ä¸Šæ–¹
                top = clientY - infoRect.height - 20;
            } else {
                // é¡¯ç¤ºåœ¨ä¸‹æ–¹
                top = clientY + 20;
            }
            
            // ç¢ºä¿ä¸è¶…å‡ºå±å¹•é‚Šç•Œ
            left = Math.max(minDistanceFromEdge, Math.min(left, windowWidth - infoRect.width - minDistanceFromEdge));
            top = Math.max(minDistanceFromEdge, Math.min(top, windowHeight - infoRect.height - minDistanceFromEdge));
            
            // å¼·åˆ¶è¨­ç½®ä½ç½®å’Œæ¨£å¼
            realTimeDisplay.style.position = 'fixed';
            realTimeDisplay.style.left = `${left}px`;
            realTimeDisplay.style.top = `${top}px`;
            realTimeDisplay.style.zIndex = '10000';
            realTimeDisplay.style.opacity = '0.98';
            realTimeDisplay.style.pointerEvents = 'none';
            
            // ç¢ºä¿æµ®å‹•è¦–çª—å…§å®¹ä¸æœƒè¢«æˆªæ–·
            realTimeDisplay.style.overflow = 'visible';
            realTimeDisplay.style.whiteSpace = 'nowrap';
        }
        
        // ä¿®æ”¹ï¼šcreateComparisonChart å‡½æ•¸ï¼Œç¢ºä¿å°ˆæ¥­åˆ†ææŒ‰éˆ•æ­£ç¢ºé¡¯ç¤º
        function createComparisonChart(chartData, stockCode, stockName) {
            const ctx = document.getElementById('marketComparisonChart').getContext('2d');
            if (chartInstance) { chartInstance.destroy(); }
            document.getElementById('chartLoading').style.display = 'none';
            chartDates = chartData.dates;
            stockChartData = chartData.stockData;
            marketChartData = chartData.marketData;
            currentStockCode = stockCode;
            currentStockName = stockName || `è‚¡ç¥¨${stockCode}`;
            chartDataPoints = [];
            
            for (let i = 0; i < chartDates.length; i++) {
                const stockPrice = chartData.stockPrices[i];
                const marketPrice = chartData.marketPrices[i];
                // æª¢æŸ¥åƒ¹æ ¼æ˜¯å¦æœ‰æ•ˆï¼ˆä¸ç‚ºnullä¸”å¤§æ–¼0ï¼‰
                const validStockPrice = stockPrice !== null && stockPrice > 0;
                const validMarketPrice = marketPrice !== null && marketPrice > 0;
                
                // è¨ˆç®—æ—¥æ¼²è·Œå¹…
                let stockDailyChange = null;
                let marketDailyChange = null;
                if (i > 0) {
                    const prevStockPrice = chartData.stockPrices[i-1];
                    const prevMarketPrice = chartData.marketPrices[i-1];
                    const validPrevStockPrice = prevStockPrice !== null && prevStockPrice > 0;
                    const validPrevMarketPrice = prevMarketPrice !== null && prevMarketPrice > 0;
                    
                    if (validStockPrice && validPrevStockPrice) {
                        stockDailyChange = ((stockPrice - prevStockPrice) / prevStockPrice * 100).toFixed(2);
                    }
                    if (validMarketPrice && validPrevMarketPrice) {
                        marketDailyChange = ((marketPrice - prevMarketPrice) / prevMarketPrice * 100).toFixed(2);
                    }
                }
                
                chartDataPoints.push({
                    date: chartDates[i],
                    stockValue: stockChartData[i],
                    marketValue: marketChartData[i],
                    stockPrice: stockPrice,
                    marketPrice: marketPrice,
                    stockDailyChange: stockDailyChange,
                    marketDailyChange: marketDailyChange,
                    relativeStrength: (stockChartData[i] - marketChartData[i]).toFixed(2)
                });
            }
            
            // æ›´æ–°æµ®å‹•è¦–çª—çš„è‚¡ç¥¨åç¨±æ¨™ç±¤
            document.getElementById('realTimeStockLabel').textContent = 'å€‹è‚¡åƒ¹æ ¼';
            document.getElementById('realTimeMarketLabel').textContent = 'å¤§ç›¤æŒ‡æ•¸';
            
            const processedStockData = stockChartData.map(val => val === null || isNaN(val) ? NaN : val);
            const processedMarketData = marketChartData.map(val => val === null || isNaN(val) ? NaN : val);
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartDates,
                    datasets: [
                        {
                            label: 'å€‹è‚¡èµ°å‹¢(%)', data: processedStockData, borderColor: '#ff6b6b', backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 0, pointBackgroundColor: '#ff6b6b',
                            borderJoinStyle: 'round', cubicInterpolationMode: 'monotone', spanGaps: true
                        },
                        {
                            label: 'å¤§ç›¤æŒ‡æ•¸(%)', data: processedMarketData, borderColor: '#51cf66', backgroundColor: 'rgba(81, 207, 102, 0.1)',
                            borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 0,
                            borderJoinStyle: 'round', cubicInterpolationMode: 'monotone', spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    interaction: { 
                        mode: 'index', 
                        intersect: false, 
                        axis: 'x' 
                    },
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        tooltip: {
                            enabled: false, // å®Œå…¨ç¦ç”¨Chart.jsåŸç”Ÿå·¥å…·æç¤º
                            mode: 'index', 
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a8b5ca', maxRotation: 45, minRotation: 45 }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: {
                                color: '#a8b5ca',
                                callback: function(value) { return value + '%'; }
                            },
                            title: { display: true, text: 'ç™¾åˆ†æ¯”è®ŠåŒ–(%)', color: '#d4b97a' }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 0, // ç¦ç”¨hoveræ™‚é»çš„æ”¾å¤§æ•ˆæœ
                            radius: 0 // å®Œå…¨éš±è—æ•¸æ“šé»
                        }
                    }
                }
            });
            
            // ä¿®æ”¹ï¼šç¢ºä¿å°ˆæ¥­åˆ†ææŒ‰éˆ•æ­£ç¢ºé¡¯ç¤º
            const analysisBtn = document.getElementById('professionalAnalysisBtn');
            if (analysisBtn) {
                analysisBtn.style.display = 'flex';
                analysisBtn.style.visibility = 'visible';
                analysisBtn.style.opacity = '1';
                analysisBtn.classList.remove('hidden');
            }
            
            setTimeout(() => { setupChartInteractions(); }, 100);
            document.getElementById('chartLegend').style.display = 'flex';
        }
        
        // ä¿®æ”¹ï¼šæ·»åŠ è§¸æ§äº‹ä»¶æ”¯æŒ
        function setupChartInteractions() {
            const chartCanvas = document.getElementById('marketComparisonChart');
            const verticalLine = document.getElementById('chartVerticalLine');
            const realTimeDisplay = document.getElementById('realTimeDataDisplay');
            
            if (!chartCanvas || !realTimeDisplay) { 
                console.error('åœ–è¡¨æˆ–æµ®å‹•è¦–çª—å…ƒç´ æœªæ‰¾åˆ°');
                return; 
            }
            
            verticalLine.style.display = 'none';
            realTimeDisplay.style.display = 'none';
            
            // æª¢æ¸¬æ˜¯å¦ç‚ºè§¸æ§è¨­å‚™
            const isTouchDevice = 'ontouchstart' in window || 
                                 navigator.maxTouchPoints > 0 || 
                                 navigator.msMaxTouchPoints > 0;
            
            // é¼ æ¨™äº‹ä»¶è™•ç†
            chartCanvas.addEventListener('mousemove', function(event) {
                if (isTouchDevice) return; // è§¸æ§è¨­å‚™ä¸ä½¿ç”¨é¼ æ¨™äº‹ä»¶
                
                const chartRect = chartCanvas.getBoundingClientRect();
                const mouseX = event.clientX - chartRect.left;
                const mouseY = event.clientY - chartRect.top;
                
                if (mouseX < 0 || mouseX > chartRect.width || mouseY < 0 || mouseY > chartRect.height) {
                    hideChartHoverInfo();
                    return;
                }
                
                if (!chartInstance || !chartDataPoints || chartDataPoints.length === 0) {
                    hideChartHoverInfo();
                    return;
                }
                
                const index = getNearestDataPointIndex(mouseX, chartInstance, chartDataPoints);
                
                if (index === -1 || index >= chartDataPoints.length) {
                    hideChartHoverInfo();
                    return;
                }
                
                const dataPoint = chartDataPoints[index];
                
                if (!dataPoint) {
                    hideChartHoverInfo();
                    return;
                }
                
                if (verticalLine) {
                    verticalLine.style.left = `${mouseX}px`;
                    verticalLine.style.display = 'block';
                }
                
                // ç¢ºä¿æµ®å‹•è¦–çª—é¡¯ç¤º
                if (realTimeDisplay) {
                    realTimeDisplay.classList.add('show');
                    updateRealTimeDataDisplay(dataPoint, index, event.clientX, event.clientY);
                }
            });
            
            // è§¸æ§äº‹ä»¶è™•ç†
            if (isTouchDevice) {
                let isTouching = false;
                let lastTouchX = 0;
                let lastTouchY = 0;
                
                chartCanvas.addEventListener('touchstart', function(event) {
                    event.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹•
                    isTouching = true;
                    
                    const touch = event.touches[0];
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                    
                    handleTouchMove(touch);
                }, { passive: false });
                
                chartCanvas.addEventListener('touchmove', function(event) {
                    event.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹•
                    
                    if (!isTouching) return;
                    
                    const touch = event.touches[0];
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                    
                    handleTouchMove(touch);
                }, { passive: false });
                
                chartCanvas.addEventListener('touchend', function() {
                    isTouching = false;
                    setTimeout(() => {
                        hideChartHoverInfo();
                    }, 300); // çŸ­æš«å»¶é²å¾Œéš±è—
                });
                
                chartCanvas.addEventListener('touchcancel', function() {
                    isTouching = false;
                    hideChartHoverInfo();
                });
                
                function handleTouchMove(touch) {
                    const chartRect = chartCanvas.getBoundingClientRect();
                    const touchX = touch.clientX - chartRect.left;
                    const touchY = touch.clientY - chartRect.top;
                    
                    if (touchX < 0 || touchX > chartRect.width || touchY < 0 || touchY > chartRect.height) {
                        hideChartHoverInfo();
                        return;
                    }
                    
                    if (!chartInstance || !chartDataPoints || chartDataPoints.length === 0) {
                        hideChartHoverInfo();
                        return;
                    }
                    
                    const index = getNearestDataPointIndexForTouch(touch.clientX, chartInstance, chartDataPoints);
                    
                    if (index === -1 || index >= chartDataPoints.length) {
                        hideChartHoverInfo();
                        return;
                    }
                    
                    const dataPoint = chartDataPoints[index];
                    
                    if (!dataPoint) {
                        hideChartHoverInfo();
                        return;
                    }
                    
                    if (verticalLine) {
                        verticalLine.style.left = `${touchX}px`;
                        verticalLine.style.display = 'block';
                    }
                    
                    // ç¢ºä¿æµ®å‹•è¦–çª—é¡¯ç¤º
                    if (realTimeDisplay) {
                        realTimeDisplay.classList.add('show');
                        updateRealTimeDataDisplay(dataPoint, index, touch.clientX, touch.clientY);
                    }
                }
            }
            
            chartCanvas.addEventListener('mouseleave', function() { 
                if (!isTouchDevice) {
                    hideChartHoverInfo(); 
                }
            });
            
            chartCanvas.addEventListener('click', function(event) { 
                event.stopPropagation(); 
            });
        }
        
        function hideChartHoverInfo() {
            const verticalLine = document.getElementById('chartVerticalLine');
            const realTimeDisplay = document.getElementById('realTimeDataDisplay');
            if (verticalLine) verticalLine.style.display = 'none';
            if (realTimeDisplay) {
                realTimeDisplay.classList.remove('show');
                realTimeDisplay.style.display = 'none';
                realTimeDisplay.style.visibility = 'hidden';
            }
        }
        
        async function showMarketComparisonCalendar() {
            const stockCode = document.getElementById('stockCode').value.trim();
            const startRaw = document.getElementById('startDate').value;
            const endRaw = document.getElementById('endDate').value;
            const historicalPricesInput = document.getElementById('historicalPrices').value.trim();
            
            if (!stockCode) { alert('è«‹å…ˆé¸æ“‡è‚¡ç¥¨ä¸¦æŠ“å–æ­·å²æ•¸æ“š'); return; }
            if (!startRaw || !endRaw) { alert('è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸ'); return; }
            if (!historicalPricesInput) { alert('è«‹å…ˆæŠ“å–æ­·å²æ”¶ç›¤åƒ¹'); return; }
            
            const start = new Date(startRaw);
            const end = new Date(endRaw);
            if (start > end) { alert('é–‹å§‹æ—¥æœŸä¸å¯æ™šæ–¼çµæŸæ—¥æœŸ'); return; }
            
            const stockName = getStockNameByCode(stockCode);
            const chartContainer = document.getElementById('marketChartContainer');
            chartContainer.classList.add('show');
            document.getElementById('chartLoading').style.display = 'flex';
            document.getElementById('chartLoading').innerHTML = `<div class="loading-spinner"></div><span>æ­£åœ¨è¼‰å…¥æœˆæ›†æ•¸æ“š...</span>`;
            document.getElementById('professionalAnalysisTable').classList.remove('show');
            document.getElementById('professionalAnalysisBtn').classList.remove('expanded');
            
            try {
                const calendarResult = await prepareCalendarData(stockCode, start, end, historicalPricesInput);
                calendarData = calendarResult.data;
                selectedDates.clear(); // æ¸…é™¤ä»»ä½•ä¹‹å‰çš„é€‰æ‹©
                
                // è‡ªå‹•å…¨é¸æ‰€æœ‰æœ‰æ•ˆäº¤æ˜“æ—¥
                Object.keys(calendarData).forEach(dateStr => {
                    const dayData = calendarData[dateStr];
                    if (dayData.isTradingDay) {
                        selectedDates.add(dateStr);
                        dayData.selected = true;
                    }
                });
                
                currentCalendarYear = start.getFullYear();
                currentCalendarMonth = start.getMonth();
                updateDateRangeDisplay(start, end);
                renderCalendar(currentCalendarYear, currentCalendarMonth);
                document.getElementById('chartLoading').innerHTML = `<div class="loading-spinner"></div><span>è«‹é¸æ“‡åŠŸèƒ½æŒ‰éˆ•</span>`;
                setupCalendarEventListeners();
                chartContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                console.error('è¼‰å…¥æœˆæ›†æ•¸æ“šå¤±æ•—:', error);
                document.getElementById('chartLoading').innerHTML = `<div style="color: #ff6b6b;">âŒ è¼‰å…¥æœˆæ›†æ•¸æ“šå¤±æ•—: ${error.message}</div>`;
            }
        }
        
        function hideMarketComparisonChart() {
            const chartContainer = document.getElementById('marketChartContainer');
            chartContainer.classList.remove('show');
            calendarData = {};
            selectedDates.clear();
            currentCalendarYear = new Date().getFullYear();
            currentCalendarMonth = new Date().getMonth();
            document.getElementById('chartLoading').style.display = 'flex';
            document.getElementById('chartLoading').innerHTML = `<div class="loading-spinner"></div><span>è«‹é¸æ“‡åŠŸèƒ½æŒ‰éˆ•</span>`;
            hideChartHoverInfo();
            
            // ä¿®æ”¹ï¼šéš±è—å°ˆæ¥­åˆ†ææŒ‰éˆ•
            const analysisBtn = document.getElementById('professionalAnalysisBtn');
            if (analysisBtn) {
                analysisBtn.classList.add('hidden');
            }
            
            document.getElementById('professionalAnalysisTable').classList.remove('show');
            document.getElementById('professionalAnalysisBtn').classList.remove('expanded');
            document.getElementById('chartLegend').style.display = 'none';
        }
        
        // ä¿®æ”¹ï¼šsetupProfessionalAnalysisButton å‡½æ•¸ï¼Œç¢ºä¿æŒ‰éˆ•æ­£ç¢ºé¡¯ç¤ºå’Œäº‹ä»¶ç¶å®š
        function setupProfessionalAnalysisButton() {
            const analysisBtn = document.getElementById('professionalAnalysisBtn');
            const analysisTable = document.getElementById('professionalAnalysisTable');
            
            if (analysisBtn && analysisTable) {
                // ç¢ºä¿æŒ‰éˆ•é¡¯ç¤º
                analysisBtn.style.display = 'flex';
                analysisBtn.style.visibility = 'visible';
                analysisBtn.style.opacity = '1';
                analysisBtn.classList.remove('hidden');
                
                // ç§»é™¤ç¾æœ‰çš„é»æ“Šäº‹ä»¶ï¼ˆé¿å…é‡è¤‡ç¶å®šï¼‰
                const newBtn = analysisBtn.cloneNode(true);
                analysisBtn.parentNode.replaceChild(newBtn, analysisBtn);
                
                // é‡æ–°ç²å–å…ƒç´ ä¸¦ç¶å®šäº‹ä»¶
                const newAnalysisBtn = document.getElementById('professionalAnalysisBtn');
                newAnalysisBtn.addEventListener('click', function() {
                    this.classList.toggle('expanded');
                    if (analysisTable.classList.contains('show')) {
                        analysisTable.classList.remove('show');
                    } else {
                        analysisTable.classList.add('show');
                    }
                });
            }
        }
        
        function updateAnalysisResult() {
            const stockMovement = document.getElementById('stockMovement').value;
            const marketMovement = document.getElementById('marketMovement').value;
            const resultDiv = document.getElementById('analysisResult');
            
            // ç²å–é¸é …æ–‡æœ¬
            const stockText = document.getElementById('stockMovement').options[document.getElementById('stockMovement').selectedIndex].text;
            const marketText = document.getElementById('marketMovement').options[document.getElementById('marketMovement').selectedIndex].text;
            
            // æ§‹å»ºæƒ…å¢ƒéµ
            let scenarioKey = '';
            if (stockMovement === 'big_up' && marketMovement === 'small_up') {
                scenarioKey = 'big_up_small_up';
            } else if (stockMovement === 'medium_up' && marketMovement === 'medium_up') {
                scenarioKey = 'medium_up_medium_up';
            } else if (stockMovement.includes('up') && marketMovement.includes('down')) {
                scenarioKey = 'up_down';
            } else if (stockMovement === 'big_down' && marketMovement === 'small_down') {
                scenarioKey = 'big_down_small_down';
            } else if (stockMovement === 'big_up' && marketMovement === 'medium_up') {
                scenarioKey = 'big_up_medium_up';
            } else if (stockMovement === 'small_up' && marketMovement === 'big_up') {
                scenarioKey = 'small_up_big_up';
            } else if (stockMovement === 'big_down' && marketMovement === 'medium_down') {
                scenarioKey = 'big_down_medium_down';
            } else if (stockMovement === 'medium_down' && marketMovement === 'small_down') {
                scenarioKey = 'medium_down_small_down';
            }
            
            let advice = analysisScenarios[scenarioKey] || 'æ­¤çµ„åˆæƒ…æ³éœ€é€²ä¸€æ­¥åˆ†æï¼Œå»ºè­°ç¶œåˆè€ƒæ…®å…¶ä»–æŠ€è¡“æŒ‡æ¨™èˆ‡åŸºæœ¬é¢å› ç´ ã€‚';
            
            resultDiv.innerHTML = `
                <strong>åˆ†æçµæœï¼š</strong><br><br>
                <strong>å€‹è‚¡èµ°å‹¢ï¼š</strong> ${stockText}<br>
                <strong>å¤§ç›¤èµ°å‹¢ï¼š</strong> ${marketText}<br><br>
                <strong>å°ˆæ¥­åˆ†æå¸«åˆ¤æ–·æŠ€å·§ï¼š</strong><br>
                ${advice}
            `;
        }
        
        // ä¿®æ”¹ï¼šé»æ“Šã€Œäº¤æ˜“æ—¥æ›†ã€æŒ‰éˆ•çš„é‚è¼¯
        document.getElementById('calendarToggleBtn').addEventListener('click', function() {
            const calendarSection = document.getElementById('marketCalendarSection');
            const chartWrapper = document.getElementById('chartWrapper');
            const chartLegend = document.getElementById('chartLegend');
            
            // å…ˆéš±è—åœ–è¡¨
            chartWrapper.style.display = 'none';
            chartLegend.style.display = 'none';
            document.getElementById('chartToggleBtn').classList.remove('active');
            
            // åˆ‡æ›æ—¥æ›†é¡¯ç¤º
            if (calendarSection.classList.contains('show')) {
                calendarSection.classList.remove('show');
                this.classList.remove('active');
            } else {
                calendarSection.classList.add('show');
                this.classList.add('active');
            }
        });
        
        // ä¿®æ”¹ï¼šé»æ“Šã€Œæ›²ç·šåœ–è¡¨ã€æŒ‰éˆ•çš„é‚è¼¯
        document.getElementById('chartToggleBtn').addEventListener('click', async function() {
            const chartWrapper = document.getElementById('chartWrapper');
            const chartLegend = document.getElementById('chartLegend');
            const calendarSection = document.getElementById('marketCalendarSection');
            
            // æª¢æŸ¥æ˜¯å¦ç•¶å‰å·²ç¶“æ˜¯åœ–è¡¨é¡¯ç¤ºç‹€æ…‹
            const isChartVisible = chartWrapper.style.display === 'block';
            
            if (isChartVisible) {
                // å¦‚æœåœ–è¡¨å·²ç¶“é¡¯ç¤ºï¼Œå‰‡éš±è—åœ–è¡¨å€åŸŸå’Œæµ®å‹•è¦–çª—
                chartWrapper.style.display = 'none';
                chartLegend.style.display = 'none';
                this.classList.remove('active');
                hideChartHoverInfo(); // éš±è—æµ®å‹•è¦–çª—
            } else {
                // å…ˆéš±è—æ—¥æ›†
                calendarSection.classList.remove('show');
                document.getElementById('calendarToggleBtn').classList.remove('active');
                
                // é¡¯ç¤ºåœ–è¡¨å€åŸŸ
                chartWrapper.style.display = 'block';
                chartLegend.style.display = 'flex';
                this.classList.add('active');
                
                // æº–å‚™æ•¸æ“šä¸¦ç”Ÿæˆåœ–è¡¨
                const stockCode = document.getElementById('stockCode').value.trim();
                const startRaw = document.getElementById('startDate').value;
                const endRaw = document.getElementById('endDate').value;
                const historicalPricesInput = document.getElementById('historicalPrices').value.trim();
                
                if (!stockCode || !startRaw || !endRaw || !historicalPricesInput) {
                    alert('è«‹å…ˆé¸æ“‡è‚¡ç¥¨ä¸¦æŠ“å–æ­·å²æ•¸æ“š');
                    chartWrapper.style.display = 'none';
                    chartLegend.style.display = 'none';
                    this.classList.remove('active');
                    return;
                }
                
                try {
                    // é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹
                    document.getElementById('chartLoading').style.display = 'flex';
                    document.getElementById('chartLoading').innerHTML = `<div class="loading-spinner"></div><span>æ­£åœ¨ç”Ÿæˆå°æ¯”åœ–è¡¨...</span>`;
                    
                    // æº–å‚™æ—¥æ›†æ•¸æ“š
                    const calendarResult = await prepareCalendarData(stockCode, new Date(startRaw), new Date(endRaw), historicalPricesInput);
                    calendarData = calendarResult.data;
                    
                    // è‡ªå‹•å…¨é¸æ‰€æœ‰æœ‰æ•ˆäº¤æ˜“æ—¥
                    selectedDates.clear();
                    Object.keys(calendarData).forEach(dateStr => {
                        const dayData = calendarData[dateStr];
                        if (dayData.isTradingDay) {
                            selectedDates.add(dateStr);
                            dayData.selected = true;
                        }
                    });
                    
                    // æº–å‚™åœ–è¡¨æ•¸æ“š
                    const chartData = prepareChartDataFromSelectedDates();
                    if (chartData) {
                        const stockName = getStockNameByCode(stockCode);
                        setTimeout(() => { 
                            createComparisonChart(chartData, stockCode, stockName); 
                            
                            // ä¿®æ”¹ï¼šç¢ºä¿å°ˆæ¥­åˆ†ææŒ‰éˆ•é¡¯ç¤º
                            const analysisBtn = document.getElementById('professionalAnalysisBtn');
                            if (analysisBtn) {
                                analysisBtn.style.display = 'flex';
                                analysisBtn.style.visibility = 'visible';
                                analysisBtn.style.opacity = '1';
                                analysisBtn.classList.remove('hidden');
                            }
                        }, 100);
                    } else {
                        document.getElementById('chartLoading').innerHTML = `<div style="color: #ff6b6b;">âŒ ç„¡æ³•ç”Ÿæˆåœ–è¡¨ï¼Œè«‹æª¢æŸ¥æ•¸æ“š</div>`;
                    }
                } catch (error) {
                    console.error('ç”Ÿæˆåœ–è¡¨å¤±æ•—:', error);
                    document.getElementById('chartLoading').innerHTML = `<div style="color: #ff6b6b;">âŒ ç”Ÿæˆåœ–è¡¨å¤±æ•—: ${error.message}</div>`;
                }
            }
        });
        
        document.getElementById('aiQueryBtn').addEventListener('click', function() {
            const section = document.getElementById('aiQuerySection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            const stockCode = document.getElementById('stockCode').value.trim();
            if (stockCode) {
                const stockName = getStockNameByCode(stockCode);
                const stockInfo = stockName ? `${stockName}${stockCode}` : `è‚¡ç¥¨${stockCode}`;
                const currentPrompt = document.getElementById('queryInput').value;
                if (!currentPrompt || currentPrompt.includes('è³‡æ·±è‚¡ç¥¨åˆ†æå¸«') || currentPrompt.includes('åˆ†æ"') || currentPrompt.trim() === '') {
                    const defaultPrompt = `ä½ æ˜¯è³‡æ·±è‚¡ç¥¨åˆ†æå¸«ï¼Œåˆ†æ"${stockInfo}"çš„è‚¡åƒ¹è¶¨å‹¢ï¼Œåšå‡ºä¸å°‘æ–¼å…­å€‹é‡é»æ•´ç†çµ¦æˆ‘ï¼ŒæŒ‰ç…§-30ï½+30çš„å€é–“åšå‡ºç¸½è©•åˆ†`;
                    document.getElementById('queryInput').value = defaultPrompt;
                }
            }
        });
        
        document.getElementById('aiPlatform').addEventListener('change', function() {
            const platform = this.value;
            const apiKeySection = document.getElementById('apiKeySection');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const statusEl = document.getElementById('apiStatus');
            updateApiKeyLink(platform);
            if (platform) {
                apiKeySection.style.display = 'block';
                const storedKey = getDecryptedApiKey(platform);
                if (storedKey) {
                    apiKeyInput.type = 'password';
                    apiKeyInput.value = '********';
                    statusEl.style.display = 'block';
                    statusEl.className = 'api-status success';
                    statusEl.textContent = 'âœ“ å·²è¼‰å…¥å„²å­˜çš„ API Key';
                    document.getElementById('querySubmitBtn').disabled = false;
                    autoFillDefaultPrompt();
                } else {
                    apiKeyInput.type = 'text';
                    apiKeyInput.value = '';
                    statusEl.style.display = 'none';
                    document.getElementById('querySubmitBtn').disabled = true;
                }
            } else {
                apiKeySection.style.display = 'none';
                document.getElementById('querySubmitBtn').disabled = true;
            }
        });
        
        document.getElementById('apiVerifyBtn').addEventListener('click', async function() {
            const platform = document.getElementById('aiPlatform').value;
            const apiKeyInput = document.getElementById('apiKeyInput');
            let apiKey = apiKeyInput.value.trim();
            if (apiKey === '********') { apiKey = getDecryptedApiKey(platform) || ''; }
            if (!platform) { alert('è«‹å…ˆé¸æ“‡ AI å¹³å°'); return; }
            if (!apiKey) { alert('è«‹è¼¸å…¥ API Key'); return; }
            this.disabled = true;
            this.textContent = 'é©—è­‰ä¸­...';
            await verifyApiKey(platform, apiKey);
            this.disabled = false;
            this.textContent = 'é€£ç·šé©—è­‰/å„²å­˜';
        });
        
        document.getElementById('querySubmitBtn').addEventListener('click', async function() {
            const platform = document.getElementById('aiPlatform').value;
            const apiKey = getDecryptedApiKey(platform);
            const query = document.getElementById('queryInput').value.trim();
            if (!query) { alert('è«‹è¼¸å…¥æ‚¨çš„æå•'); return; }
            this.disabled = true;
            this.textContent = 'æŸ¥è©¢ä¸­...';
            await queryAI(platform, apiKey, query);
            this.disabled = false;
            this.textContent = 'ç¢ºèªæŸ¥è©¢';
        });
        
        document.getElementById('marketCompareBtn').addEventListener('click', function() {
            const chartContainer = document.getElementById('marketChartContainer');
            if (chartContainer.classList.contains('show')) { 
                hideMarketComparisonChart(); 
            } else { 
                showMarketComparisonCalendar(); 
            }
        });
        
        document.getElementById('stockMovement').addEventListener('change', updateAnalysisResult);
        document.getElementById('marketMovement').addEventListener('change', updateAnalysisResult);
        
        const ProfessionalPriceCalculator = {
            calculateMA: function(prices, period) {
                if (prices.length < period) return [];
                const ma = [];
                for (let i = period - 1; i < prices.length; i++) {
                    const sum = prices.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    ma.push(sum / period);
                }
                return ma;
            },
            calculateFibonacciSupport: function(high, low) {
                const range = high - low;
                return {
                    level_38: high - range * 0.382,
                    level_50: high - range * 0.5,
                    level_61: high - range * 0.618,
                    level_78: high - range * 0.786
                };
            },
            calculateFibonacciResistance: function(high, low) {
                const range = high - low;
                return {
                    level_127: high + range * 0.272,
                    level_138: high + range * 0.382,
                    level_161: high + range * 0.618,
                    level_200: high + range * 1.0
                };
            },
            calculateATR: function(prices, highPrices, lowPrices, period = 14) {
                if (prices.length < period || highPrices.length < period || lowPrices.length < period) { return 0; }
                const trueRanges = [];
                for (let i = 1; i < prices.length; i++) {
                    const high = highPrices[i];
                    const low = lowPrices[i];
                    const prevClose = prices[i - 1];
                    const tr1 = high - low;
                    const tr2 = Math.abs(high - prevClose);
                    const tr3 = Math.abs(low - prevClose);
                    trueRanges.push(Math.max(tr1, tr2, tr3));
                }
                let atr = 0;
                for (let i = 0; i < period; i++) { atr += trueRanges[i] || 0; }
                atr /= period;
                return atr;
            },
            calculateBollingerBands: function(prices, period = 20, stdDev = 2) {
                if (prices.length < period) return null;
                const ma = this.calculateMA(prices, period);
                const bands = [];
                for (let i = period - 1; i < prices.length; i++) {
                    const slice = prices.slice(i - period + 1, i + 1);
                    const sliceMA = ma[i - period + 1];
                    const variance = slice.reduce((sum, price) => { return sum + Math.pow(price - sliceMA, 2); }, 0) / period;
                    const std = Math.sqrt(variance);
                    bands.push({ upper: sliceMA + std * stdDev, middle: sliceMA, lower: sliceMA - std * stdDev });
                }
                return bands;
            },
            
            // ä¿®æ”¹ï¼šä½¿ç”¨å°ˆæ¥­ç®—æ³•è¨ˆç®—è²·å…¥åƒ¹
            calculateProfessionalBuyPrice: function(currentPrice, historicalPrices, monthlyVolatility, rsi, marketTrend, score) {
                // å–æœ€è¿‘30å¤©æ•¸æ“š
                const recentPrices = historicalPrices.slice(-30);
                if (recentPrices.length < 20) { 
                    return { 
                        price: currentPrice * 0.95, 
                        method: "æ•¸æ“šä¸è¶³,ä½¿ç”¨ä¿å®ˆè¨ˆç®—(ç•¶å‰åƒ¹ä¸‹èª¿5%)", 
                        adjustment: "ç„¡",
                        useDefault: true
                    }; 
                }
                
                // 1. è¨ˆç®—30æ—¥ç§»å‹•å¹³å‡ç·š
                const ma30 = this.calculateMA(recentPrices, Math.min(30, recentPrices.length));
                const currentMA30 = ma30.length > 0 ? ma30[ma30.length - 1] : null;
                
                // 2. è¨ˆç®—å¸ƒæ—å¸¶
                const bollingerBands = this.calculateBollingerBands(recentPrices, 20, 2);
                const currentBollingerLower = bollingerBands ? bollingerBands[bollingerBands.length - 1].lower : null;
                
                // 3. è¨ˆç®—æ–æ³¢é‚£å¥‘æ”¯æ’ä½
                const historicalHigh = Math.max(...recentPrices);
                const historicalLow = Math.min(...recentPrices);
                const fibSupport = this.calculateFibonacciSupport(historicalHigh, historicalLow);
                
                // 4. å°ˆæ¥­ç®—æ³•ç¶œåˆè¨ˆç®—
                let suggestedPrice;
                let method = "å°ˆæ¥­ç®—æ³•ç¶œåˆè¨ˆç®—ï¼š";
                
                // å„ªå…ˆä½¿ç”¨å¸ƒæ—å¸¶ä¸‹è»Œä½œç‚ºè²·å…¥é»
                if (currentBollingerLower && currentBollingerLower > 0) {
                    suggestedPrice = currentBollingerLower;
                    method += "å¸ƒæ—å¸¶ä¸‹è»Œ(20æ—¥å‡ç·š-2å€æ¨™æº–å·®)";
                }
                // æ¬¡é¸ä½¿ç”¨æ–æ³¢é‚£å¥‘61.8%æ”¯æ’
                else if (fibSupport.level_61 && fibSupport.level_61 > 0) {
                    suggestedPrice = fibSupport.level_61;
                    method += "æ–æ³¢é‚£å¥‘61.8%æ”¯æ’ä½";
                }
                // å†æ¬¡ä½¿ç”¨30æ—¥ç§»å‹•å¹³å‡ç·š
                else if (currentMA30 && currentMA30 > 0) {
                    suggestedPrice = currentMA30 * 0.98; // ç•¥ä½æ–¼MA30
                    method += "30æ—¥ç§»å‹•å¹³å‡ç·šä¸‹èª¿2%";
                }
                // æœ€å¾Œä½¿ç”¨ä¿å®ˆè¨ˆç®—
                else {
                    suggestedPrice = currentPrice * 0.95;
                    method += "ç•¶å‰åƒ¹æ ¼ä¸‹èª¿5%(ä¿å®ˆè¨ˆç®—)";
                    return {
                        price: suggestedPrice,
                        method: method,
                        adjustment: "ç„¡",
                        useDefault: true
                    };
                }
                
                // 5. æŠ€è¡“èª¿æ•´
                let techAdjustment = 0;
                if (rsi < 30) {
                    techAdjustment += 0.02; // RSIè¶…è³£ +2%
                    method += " + RSIè¶…è³£èª¿æ•´";
                }
                if (rsi > 70) {
                    techAdjustment -= 0.03; // RSIè¶…è²· -3%
                    method += " - RSIè¶…è²·èª¿æ•´";
                }
                
                // 6. å¸‚å ´è¶¨å‹¢èª¿æ•´
                let marketAdjustment = (marketTrend || 0) * 0.1;
                if (marketAdjustment !== 0) {
                    method += ` ${marketAdjustment > 0 ? '+' : ''}${(marketAdjustment*100).toFixed(1)}%å¸‚å ´è¶¨å‹¢`;
                }
                
                // 7. è©•åˆ†èª¿æ•´
                let scoreAdjustment = 0;
                if (score >= 80) {
                    scoreAdjustment += 0.02;
                    method += " + é«˜è©•åˆ†èª¿æ•´";
                } else if (score >= 65) {
                    scoreAdjustment += 0.01;
                    method += " + ä¸­è©•åˆ†èª¿æ•´";
                } else if (score <= 35) {
                    scoreAdjustment -= 0.02;
                    method += " - ä½è©•åˆ†èª¿æ•´";
                }
                
                // 8. è¨ˆç®—æœ€çµ‚åƒ¹æ ¼
                suggestedPrice = suggestedPrice * (1 + techAdjustment + marketAdjustment + scoreAdjustment);
                
                // 9. å®‰å…¨æª¢æŸ¥
                const minPrice = currentPrice * 0.85;
                const maxPrice = currentPrice * 1.05;
                suggestedPrice = Math.max(minPrice, Math.min(maxPrice, suggestedPrice));
                
                return {
                    price: suggestedPrice,
                    method: method,
                    adjustment: `æŠ€è¡“èª¿æ•´: ${(techAdjustment*100).toFixed(1)}%, å¸‚å ´èª¿æ•´: ${(marketAdjustment*100).toFixed(1)}%, è©•åˆ†èª¿æ•´: ${(scoreAdjustment*100).toFixed(1)}%`,
                    useDefault: false
                };
            },
            
            // ä¿®æ”¹ï¼šä½¿ç”¨å°ˆæ¥­ç®—æ³•è¨ˆç®—è³£å‡ºåƒ¹
            calculateProfessionalSellPrice: function(buyPrice, historicalPrices, monthlyVolatility, rsi, marketTrend, score) {
                // å–æœ€è¿‘30å¤©æ•¸æ“š
                const recentPrices = historicalPrices.slice(-30);
                if (recentPrices.length < 20) { 
                    return { 
                        price: buyPrice ? buyPrice * 1.10 : (recentPrices.length > 0 ? (recentPrices.reduce((a, b) => a + b, 0) / recentPrices.length) * 1.20 : 0),
                        method: "æ•¸æ“šä¸è¶³,ä½¿ç”¨ä¿å®ˆè¨ˆç®—",
                        adjustment: "ç„¡"
                    }; 
                }
                
                // 1. ç¢ºå®šè²·å…¥åƒ¹
                let actualBuyPrice = buyPrice;
                let useDefaultBuyPrice = false;
                if (!buyPrice || buyPrice <= 0) {
                    // ä½¿ç”¨30å¤©å‡åƒ¹ä¸Šèª¿5%ä½œç‚ºè™›æ“¬è²·å…¥åƒ¹
                    const historicalAvg = recentPrices.reduce((a, b) => a + b, 0) / recentPrices.length;
                    actualBuyPrice = historicalAvg * 1.05;
                    useDefaultBuyPrice = true;
                }
                
                // 2. è¨ˆç®—å¸ƒæ—å¸¶ä¸Šè»Œ
                const bollingerBands = this.calculateBollingerBands(recentPrices, 20, 2);
                const currentBollingerUpper = bollingerBands ? bollingerBands[bollingerBands.length - 1].upper : null;
                
                // 3. è¨ˆç®—æ–æ³¢é‚£å¥‘é˜»åŠ›ä½
                const historicalHigh = Math.max(...recentPrices);
                const historicalLow = Math.min(...recentPrices);
                const fibResistance = this.calculateFibonacciResistance(historicalHigh, historicalLow);
                
                // 4. å°ˆæ¥­ç®—æ³•ç¶œåˆè¨ˆç®—
                let suggestedPrice;
                let method = "å°ˆæ¥­ç®—æ³•ç¶œåˆè¨ˆç®—ï¼š";
                
                // å„ªå…ˆä½¿ç”¨å¸ƒæ—å¸¶ä¸Šè»Œä½œç‚ºè³£å‡ºé»
                if (currentBollingerUpper && currentBollingerUpper > actualBuyPrice) {
                    suggestedPrice = currentBollingerUpper;
                    method += "å¸ƒæ—å¸¶ä¸Šè»Œ(20æ—¥å‡ç·š+2å€æ¨™æº–å·®)";
                }
                // æ¬¡é¸ä½¿ç”¨æ–æ³¢é‚£å¥‘38.2%é˜»åŠ›
                else if (fibResistance.level_138 && fibResistance.level_138 > actualBuyPrice) {
                    suggestedPrice = fibResistance.level_138;
                    method += "æ–æ³¢é‚£å¥‘38.2%é˜»åŠ›ä½";
                }
                // å†æ¬¡ä½¿ç”¨æ­·å²é«˜é»çš„90%
                else {
                    suggestedPrice = historicalHigh * 0.90;
                    method += "æ­·å²é«˜é»90%";
                }
                
                // 5. é¢¨éšªå ±é…¬æ¯”è¨ˆç®—
                const riskRewardRatio = (suggestedPrice - actualBuyPrice) / (actualBuyPrice * 0.05); // å‡è¨­5%é¢¨éšª
                
                // 6. æŠ€è¡“èª¿æ•´
                let techAdjustment = 0;
                if (rsi > 60) {
                    techAdjustment -= 0.01; // RSIåé«˜ï¼Œé™ä½ç›®æ¨™
                    method += " - RSIåé«˜èª¿æ•´";
                }
                if (rsi < 40) {
                    techAdjustment += 0.01; // RSIåä½ï¼Œæé«˜ç›®æ¨™
                    method += " + RSIåä½èª¿æ•´";
                }
                
                // 7. å¸‚å ´è¶¨å‹¢èª¿æ•´
                let marketAdjustment = (marketTrend || 0) * 0.15;
                if (marketAdjustment !== 0) {
                    method += ` ${marketAdjustment > 0 ? '+' : ''}${(marketAdjustment*100).toFixed(1)}%å¸‚å ´è¶¨å‹¢`;
                }
                
                // 8. è©•åˆ†èª¿æ•´
                let scoreAdjustment = 0;
                if (score >= 80) {
                    scoreAdjustment += 0.02;
                    method += " + é«˜è©•åˆ†èª¿æ•´";
                } else if (score >= 65) {
                    scoreAdjustment += 0.01;
                    method += " + ä¸­è©•åˆ†èª¿æ•´";
                }
                
                // 9. è¨ˆç®—æœ€çµ‚åƒ¹æ ¼
                suggestedPrice = suggestedPrice * (1 + techAdjustment + marketAdjustment + scoreAdjustment);
                
                // 10. å®‰å…¨é™åˆ¶
                const minPrice = actualBuyPrice * 1.05;
                const maxPrice = actualBuyPrice * 1.25;
                suggestedPrice = Math.max(minPrice, Math.min(maxPrice, suggestedPrice));
                
                if (useDefaultBuyPrice) {
                    method = `ç”¨æˆ¶æœªè¼¸å…¥è²·å…¥åƒ¹ï¼Œå‡è¨­ä»¥30å¤©å‡åƒ¹ä¸Šèª¿5%ä½œç‚ºåƒè€ƒè²·å…¥åƒ¹è¨ˆç®—ã€‚${method}`;
                }
                
                return {
                    price: suggestedPrice,
                    method: method,
                    adjustment: `æŠ€è¡“èª¿æ•´: ${(techAdjustment*100).toFixed(1)}%, å¸‚å ´èª¿æ•´: ${(marketAdjustment*100).toFixed(1)}%, è©•åˆ†èª¿æ•´: ${(scoreAdjustment*100).toFixed(1)}%`,
                    riskRewardRatio: riskRewardRatio.toFixed(1)
                };
            },
            
            // ä¿®æ”¹ï¼šä½¿ç”¨ATRå°ˆæ¥­ç®—æ³•è¨ˆç®—æ­¢æåƒ¹
            calculateProfessionalStopLoss: function(buyPrice, historicalPrices, monthlyVolatility, score) {
                // å–æœ€è¿‘30å¤©æ•¸æ“š
                const recentPrices = historicalPrices.slice(-30);
                if (recentPrices.length < 20) { 
                    return { 
                        price: buyPrice ? buyPrice * 0.95 : (recentPrices.length > 0 ? (recentPrices.reduce((a, b) => a + b, 0) / recentPrices.length) * 0.90 : 0),
                        method: "æ•¸æ“šä¸è¶³,ä½¿ç”¨ä¿å®ˆè¨ˆç®—",
                        adjustment: "ç„¡"
                    }; 
                }
                
                // 1. ç¢ºå®šè²·å…¥åƒ¹
                let actualBuyPrice = buyPrice;
                let useDefaultBuyPrice = false;
                if (!buyPrice || buyPrice <= 0) {
                    // ä½¿ç”¨30å¤©å‡åƒ¹ä¸Šèª¿5%ä½œç‚ºè™›æ“¬è²·å…¥åƒ¹
                    const historicalAvg = recentPrices.reduce((a, b) => a + b, 0) / recentPrices.length;
                    actualBuyPrice = historicalAvg * 1.05;
                    useDefaultBuyPrice = true;
                }
                
                // 2. è¨ˆç®—ATRï¼ˆå¹³å‡çœŸå¯¦æ³¢å¹…ï¼‰
                // ç”±æ–¼æ²’æœ‰é«˜ä½åƒ¹æ•¸æ“šï¼Œä½¿ç”¨æ”¶ç›¤åƒ¹è®ŠåŒ–ä¼°ç®—ATR
                let atrEstimate = 0;
                if (recentPrices.length >= 14) {
                    let totalRange = 0;
                    for (let i = 1; i < recentPrices.length; i++) {
                        totalRange += Math.abs(recentPrices[i] - recentPrices[i-1]);
                    }
                    atrEstimate = totalRange / (recentPrices.length - 1);
                }
                
                // 3. å°ˆæ¥­ATRæ­¢æè¨ˆç®—
                // ä½¿ç”¨1.5-2.5å€ATRä½œç‚ºæ­¢æè·é›¢
                let atrMultiplier = 2.0; // é»˜èª2å€ATR
                
                // æ ¹æ“šè©•åˆ†èª¿æ•´ATRå€æ•¸
                if (score >= 80) {
                    atrMultiplier = 1.5; // é«˜è©•åˆ†ï¼Œè¼ƒç·Šæ­¢æ
                } else if (score >= 65) {
                    atrMultiplier = 1.8;
                } else if (score <= 35) {
                    atrMultiplier = 2.5; // ä½è©•åˆ†ï¼Œè¼ƒå¯¬æ­¢æ
                }
                
                // 4. è¨ˆç®—ATRæ­¢æåƒ¹
                let suggestedStopLoss = actualBuyPrice - (atrEstimate * atrMultiplier);
                
                // 5. è¨ˆç®—æ–æ³¢é‚£å¥‘æ”¯æ’ä½œç‚ºè¼”åŠ©æ­¢æ
                const historicalHigh = Math.max(...recentPrices);
                const historicalLow = Math.min(...recentPrices);
                const fibSupport = this.calculateFibonacciSupport(historicalHigh, historicalLow);
                
                // å¦‚æœATRæ­¢æåƒ¹é«˜æ–¼æ–æ³¢é‚£å¥‘78.6%æ”¯æ’ï¼Œä½¿ç”¨æ›´ä½çš„åƒ¹æ ¼
                if (fibSupport.level_78 && suggestedStopLoss > fibSupport.level_78) {
                    suggestedStopLoss = fibSupport.level_78 * 0.99; // ç•¥ä½æ–¼æ–æ³¢é‚£å¥‘æ”¯æ’
                }
                
                // 6. å®‰å…¨æª¢æŸ¥
                const maxStopLoss = actualBuyPrice * 0.93; // æœ€å¤§æ­¢æ7%
                const minStopLoss = actualBuyPrice * 0.88; // æœ€å°æ­¢æ12%
                suggestedStopLoss = Math.max(minStopLoss, Math.min(maxStopLoss, suggestedStopLoss));
                
                const actualStopLossPercent = ((actualBuyPrice - suggestedStopLoss) / actualBuyPrice * 100).toFixed(1);
                
                let methodText = `ATRå°ˆæ¥­æ­¢æï¼š${atrMultiplier.toFixed(1)}å€å¹³å‡çœŸå¯¦æ³¢å¹…`;
                if (useDefaultBuyPrice) {
                    methodText = `ç”¨æˆ¶æœªè¼¸å…¥è²·å…¥åƒ¹ï¼Œå‡è¨­ä»¥30å¤©å‡åƒ¹ä¸Šèª¿5%ä½œç‚ºåƒè€ƒè²·å…¥åƒ¹è¨ˆç®—ã€‚${methodText}`;
                }
                
                return {
                    price: suggestedStopLoss,
                    method: methodText,
                    adjustment: `ATRå€æ•¸: ${atrMultiplier.toFixed(1)}, å¯¦éš›æ­¢æ: ${actualStopLossPercent}%`,
                    actualStopLossPercent: actualStopLossPercent
                };
            }
        };
        
        function calculateVolatilityAdjustedOdds(historicalPrices, dailyVolatility) {
            const volatilityFactor = dailyVolatility / 2.0;
            let adjustedProfitTarget = 0.10 * (1 + volatilityFactor);
            let adjustedStopLoss = 0.05 * (1 + volatilityFactor);
            const odds = adjustedProfitTarget / adjustedStopLoss;
            return {
                odds: odds.toFixed(2),
                adjustedProfitTarget: (adjustedProfitTarget * 100).toFixed(1),
                adjustedStopLoss: (adjustedStopLoss * 100).toFixed(1),
                reason: `æ ¹æ“šæ³¢å‹•ç‡(${dailyVolatility.toFixed(2)}%)èª¿æ•´`
            };
        }
        
        function calculatePricePositionAdjustedOdds(historicalPrices, currentPrice, rsi, macdSignal) {
            const historicalHigh = Math.max(...historicalPrices);
            const historicalLow = Math.min(...historicalPrices);
            const pricePosition = (currentPrice - historicalLow) / (historicalHigh - historicalLow);
            let positionFactor = 1.0;
            if (pricePosition > 0.7) positionFactor = 0.8;
            else if (pricePosition > 0.5) positionFactor = 0.9;
            else if (pricePosition > 0.3) positionFactor = 1.0;
            else positionFactor = 1.1;
            let rsiFactor = 1.0;
            if (rsi < 30) rsiFactor = 1.15;
            else if (rsi > 70) rsiFactor = 0.85;
            let macdFactor = 1.0;
            if (macdSignal === 'golden_cross') macdFactor = 1.1;
            else if (macdSignal === 'death_cross') macdFactor = 0.9;
            const baseOdds = 2.0;
            const adjustedOdds = baseOdds * positionFactor * rsiFactor * macdFactor;
            return {
                odds: adjustedOdds.toFixed(2),
                pricePosition: (pricePosition * 100).toFixed(1),
                positionFactor: positionFactor.toFixed(2),
                rsiFactor: rsiFactor.toFixed(2),
                macdFactor: macdFactor.toFixed(2),
                reason: `åƒ¹æ ¼ä½ç½® ${(pricePosition*100).toFixed(1)}%, RSI:${rsi.toFixed(1)}, MACD:${macdSignal}`
            };
        }
        
        function calculateMaxDrawdownAdjustedOdds(historicalPrices) {
            let maxDrawdown = 0;
            let peak = historicalPrices[0];
            for (let i = 1; i < historicalPrices.length; i++) {
                if (historicalPrices[i] > peak) { peak = historicalPrices[i]; }
                const drawdown = (peak - historicalPrices[i]) / peak;
                if (drawdown > maxDrawdown) { maxDrawdown = drawdown; }
            }
            const drawdownFactor = 1 + (maxDrawdown * 2);
            let totalGain = 0;
            let gainCount = 0;
            for (let i = 1; i < historicalPrices.length; i++) {
                const change = historicalPrices[i] - historicalPrices[i-1];
                if (change > 0) { totalGain += change / historicalPrices[i-1]; gainCount++; }
            }
            const avgGain = gainCount > 0 ? totalGain / gainCount : 0.02;
            const adjustedOdds = (avgGain * drawdownFactor) / (maxDrawdown || 0.05);
            return {
                odds: Math.max(1.0, Math.min(5.0, adjustedOdds)).toFixed(2),
                maxDrawdown: (maxDrawdown * 100).toFixed(1),
                avgGain: (avgGain * 100).toFixed(1),
                drawdownFactor: drawdownFactor.toFixed(2),
                reason: `æœ€å¤§å›æ’¤ ${(maxDrawdown*100).toFixed(1)}%, å¹³å‡ç›ˆåˆ© ${(avgGain*100).toFixed(1)}%`
            };
        }
        
        function calculateComprehensiveOdds(historicalPrices, currentPrice, rsi, macdSignal, dailyVolatility) {
            const volatilityOdds = calculateVolatilityAdjustedOdds(historicalPrices, dailyVolatility);
            const positionOdds = calculatePricePositionAdjustedOdds(historicalPrices, currentPrice, rsi, macdSignal);
            const drawdownOdds = calculateMaxDrawdownAdjustedOdds(historicalPrices);
            const weights = { volatility: 0.4, position: 0.35, drawdown: 0.25 };
            const compositeOdds = 
                parseFloat(volatilityOdds.odds) * weights.volatility +
                parseFloat(positionOdds.odds) * weights.position +
                parseFloat(drawdownOdds.odds) * weights.drawdown;
            return {
                compositeOdds: compositeOdds.toFixed(2),
                volatilityOdds: volatilityOdds,
                positionOdds: positionOdds,
                drawdownOdds: drawdownOdds,
                summary: `æ³¢å‹•ç‡è³ ç‡:${volatilityOdds.odds}, ä½ç½®è³ ç‡:${positionOdds.odds}, å›æ’¤è³ ç‡:${drawdownOdds.odds}`
            };
        }
        
        function formatDate(d) {
            const y = d.getFullYear();
            const m = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${day}`;
        }
        
        function datesBetween(start, end) {
            const arr = [];
            const cur = new Date(start);
            cur.setHours(0, 0, 0, 0);
            while (cur <= end) {
                arr.push(formatDate(new Date(cur)));
                cur.setDate(cur.getDate() + 1);
            }
            return arr;
        }
        
        function setDefaultDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(endDate.getMonth() - 3);
            document.getElementById('endDate').value = formatDate(endDate);
            document.getElementById('startDate').value = formatDate(startDate);
        }
        
        function initHotStockSelect() {
            const hotStockSelect = document.getElementById('hotStockSelect');
            hotStockSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡ç†±é–€è‚¡ç¥¨ --</option>';
            if (recentStocks.length > 0) {
                const recentGroup = document.createElement('optgroup');
                recentGroup.label = 'ğŸ“‹ æœ€è¿‘æŸ¥è©¢çš„è‚¡ç¥¨';
                recentGroup.className = 'group-header';
                recentStocks.forEach(stock => {
                    const option = document.createElement('option');
                    option.value = stock.code;
                    option.textContent = `${stock.code} ${stock.name}`;
                    option.dataset.type = stock.type;
                    recentGroup.appendChild(option);
                });
                hotStockSelect.appendChild(recentGroup);
            }
            const twseGroup = document.createElement('optgroup');
            twseGroup.label = 'ğŸ“ˆ ä¸Šå¸‚å…¬å¸ç†±é–€è‚¡ç¥¨';
            twseGroup.className = 'group-header';
            const tpexGroup = document.createElement('optgroup');
            tpexGroup.label = 'ğŸ“Š ä¸Šæ«ƒå…¬å¸ç†±é–€è‚¡ç¥¨';
            tpexGroup.className = 'group-header';
            hotStocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock.code;
                option.textContent = `${stock.code} ${stock.name}`;
                option.dataset.type = stock.type;
                if (stock.type === 'twse') { twseGroup.appendChild(option); } else if (stock.type === 'tpex') { tpexGroup.appendChild(option); }
            });
            if (twseGroup.children.length > 0) { hotStockSelect.appendChild(twseGroup); }
            if (tpexGroup.children.length > 0) { hotStockSelect.appendChild(tpexGroup); }
            hotStockSelect.addEventListener('change', function() {
                if (this.value) {
                    const selectedOption = this.options[this.selectedIndex];
                    const stockCode = this.value;
                    const stockType = selectedOption.dataset.type;
                    selectHotStock(stockCode, stockType);
                    this.selectedIndex = 0;
                }
            });
        }
        
        function updateRecentStocks(stockCode, stockName, stockType) {
            const existingIndex = recentStocks.findIndex(s => s.code === stockCode);
            if (existingIndex > -1) {
                const existingStock = recentStocks.splice(existingIndex, 1)[0];
                recentStocks.unshift(existingStock);
            } else {
                recentStocks.unshift({ code: stockCode, name: stockName, type: stockType, timestamp: Date.now() });
                if (recentStocks.length > 10) { recentStocks.pop(); }
            }
            localStorage.setItem('recentStocks', JSON.stringify(recentStocks));
            initHotStockSelect();
        }
        
        function selectHotStock(code, type) {
            setCompanyType(type);
            const foundStock = stockData.find(stock => 
                stock.stock_id === code && 
                (stock.type === type || (type === 'auto' && stock.type !== null))
            );
            if (foundStock) {
                updateSelectedStockDisplay(foundStock.stock_id, foundStock.stock_name);
                updateRecentStocks(foundStock.stock_id, foundStock.stock_name, foundStock.type);
                alert(`å·²æ‰¾åˆ°è‚¡ç¥¨:${foundStock.stock_id} ${foundStock.stock_name}`);
            } else {
                document.getElementById('stockCode').value = code;
                updateSelectedStockDisplay(code, `è‚¡ç¥¨${code}`);
                alert(`å·²è¨­ç½®è‚¡ç¥¨ä»£ç¢¼:${code},è«‹ç¢ºä¿ä»£ç¢¼æ­£ç¢º`);
                const stockName = hotStocks.find(s => s.code === code)?.name || `è‚¡ç¥¨${code}`;
                updateRecentStocks(code, stockName, type);
            }
        }
        
        // ä¿®æ”¹ï¼šæ¸…ç©ºæ­·å²æ•¸æ“šå’Œåœ–è¡¨
        function clearHistoricalDataAndCharts() {
            // æ¸…ç©ºæ­·å²æ”¶ç›¤åƒ¹ç›¸é—œè¼¸å…¥
            document.getElementById('historicalPrices').value = '';
            document.getElementById('historicalDays').value = '';
            document.getElementById('historicalLow').value = '';
            document.getElementById('historicalHigh').value = '';
            document.getElementById('historicalAvg').value = '';
            document.getElementById('volatility').value = '';
            document.getElementById('currentPrice').value = '';
            document.getElementById('fetchNote').textContent = '';
            // æ¸…ç©ºäº¤æ˜“åƒæ•¸è¨­å®šçš„è²·å…¥åƒ¹æ ¼
            document.getElementById('buyPrice').value = '';
            
            // æ¸…ç©ºäº¤æ˜“æ—¥æ›†å’Œåœ–è¡¨
            hideMarketComparisonChart();
            
            // æ¸…ç©ºè¨ˆç®—çµæœ
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('show');
            
            // æ¸…ç©ºè¨ˆç®—çµæœä¸­çš„æ•¸æ“š
            document.getElementById('resultStockCode').textContent = '';
            document.getElementById('resultCurrentPrice').textContent = '';
            document.getElementById('actualBuyPrice').textContent = '';
            document.getElementById('scoreValue').textContent = '';
            document.getElementById('recommendation').textContent = '';
            document.getElementById('recommendation').className = 'recommendation';
            document.getElementById('rsiValue').textContent = '';
            document.getElementById('rsiValue').className = 'rsi-value';
            document.getElementById('macdSignal').textContent = '';
            document.getElementById('customBuyPrice').textContent = '';
            document.getElementById('customStopLossPrice').textContent = '';
            document.getElementById('customSellPrice').textContent = '';
            document.getElementById('aiSuggestedBuyPrice').innerHTML = '';
            document.getElementById('aiSellPrice').innerHTML = '';
            document.getElementById('aiStopLossPrice').innerHTML = '';
            document.getElementById('stopLossWarning').style.display = 'none';
            document.getElementById('kellyRatio').innerHTML = '';
            document.getElementById('calculatedWinRate').textContent = '';
            document.getElementById('calculatedOdds').innerHTML = '';
            document.getElementById('adjustedWinRate').textContent = '';
            document.getElementById('adjustedOdds').textContent = '';
            document.getElementById('dailyVolatility').textContent = '';
            document.getElementById('weeklyVolatility').textContent = '';
            document.getElementById('monthlyVolatility').textContent = '';
            document.getElementById('annualVolatility').textContent = '';
            
            // æ¸…ç©ºè­¦å‘Šè¨Šæ¯
            document.getElementById('dataWarning').style.display = 'none';
            document.getElementById('rsiWarning').style.display = 'none';
            document.getElementById('macdInfo').style.display = 'none';
            document.getElementById('macdToggle').style.display = 'none';
            document.getElementById('macdNote').style.display = 'none';
            
            // æ¸…ç©ºæµ®å‹•è¦–çª—
            hideChartHoverInfo();
        }
        
        function updateSelectedStockDisplay(code, name) {
            const display = document.getElementById('selectedStockDisplay');
            if (code && name) {
                display.innerHTML = `<span style="color: #d4b97a; font-size: 1.4rem;">${code} ${name}</span>`;
                document.getElementById('stockCode').value = code;
                updateAIPromptWithStock(code, name);
                
                // ä¿®æ”¹ï¼šç•¶è‚¡ç¥¨æˆåŠŸé¸æ“‡å¾Œï¼Œæ¸…ç©ºæ­·å²æ•¸æ“šå’Œåœ–è¡¨
                clearHistoricalDataAndCharts();
            } else {
                display.textContent = 'å°šæœªé¸æ“‡è‚¡ç¥¨';
                document.getElementById('stockCode').value = '';
            }
        }
        
        function updateAIPromptWithStock(stockCode, stockName) {
            const queryInput = document.getElementById('queryInput');
            if (queryInput && stockCode) {
                const currentValue = queryInput.value;
                const stockInfo = stockName ? `${stockName}${stockCode}` : `è‚¡ç¥¨${stockCode}`;
                if (!currentValue || currentValue.includes('è³‡æ·±è‚¡ç¥¨åˆ†æå¸«') || currentValue.includes('åˆ†æ"') || currentValue.trim() === '') {
                    const defaultPrompt = `ä½ æ˜¯è³‡æ·±è‚¡ç¥¨åˆ†æå¸«ï¼Œåˆ†æ"${stockInfo}"çš„è‚¡åƒ¹è¶¨å‹¢ï¼Œåšå‡ºä¸å°‘æ–¼å…­å€‹é‡é»æ•´ç†çµ¦æˆ‘ï¼ŒæŒ‰ç…§-30ï½+30çš„å€é–“åšå‡ºç¸½è©•åˆ†`;
                    document.getElementById('queryInput').value = defaultPrompt;
                }
            }
        }
        
        function setCompanyType(type) {
            selectedCompanyType = type;
            document.querySelectorAll('.company-type-btn').forEach(btn => {
                if (btn.dataset.type === type) { btn.classList.add('active'); } else { btn.classList.remove('active'); }
            });
            const industryGroup = document.getElementById('industryGroup');
            const industryNote = document.getElementById('industryNote');
            const stockSelectGroup = document.getElementById('stockSelectGroup');
            if (type === 'twse') {
                industryGroup.style.display = 'block';
                industryNote.textContent = 'èªªæ˜:é¡è‚¡ç¯©é¸åƒ…é©ç”¨æ–¼ä¸Šå¸‚å…¬å¸ã€‚';
                stockSelectGroup.style.display = 'block';
                updateStockList();
            } else if (type === 'tpex' || type === 'emerging') {
                industryGroup.style.display = 'block';
                industryNote.textContent = 'èªªæ˜:ä¸Šæ«ƒ/èˆˆæ«ƒå…¬å¸ç„¡é¡è‚¡åˆ†é¡,è«‹ä½¿ç”¨è‚¡ç¥¨æœå°‹åŠŸèƒ½ã€‚';
                industryGroup.querySelector('select').disabled = true;
                stockSelectGroup.style.display = 'block';
                updateStockList();
            } else if (type === 'auto') {
                industryGroup.style.display = 'block';
                industryNote.textContent = 'èªªæ˜:è‡ªå‹•æª¢æ¸¬æ¨¡å¼ä¸‹,ç³»çµ±å°‡æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼è‡ªå‹•åˆ¤æ–·å…¬å¸é¡å‹ã€‚';
                industryGroup.querySelector('select').disabled = false;
                stockSelectGroup.style.display = 'block';
                updateStockList();
            }
        }
        
        function updateStockList() {
            const stockSelect = document.getElementById('stockSelect');
            stockSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡è‚¡ç¥¨ --</option>';
            if (!selectedCompanyType) return;
            let filteredStocks = [];
            if (selectedCompanyType === 'auto') { filteredStocks = stockData; } else { filteredStocks = stockData.filter(stock => stock.type === selectedCompanyType); }
            if (selectedCompanyType === 'twse') {
                const selectedIndustry = document.getElementById('industry').value;
                if (selectedIndustry) { filteredStocks = filteredStocks.filter(stock => stock.industry_category === selectedIndustry); }
            }
            filteredStocks = filteredStocks.filter(stock => !stock.stock_id.startsWith('00'));
            filteredStocks.sort((a, b) => a.stock_id.localeCompare(b.stock_id));
            filteredStocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock.stock_id;
                option.textContent = `${stock.stock_id} ${stock.stock_name}`;
                stockSelect.appendChild(option);
            });
            if (filteredStocks.length === 0) { stockSelect.innerHTML = '<option value="">ç„¡ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨</option>'; }
        }
        
        // æ–°å¢ï¼šæ™ºèƒ½æœå°‹åŠŸèƒ½
        let currentAutocompleteIndex = -1;
        let filteredStocksForAutocomplete = [];
        
        // ä¿®æ”¹ï¼šæ”¹é€²çš„ç¯©é¸é‚è¼¯
        function filterStocksForAutocomplete(searchText) {
            if (!searchText || searchText.trim() === '') {
                return [];
            }
            
            const text = searchText.trim().toLowerCase();
            const isNumeric = /^\d+$/.test(text);
            const isEnglish = /^[a-zA-Z]+$/.test(text);
            
            // æ ¹æ“šæœå°‹é¡å‹é€²è¡Œç¯©é¸
            let filteredStocks = stockData.filter(stock => {
                const stockId = stock.stock_id.toLowerCase();
                const stockName = stock.stock_name.toLowerCase();
                
                // å¦‚æœæœå°‹æ˜¯ç´”æ•¸å­—ï¼Œå„ªå…ˆåŒ¹é…è‚¡ç¥¨ä»£ç¢¼
                if (isNumeric) {
                    return stockId.startsWith(text);
                }
                // å¦‚æœæœå°‹æ˜¯ç´”è‹±æ–‡ï¼ŒåŒ¹é…è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ä¸­çš„è‹±æ–‡éƒ¨åˆ†
                else if (isEnglish) {
                    return stockId.startsWith(text) || stockName.includes(text);
                }
                // å¦å‰‡åŒ¹é…è‚¡ç¥¨åç¨±ï¼ˆä¸­æ–‡ï¼‰
                else {
                    return stockName.startsWith(text) || stockName.includes(text);
                }
            });
            
            // æ ¹æ“šæœå°‹é¡å‹é€²è¡Œæ’åº
            if (isNumeric) {
                // æ•¸å­—æœå°‹ï¼šæŒ‰è‚¡ç¥¨ä»£ç¢¼æ•¸å­—é †åºæ’åº
                filteredStocks.sort((a, b) => {
                    const numA = parseInt(a.stock_id);
                    const numB = parseInt(b.stock_id);
                    return numA - numB;
                });
            } else if (isEnglish) {
                // è‹±æ–‡æœå°‹ï¼šæŒ‰å­—æ¯é †åºæ’åº
                filteredStocks.sort((a, b) => {
                    // å„ªå…ˆæŒ‰è‚¡ç¥¨ä»£ç¢¼æ’åºï¼Œç„¶å¾ŒæŒ‰åç¨±æ’åº
                    if (a.stock_id.startsWith(text) && !b.stock_id.startsWith(text)) return -1;
                    if (!a.stock_id.startsWith(text) && b.stock_id.startsWith(text)) return 1;
                    return a.stock_id.localeCompare(b.stock_id);
                });
            } else {
                // ä¸­æ–‡æœå°‹ï¼šæŒ‰ç›¸é—œæ€§æ’åº
                filteredStocks.sort((a, b) => {
                    const nameA = a.stock_name.toLowerCase();
                    const nameB = b.stock_name.toLowerCase();
                    
                    // é–‹é ­åŒ¹é…å„ªå…ˆ
                    const aStartsWith = nameA.startsWith(text);
                    const bStartsWith = nameB.startsWith(text);
                    
                    if (aStartsWith && !bStartsWith) return -1;
                    if (!aStartsWith && bStartsWith) return 1;
                    
                    // ç„¶å¾ŒæŒ‰åç¨±é•·åº¦æ’åºï¼ˆè¼ƒçŸ­çš„åç¨±é€šå¸¸æ›´ç›¸é—œï¼‰
                    if (nameA.length !== nameB.length) {
                        return nameA.length - nameB.length;
                    }
                    
                    // æœ€å¾ŒæŒ‰å­—æ¯é †åºæ’åº
                    return nameA.localeCompare(nameB);
                });
            }
            
            return filteredStocks.slice(0, 15); // æœ€å¤šé¡¯ç¤º15å€‹çµæœ
        }
        
        function showAutocompleteList(stocks) {
            const autocompleteList = document.getElementById('autocompleteList');
            autocompleteList.innerHTML = '';
            
            if (stocks.length === 0) {
                autocompleteList.classList.remove('show');
                return;
            }
            
            stocks.forEach((stock, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.dataset.index = index;
                item.dataset.code = stock.stock_id;
                item.dataset.name = stock.stock_name;
                item.dataset.type = stock.type;
                
                // æ ¹æ“šå…¬å¸é¡å‹è¨­ç½®æ¨£å¼
                let typeText = '';
                let typeClass = '';
                switch(stock.type) {
                    case 'twse':
                        typeText = 'ä¸Šå¸‚';
                        typeClass = 'twse';
                        break;
                    case 'tpex':
                        typeText = 'ä¸Šæ«ƒ';
                        typeClass = 'tpex';
                        break;
                    case 'emerging':
                        typeText = 'èˆˆæ«ƒ';
                        typeClass = 'emerging';
                        break;
                }
                
                item.innerHTML = `
                    <div class="stock-code">${stock.stock_id}</div>
                    <div class="stock-name">${stock.stock_name}</div>
                    <div class="stock-type ${typeClass}">${typeText}</div>
                `;
                
                item.addEventListener('click', function() {
                    selectStockFromAutocomplete(this.dataset.code, this.dataset.name, this.dataset.type);
                });
                
                autocompleteList.appendChild(item);
            });
            
            // æ·»åŠ çµæœæ•¸é‡ä¿¡æ¯
            const info = document.createElement('div');
            info.className = 'autocomplete-info';
            info.textContent = `æ‰¾åˆ° ${stocks.length} å€‹çµæœï¼ŒæŒ‰ â†‘ â†“ é¸æ“‡ï¼ŒEnter ç¢ºèª`;
            autocompleteList.appendChild(info);
            
            autocompleteList.classList.add('show');
            filteredStocksForAutocomplete = stocks;
            currentAutocompleteIndex = -1;
        }
        
        function selectStockFromAutocomplete(code, name, type) {
            document.getElementById('manualInput').value = `${code} ${name}`;
            document.getElementById('autocompleteList').classList.remove('show');
            
            updateSelectedStockDisplay(code, name);
            setCompanyType(type);
            updateRecentStocks(code, name, type);
            
            // è‡ªå‹•è¨­ç½®ç‚ºå·²é¸æ“‡çš„è‚¡ç¥¨é¡å‹
            const companyTypeBtn = document.querySelector(`.company-type-btn[data-type="${type}"]`);
            if (companyTypeBtn) {
                companyTypeBtn.click();
            }
        }
        
        function setupAutocomplete() {
            const manualInput = document.getElementById('manualInput');
            const autocompleteList = document.getElementById('autocompleteList');
            
            manualInput.addEventListener('input', function() {
                const searchText = this.value;
                if (searchText.length >= 1) {
                    const filteredStocks = filterStocksForAutocomplete(searchText);
                    showAutocompleteList(filteredStocks);
                } else {
                    autocompleteList.classList.remove('show');
                }
            });
            
            manualInput.addEventListener('keydown', function(e) {
                if (!autocompleteList.classList.contains('show')) return;
                
                const items = autocompleteList.querySelectorAll('.autocomplete-item');
                if (items.length === 0) return;
                
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        currentAutocompleteIndex = (currentAutocompleteIndex + 1) % items.length;
                        updateAutocompleteSelection();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        currentAutocompleteIndex = (currentAutocompleteIndex - 1 + items.length) % items.length;
                        updateAutocompleteSelection();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (currentAutocompleteIndex >= 0 && currentAutocompleteIndex < items.length) {
                            const selectedItem = items[currentAutocompleteIndex];
                            selectStockFromAutocomplete(
                                selectedItem.dataset.code,
                                selectedItem.dataset.name,
                                selectedItem.dataset.type
                            );
                        }
                        break;
                    case 'Escape':
                        autocompleteList.classList.remove('show');
                        break;
                }
            });
            
            // é»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚éš±è—ä¸‹æ‹‰é¸å–®
            document.addEventListener('click', function(e) {
                if (!manualInput.contains(e.target) && !autocompleteList.contains(e.target)) {
                    autocompleteList.classList.remove('show');
                }
            });
            
            // é»æ“Šè¼¸å…¥æ¡†æ™‚é‡æ–°é¡¯ç¤ºä¸‹æ‹‰é¸å–®ï¼ˆå¦‚æœæœ‰æ–‡å­—ï¼‰
            manualInput.addEventListener('click', function() {
                if (this.value.length >= 1) {
                    const filteredStocks = filterStocksForAutocomplete(this.value);
                    showAutocompleteList(filteredStocks);
                }
            });
        }
        
        function updateAutocompleteSelection() {
            const items = document.querySelectorAll('.autocomplete-item');
            items.forEach((item, index) => {
                if (index === currentAutocompleteIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // ä¿®æ”¹ï¼šloadStockList å‡½æ•¸ï¼Œç¢ºä¿åˆå§‹åŒ–æ™‚å°ˆæ¥­åˆ†ææŒ‰éˆ•æ­£ç¢ºè¨­ç½®
        async function loadStockList() {
            const fetchNote = document.getElementById('fetchNote');
            const industryEl = document.getElementById('industry');
            try {
                fetchNote.textContent = 'æ­£åœ¨è¼‰å…¥è‚¡ç¥¨åˆ—è¡¨...';
                const url = 'https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockInfo';
                const res = await fetch(url);
                if (!res.ok) throw new Error('ç„¡æ³•è¼‰å…¥è‚¡ç¥¨åˆ—è¡¨');
                const json = await res.json();
                if (json.status === 200 && Array.isArray(json.data)) {
                    stockData = json.data
                        .filter(item => item.type === 'twse' || item.type === 'tpex' || item.type === 'emerging')
                        .sort((a, b) => a.stock_id.localeCompare(b.stock_id));
                    industries = new Set(
                        stockData
                            .filter(item => item.type === 'twse' && item.industry_category && item.industry_category.trim() !== '')
                            .map(item => item.industry_category)
                    );
                    industryEl.innerHTML = '<option value="">-- å…¨éƒ¨é¡è‚¡ --</option>';
                    Array.from(industries).sort().forEach(industry => {
                        const option = document.createElement('option');
                        option.value = industry;
                        option.textContent = industry;
                       industryEl.appendChild(option)
                    });
                    fetchNote.textContent = `å·²è¼‰å…¥ ${stockData.length} æ”¯è‚¡ç¥¨è³‡æ–™ (ä¸Šå¸‚: ${stockData.filter(s => s.type === 'twse').length}, ä¸Šæ«ƒ: ${stockData.filter(s => s.type === 'tpex').length}, èˆˆæ«ƒ: ${stockData.filter(s => s.type === 'emerging').length})`;
                    initHotStockSelect();
                    setCompanyType('auto');
                    
                    // ä¿®æ”¹ï¼šç¢ºä¿å°ˆæ¥­åˆ†ææŒ‰éˆ•åˆå§‹åŒ–
                    setupProfessionalAnalysisButton();
                    
                    // åˆå§‹åŒ–æ™ºèƒ½æœå°‹åŠŸèƒ½
                    setupAutocomplete();
                } else { throw new Error('è‚¡ç¥¨åˆ—è¡¨æ ¼å¼ç•°å¸¸'); }
            } catch (e) {
                console.error('è¼‰å…¥è‚¡ç¥¨åˆ—è¡¨éŒ¯èª¤', e);
                fetchNote.textContent = 'è¼‰å…¥è‚¡ç¥¨åˆ—è¡¨å¤±æ•—:' + (e.message || e);
                industryEl.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                initHotStockSelect();
                setCompanyType('auto');
                
                // ä¿®æ”¹ï¼šå³ä½¿è¼‰å…¥å¤±æ•—ä¹Ÿç¢ºä¿å°ˆæ¥­åˆ†ææŒ‰éˆ•åˆå§‹åŒ–
                setupProfessionalAnalysisButton();
                
                // ä»ç„¶åˆå§‹åŒ–æ™ºèƒ½æœå°‹åŠŸèƒ½ï¼ˆå³ä½¿è¼‰å…¥å¤±æ•—ï¼‰
                setupAutocomplete();
            }
        }
        
        document.getElementById('industry').addEventListener('change', function() {
            const selectedIndustry = this.value;
            if (selectedIndustry) {
                setCompanyType('twse');
                updateStockList();
            } else if (selectedCompanyType) { updateStockList(); }
        });
        
        document.getElementById('stockSelect').addEventListener('change', (e) => {
            const stockId = e.target.value;
            if (stockId) {
                const foundStock = stockData.find(stock => stock.stock_id === stockId);
                if (foundStock) {
                    updateSelectedStockDisplay(foundStock.stock_id, foundStock.stock_name);
                    if (foundStock.type !== selectedCompanyType) { setCompanyType(foundStock.type); }
                    updateRecentStocks(foundStock.stock_id, foundStock.stock_name, foundStock.type);
                } else { updateSelectedStockDisplay(stockId, `è‚¡ç¥¨${stockId}`); }
            } else { updateSelectedStockDisplay('', ''); }
        });
        
        async function fetchFinMind(stockNo, start, end) {
            const results = {};
            const startDateParam = formatDate(start);
            const endDateParam = formatDate(end);
            const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${stockNo}&start_date=${startDateParam}&end_date=${endDateParam}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('FinMind å›å‚³é 200');
                const json = await res.json();
                if (json.status === 200 && Array.isArray(json.data)) {
                    if (json.data.length === 0) { throw new Error('æŸ¥ç„¡æ­¤è‚¡ç¥¨ä»£ç¢¼æˆ–æ—¥æœŸç¯„åœå…§ç„¡è³‡æ–™'); }
                    json.data.forEach(row => {
                        const date = row.date;
                        const close = row.close === null || row.close === undefined ? '' : String(row.close).replace(/,/g, '').trim();
                        // éæ¿¾æ‰å€¼ç‚º0æˆ–ç„¡æ•ˆçš„æ•¸æ“š
                        const closeNum = parseFloat(close);
                        if (close && close !== '-' && close !== '' && !isNaN(closeNum) && closeNum > 0) {
                            results[date] = close;
                        }
                    });
                } else if (json.status === 404) { throw new Error('æŸ¥ç„¡æ­¤è‚¡ç¥¨ä»£ç¢¼æˆ–æ—¥æœŸç¯„åœå…§ç„¡è³‡æ–™'); } else { throw new Error('FinMind API è¿”å›ç•°å¸¸æ ¼å¼'); }
                return results;
            } catch (error) {
                console.error('FinMind API éŒ¯èª¤:', error);
                if (error.message.includes('network')) { throw new Error('ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥'); } else if (error.message.includes('404')) { throw new Error(`è‚¡ç¥¨ä»£ç¢¼ ${stockNo} ä¸å­˜åœ¨æˆ–ç„¡æ•¸æ“š`); } else { throw new Error(`æ•¸æ“šç²å–å¤±æ•—: ${error.message}`); }
            }
        }
        
        // ä¿®æ”¹ï¼šæœå°‹è‚¡ç¥¨æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶è™•ç†å‡½æ•¸ - å¢å¼·è§£æèƒ½åŠ›
        document.getElementById('manualSearchBtn').addEventListener('click', function() {
            const manualInput = document.getElementById('manualInput').value.trim();
            if (!manualInput) { 
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±'); 
                return; 
            }
            
            // å¢å¼·è§£æï¼šè™•ç†å¤šç¨®æ ¼å¼
            // 1. å˜—è©¦æå–ç´”æ•¸å­—è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚ "00847B" æˆ– "2330"ï¼‰
            const stockCodeMatch = manualInput.match(/^(\d{4,6}[A-Z]?)/);
            let stockCode = '';
            let stockName = '';
            
            if (stockCodeMatch) {
                // æ ¼å¼ç‚ºï¼šä»£ç¢¼ + å¯èƒ½çš„åç¨±
                stockCode = stockCodeMatch[1];
                stockName = manualInput.substring(stockCodeMatch[0].length).trim();
            } else {
                // 2. å˜—è©¦å¾å®Œæ•´å­—ç¬¦ä¸²ä¸­æå–è‚¡ç¥¨ä»£ç¢¼å’Œåç¨±ï¼ˆå¦‚ "00847B ä¸­ä¿¡ç¾åœ‹å¸‚æ”¿å‚µ"ï¼‰
                const fullMatch = manualInput.match(/^(\d{4,6}[A-Z]?)\s+(.+)$/);
                if (fullMatch) {
                    stockCode = fullMatch[1];
                    stockName = fullMatch[2];
                } else {
                    // 3. å¯èƒ½æ˜¯ç´”åç¨±æˆ–ç´”ä»£ç¢¼
                    const isNumeric = /^\d+$/.test(manualInput);
                    if (isNumeric) {
                        // ç´”æ•¸å­—ï¼Œå¯èƒ½æ˜¯è‚¡ç¥¨ä»£ç¢¼
                        stockCode = manualInput;
                    } else {
                        // ç´”åç¨±
                        stockName = manualInput;
                    }
                }
            }
            
            // æ¸…é™¤å¤šé¤˜çš„æ–‡å­—ï¼ˆå¦‚ "è‚¡ç¥¨" å‰ç¶´ï¼‰
            if (stockName) {
                stockName = stockName.replace(/^è‚¡ç¥¨\s*/, '').replace(/\s*è‚¡ç¥¨$/, '');
            }
            
            // å¦‚æœæ²’æœ‰é¸æ“‡å…¬å¸é¡å‹æˆ–ç‚ºè‡ªå‹•æª¢æ¸¬ï¼Œå˜—è©¦æ ¹æ“šä»£ç¢¼åˆ¤æ–·é¡å‹
            if (!selectedCompanyType || selectedCompanyType === 'auto') {
                if (stockCode && stockCode.length === 4 && /^\d{4}$/.test(stockCode)) {
                    const codeNum = parseInt(stockCode);
                    if (codeNum >= 1000 && codeNum <= 9999) {
                        if ((codeNum >= 1101 && codeNum <= 9999) || (codeNum >= 2002 && codeNum <= 2999) || (codeNum >= 3008 && codeNum <= 9999)) { 
                            selectedCompanyType = 'twse'; 
                        } else if ((codeNum >= 1000 && codeNum <= 9999) && !(codeNum >= 1101 && codeNum <= 9999)) { 
                            selectedCompanyType = 'tpex'; 
                        }
                    }
                } else if (stockCode && stockCode.length > 4) {
                    // å¯èƒ½æ˜¯ETFæˆ–ç‰¹åˆ¥è‚¡ç¥¨
                    selectedCompanyType = 'tpex';
                }
                
                if (selectedCompanyType) { 
                    setCompanyType(selectedCompanyType); 
                }
            }
            
            let foundStock = null;
            
            // å„ªå…ˆä½¿ç”¨è‚¡ç¥¨ä»£ç¢¼æœå°‹
            if (stockCode) {
                foundStock = stockData.find(stock => 
                    stock.stock_id === stockCode && 
                    (selectedCompanyType === 'auto' || stock.type === selectedCompanyType)
                );
            }
            
            // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦ç”¨åç¨±æœå°‹
            if (!foundStock && stockName) {
                foundStock = stockData.find(stock => 
                    stock.stock_name.includes(stockName) && 
                    (selectedCompanyType === 'auto' || stock.type === selectedCompanyType)
                );
            }
            
            // å¦‚æœé‚„æ˜¯æ²’æ‰¾åˆ°ï¼Œæ”¾å¯¬æ¢ä»¶æœå°‹
            if (!foundStock) {
                foundStock = stockData.find(stock => 
                    (stockCode && stock.stock_id === stockCode) || 
                    (stockName && stock.stock_name.includes(stockName))
                );
            }
            
            if (foundStock) {
                updateSelectedStockDisplay(foundStock.stock_id, foundStock.stock_name);
                updateRecentStocks(foundStock.stock_id, foundStock.stock_name, foundStock.type);
                alert(`å·²æ‰¾åˆ°è‚¡ç¥¨:${foundStock.stock_id} ${foundStock.stock_name}`);
            } else {
                if (stockCode) {
                    document.getElementById('stockCode').value = stockCode;
                    updateSelectedStockDisplay(stockCode, stockName || `è‚¡ç¥¨${stockCode}`);
                    alert(`å·²è¨­ç½®è‚¡ç¥¨ä»£ç¢¼:${stockCode},è«‹ç¢ºä¿ä»£ç¢¼æ­£ç¢º`);
                    updateRecentStocks(stockCode, stockName || `è‚¡ç¥¨${stockCode}`, selectedCompanyType || 'auto');
                } else {
                    alert(`æœªæ‰¾åˆ°è‚¡ç¥¨: ${manualInput},è«‹æª¢æŸ¥è¼¸å…¥`);
                }
            }
        });
        
        document.getElementById('fetchBtn').addEventListener('click', async () => {
            const stockNo = document.getElementById('stockCode').value.trim();
            const startRaw = document.getElementById('startDate').value;
            const endRaw = document.getElementById('endDate').value;
            const fetchNote = document.getElementById('fetchNote');
            const historicalPricesEl = document.getElementById('historicalPrices');
            if (!stockNo) { alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼'); return; }
            if (!startRaw || !endRaw) { alert('è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸ'); return; }
            const start = new Date(startRaw);
            const end = new Date(endRaw);
            if (start > end) { alert('é–‹å§‹æ—¥æœŸä¸å¯æ™šæ–¼çµæŸæ—¥æœŸ'); return; }
            fetchNote.textContent = 'é–‹å§‹æŠ“å–è³‡æ–™...';
            try {
                const map = await fetchFinMind(stockNo, start, end);
                const allDates = datesBetween(start, end);
                const values = allDates.map(d => map[d]).filter(v => v !== undefined && v !== '');
                historicalPricesEl.value = values.join(',');
                if (values.length > 0) {
                    const prices = values.map(v => parseFloat(v)).filter(num => !isNaN(num) && num > 0); 
                    document.getElementById('historicalDays').value = prices.length;
                    document.getElementById('historicalLow').value = Math.min(...prices).toFixed(2);
                    document.getElementById('historicalHigh').value = Math.max(...prices).toFixed(2);
                    const avg = prices.reduce((sum, p) => sum + p, 0) / prices.length;
                    document.getElementById('historicalAvg').value = avg.toFixed(2);
                    const latestPrice = prices[prices.length - 1];
                    document.getElementById('currentPrice').value = latestPrice.toFixed(2);
                    const returns = [];
                    for (let i = 1; i < prices.length; i++) { returns.push(prices[i] / prices[i - 1] - 1); }
                    const meanReturn = returns.reduce((a, b) => a + b, 0) / returns.length || 0;
                    const variance = returns.reduce((sum, r) => sum + Math.pow(r - meanReturn, 2), 0) / (returns.length - 1) || 0;
                    const dailyVolatility = Math.sqrt(variance) * 100;
                    const annualVolatility = dailyVolatility * Math.sqrt(252);
                    document.getElementById('volatility').value = annualVolatility.toFixed(2);
                }
                fetchNote.textContent = `å…± ${allDates.length} æ—¥,æ‰¾åˆ° ${values.length} å€‹äº¤æ˜“æ—¥çš„æ”¶ç›¤åƒ¹ã€‚`;
            } catch (e) {
                console.error(e);
                fetchNote.textContent = 'ç™¼ç”ŸéŒ¯èª¤:' + (e.message || e);
                alert('æŠ“å–ç™¼ç”ŸéŒ¯èª¤:' + (e.message || e));
            }
        });
        
        document.getElementById('clearFetchBtn').addEventListener('click', () => {
            document.getElementById('historicalPrices').value = '';
            document.getElementById('historicalDays').value = '';
            document.getElementById('historicalLow').value = '';
            document.getElementById('historicalHigh').value = '';
            document.getElementById('historicalAvg').value = '';
            document.getElementById('volatility').value = '';
            document.getElementById('fetchNote').textContent = '';
            hideMarketComparisonChart();
        });
        
        function setupIndicatorToggles() {
            const rsiToggle = document.getElementById('rsiToggle');
            const rsiNote = document.getElementById('rsiNote');
            if (rsiToggle && rsiNote) {
                rsiNote.style.display = 'none';
                rsiNote.classList.remove('show');
                rsiToggle.classList.remove('expanded');
                const newRsiToggle = rsiToggle.cloneNode(true);
                rsiToggle.parentNode.replaceChild(newRsiToggle, rsiToggle);
                const newRsiToggleEl = document.getElementById('rsiToggle');
                const newRsiNoteEl = document.getElementById('rsiNote');
                newRsiToggleEl.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('expanded');
                    if (newRsiNoteEl.style.display === 'none') {
                        newRsiNoteEl.style.display = 'block';
                        newRsiNoteEl.classList.add('show');
                    } else {
                        newRsiNoteEl.style.display = 'none';
                        newRsiNoteEl.classList.remove('show');
                    }
                });
            }
            const macdToggle = document.getElementById('macdToggle');
            const macdNote = document.getElementById('macdNote');
            if (macdToggle && macdNote) {
                if (macdToggle.style.display !== 'none') {
                    macdNote.style.display = 'none';
                    macdNote.classList.remove('show');
                    macdToggle.classList.remove('expanded');
                    const newMacdToggle = macdToggle.cloneNode(true);
                    macdToggle.parentNode.replaceChild(newMacdToggle, macdToggle);
                    const newMacdToggleEl = document.getElementById('macdToggle');
                    const newMacdNoteEl = document.getElementById('macdNote');
                    newMacdToggleEl.addEventListener('click', function(e) {
                        e.stopPropagation();
                        this.classList.toggle('expanded');
                        if (newMacdNoteEl.style.display === 'none') {
                            newMacdNoteEl.style.display = 'block';
                            newMacdNoteEl.classList.add('show');
                        } else {
                            newMacdNoteEl.style.display = 'none';
                            newMacdNoteEl.classList.remove('show');
                        }
                    });
                }
            }
        }
        
        document.querySelectorAll('.company-type-btn').forEach(btn => {
            btn.addEventListener('click', function() { setCompanyType(this.dataset.type); });
        });
        
        // ä¿®æ”¹ï¼šåŸæœ‰çš„æ‰‹å‹•æœå°‹æŒ‰éˆ•é‚è¼¯å·²è¢«ä¸Šé¢çš„å¢å¼·ç‰ˆæœ¬æ›¿ä»£
        // åŸä¾†çš„ç¨‹å¼ç¢¼å·²è¢«ç§»é™¤
        
        document.getElementById('stockForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const stockCode = document.getElementById('stockCode').value.trim();
            const buyPriceInput = document.getElementById('buyPrice').value.trim();
            const buyPrice = buyPriceInput ? parseFloat(buyPriceInput) : null;
            const currentPrice = parseFloat(document.getElementById('currentPrice').value);
            const historicalDays = parseInt(document.getElementById('historicalDays').value);
            const historicalPricesInput = document.getElementById('historicalPrices').value.trim();
            const historicalPrices = historicalPricesInput.split(',').map(item => parseFloat(item.trim())).filter(num => !isNaN(num) && num > 0);
            const stopLossPercent = parseFloat(document.getElementById('stopLoss').value) / 100 || 0.05;
            const profitTargetPercent = parseFloat(document.getElementById('profitTarget').value) / 100 || 0.10;
            const transactionCost = parseFloat(document.getElementById('transactionCost').value) / 100 || 0.005;
            const slippage = parseFloat(document.getElementById('slippage').value) / 100 || 0.002;
            const leverage = parseFloat(document.getElementById('leverage').value) || 1;
            const marketTrend = parseFloat(document.getElementById('marketTrend').value) / 100 || 0;
            const expectedWinRateInput = document.getElementById('expectedWinRate').value.trim();
            const userProvidedWinRate = expectedWinRateInput ? parseFloat(expectedWinRateInput) : null;
            if (historicalPrices.length === 0) { alert('è«‹å…ˆæŠ“å–æˆ–è¼¸å…¥æ­·å²æ”¶ç›¤åƒ¹'); return; }
            let stockName = '';
            const foundStock = stockData.find(stock => stock.stock_id === stockCode);
            if (foundStock) {
                stockName = foundStock.stock_name;
                updateRecentStocks(foundStock.stock_id, foundStock.stock_name, foundStock.type);
            }
            const dataWarningEl = document.getElementById('dataWarning');
            let dataWarnings = [];
            if (historicalPrices.length < 14) { dataWarnings.push('æ­·å²æ•¸æ“šå°‘æ–¼ 14 å¤©,RSI è¨ˆç®—å°‡ä¸æº–ç¢º'); } else if (historicalPrices.length < 30) { dataWarnings.push('å»ºè­°ä½¿ç”¨è‡³å°‘ 30 å¤©æ•¸æ“šä»¥æé«˜åˆ†ææº–ç¢ºæ€§'); }
            if (historicalPrices.length < 26) { dataWarnings.push('æ­·å²æ•¸æ“šå°‘æ–¼ 26 å¤©,ç„¡æ³•è¨ˆç®— MACD æŒ‡æ¨™'); }
            if (dataWarnings.length > 0) {
                dataWarningEl.textContent = 'âš ï¸ æ•¸æ“šè­¦å‘Š:' + dataWarnings.join(';');
                dataWarningEl.style.display = 'block';
            } else { dataWarningEl.style.display = 'none'; }
            const historicalAvg = historicalPrices.reduce((sum, price) => sum + price, 0) / historicalPrices.length;
            document.getElementById('historicalAvg').value = historicalAvg.toFixed(2);
            const historicalLowValue = Math.min(...historicalPrices);
            const historicalHighValue = Math.max(...historicalPrices);
            let rsi = 50;
            let rsiCalculated = false;
            if (historicalPrices.length >= 14) {
                const rsiPeriod = 14;
                let gains = [], losses = [];
                for (let i = 1; i < historicalPrices.length; i++) {
                    const priceChange = historicalPrices[i] - historicalPrices[i - 1];
                    gains.push(priceChange > 0 ? priceChange : 0);
                    losses.push(priceChange < 0 ? Math.abs(priceChange) : 0);
                }
                let avgGain = gains.slice(0, rsiPeriod).reduce((sum, val) => sum + val, 0) / rsiPeriod || 0;
                let avgLoss = losses.slice(0, rsiPeriod).reduce((sum, val) => sum + val, 0) / rsiPeriod || 0;
                const smoothingFactor = 2 / (rsiPeriod + 1);
                for (let i = rsiPeriod; i < gains.length; i++) {
                    avgGain = (gains[i] * smoothingFactor) + (avgGain * (1 - smoothingFactor));
                    avgLoss = (losses[i] * smoothingFactor) + (avgLoss * (1 - smoothingFactor));
                }
                const rs = avgLoss === 0 ? Infinity : avgGain / avgLoss;
                rsi = rs === Infinity ? 100 : 100 - (100 / (1 + rs));
                rsiCalculated = true;
            }
            const rsiWarning = document.getElementById('rsiWarning');
            if (historicalPrices.length < 14) { rsiWarning.style.display = 'block'; } else { rsiWarning.style.display = 'none'; }
            function calculateEMA(prices, period) {
                const k = 2 / (period + 1);
                let ema = prices[0];
                const emaValues = [ema];
                for (let i = 1; i < prices.length; i++) {
                    ema = prices[i] * k + ema * (1 - k);
                    emaValues.push(ema);
                }
                return emaValues;
            }
            let macdSignal = 'neutral';
            let macdValue = 0;
            let macdSignalLine = 0;
            let macdHistogram = 0;
            let macdCalculated = false;
            if (historicalPrices.length >= 26) {
                const ema12 = calculateEMA(historicalPrices, 12);
                const ema26 = calculateEMA(historicalPrices, 26);
                const macdLine = ema12.map((val, idx) => val - ema26[idx]);
                const signalLine = calculateEMA(macdLine, 9);
                macdValue = macdLine[macdLine.length - 1];
                macdSignalLine = signalLine[signalLine.length - 1];
                macdHistogram = macdValue - macdSignalLine;
                macdCalculated = true;
                const prevHistogram = macdLine[macdLine.length - 2] - signalLine[signalLine.length - 2];
                if (macdHistogram > 0 && prevHistogram <= 0) { macdSignal = 'golden_cross'; } else if (macdHistogram < 0 && prevHistogram >= 0) { macdSignal = 'death_cross'; } else if (macdHistogram > 0) { macdSignal = 'bullish'; } else if (macdHistogram < 0) { macdSignal = 'bearish'; } else { macdSignal = 'neutral'; }
            }
            const returns = [];
            for (let i = 1; i < historicalPrices.length; i++) { returns.push(historicalPrices[i] / historicalPrices[i - 1] - 1); }
            const meanReturn = returns.reduce((a, b) => a + b, 0) / returns.length || 0;
            const variance = returns.reduce((sum, r) => sum + Math.pow(r - meanReturn, 2), 0) / (returns.length - 1) || 0;
            const dailyVolatility = Math.sqrt(variance) * 100;
            const weeklyVolatility = dailyVolatility * Math.sqrt(5);
            const monthlyVolatility = dailyVolatility * Math.sqrt(21);
            const annualVolatility = dailyVolatility * Math.sqrt(252);
            document.getElementById('volatility').value = annualVolatility.toFixed(2);
            const comprehensiveOdds = calculateComprehensiveOdds(historicalPrices, currentPrice, rsi, macdSignal, dailyVolatility);
            let adjustedP;
            let calculatedP;
            if (userProvidedWinRate !== null) {
                calculatedP = userProvidedWinRate / 100;
                adjustedP = Math.max(0.2, Math.min(0.8, userProvidedWinRate / 100));
            } else {
                const priceRange = historicalHighValue - historicalLowValue;
                const pricePosition = priceRange > 0 ? (currentPrice - historicalLowValue) / priceRange : 0.5;
                let baseP = 0.45 + (0.5 - pricePosition) * 0.15;
                if (rsiCalculated) {
                    if (rsi < 30) { baseP += 0.10; } else if (rsi > 70) { baseP -= 0.10; } else { baseP += (50 - rsi) / 400; }
                }
                calculatedP = baseP;
                baseP += marketTrend * 0.3;
                baseP -= (annualVolatility / 100) * 0.08;
                if (macdCalculated) {
                    if (macdSignal === 'golden_cross') { baseP += 0.08; } else if (macdSignal === 'death_cross') { baseP -= 0.08; }
                }
                adjustedP = Math.max(0.2, Math.min(0.8, baseP));
            }
            const q = 1 - adjustedP;
            const totalCost = transactionCost + slippage;
            const profitAfterCost = (profitTargetPercent * leverage) - (totalCost * 2);
            const lossAfterCost = (stopLossPercent * leverage) + (totalCost * 2);
            const b = profitAfterCost / lossAfterCost;
            const calculatedB = parseFloat(comprehensiveOdds.compositeOdds);
            const kellyRatio = (b * adjustedP - q) / b;
            const adjustedKelly = Math.max(0, Math.min(1, kellyRatio));
            const kellyFormula = `f = (bÃ—p - q) / b = (${b.toFixed(2)}Ã—${adjustedP.toFixed(2)} - ${q.toFixed(2)}) / ${b.toFixed(2)} = ${kellyRatio.toFixed(4)}`;
            let score = 0;
            let scoreReasons = [];
            if (rsiCalculated) {
                if (rsi < 30) { score += 20; scoreReasons.push('RSI è¶…è³£(+20)'); } else if (rsi > 70) { score += 0; scoreReasons.push('RSI è¶…è²·(+0)'); } else if (rsi >= 40 && rsi <= 60) { score += 10; scoreReasons.push('RSI ä¸­æ€§(+10)'); } else if (rsi < 40) { score += 15; scoreReasons.push('RSI åä½(+15)'); } else { score += 5; scoreReasons.push('RSI åé«˜(+5)'); }
            } else { score += 10; scoreReasons.push('RSI ç„¡æ³•è¨ˆç®—(+10 é è¨­)'); }
            if (macdCalculated) {
                if (macdSignal === 'golden_cross') { score += 20; scoreReasons.push('MACD é»ƒé‡‘äº¤å‰(+20)'); } else if (macdSignal === 'death_cross') { score += 0; scoreReasons.push('MACD æ­»äº¡äº¤å‰(+0)'); } else if (macdSignal === 'bullish') { score += 15; scoreReasons.push('MACD å¤šé ­(+15)'); } else if (macdSignal === 'bearish') { score += 5; scoreReasons.push('MACD ç©ºé ­(+5)'); } else { score += 10; scoreReasons.push('MACD ä¸­æ€§(+10)'); }
            } else { score += 10; scoreReasons.push('MACD ç„¡æ³•è¨ˆç®—(+10 é è¨­)'); }
            const priceRange = historicalHighValue - historicalLowValue;
            const pricePosition = priceRange > 0 ? (currentPrice - historicalLowValue) / priceRange : 0.5;
            const priceScore = Math.round((1 - pricePosition) * 20);
            score += priceScore;
            scoreReasons.push(`åƒ¹æ ¼ä½ç½®(+${priceScore})`);
            if (adjustedKelly > 0.5) { score += 20; scoreReasons.push('å‡±åˆ©æ¯”ä¾‹å„ªç•°(+20)'); } else if (adjustedKelly > 0.25) { score += 15; scoreReasons.push('å‡±åˆ©æ¯”ä¾‹è‰¯å¥½(+15)'); } else if (adjustedKelly > 0.15) { score += 10; scoreReasons.push('å‡±åˆ©æ¯”ä¾‹é©ä¸­(+10)'); } else if (adjustedKelly > 0.05) { score += 5; scoreReasons.push('å‡±åˆ©æ¯”ä¾‹åä½(+5)'); } else { score += 0; scoreReasons.push('å‡±åˆ©æ¯”ä¾‹æ¥µä½(+0)'); }
            if (marketTrend > 0.1) { score += 10; scoreReasons.push('å¼·å‹¢ç‰›å¸‚(+10)'); } else if (marketTrend > 0) { score += 7; scoreReasons.push('æº«å’Œç‰›å¸‚(+7)'); } else if (marketTrend > -0.1) { score += 5; scoreReasons.push('å¸‚å ´ä¸­æ€§(+5)'); } else { score += 2; scoreReasons.push('ç†Šå¸‚ç’°å¢ƒ(+2)'); }
            if (annualVolatility < 20) { score += 10; scoreReasons.push('æ³¢å‹•ç‡ä½(+10)'); } else if (annualVolatility < 40) { score += 7; scoreReasons.push('æ³¢å‹•ç‡é©ä¸­(+7)'); } else if (annualVolatility < 60) { score += 4; scoreReasons.push('æ³¢å‹•ç‡è¼ƒé«˜(+4)'); } else { score += 2; scoreReasons.push('æ³¢å‹•ç‡æ¥µé«˜(+2)'); }
            let customBuyPrice;
            let customBuyMethod;
            if (buyPrice !== null && buyPrice > 0) {
                customBuyPrice = buyPrice;
                customBuyMethod = `ä½¿ç”¨æ‚¨è¼¸å…¥çš„è²·å…¥åƒ¹æ ¼`;
            } else {
                customBuyPrice = currentPrice * 0.95;
                customBuyMethod = `åŸºæ–¼ç•¶å‰åƒ¹æ ¼ä¸‹èª¿ 5% çš„ä¿å®ˆè²·å…¥åƒ¹`;
            }
            let customStopLossPrice;
            let customStopLossMethod;
            if (buyPrice !== null && buyPrice > 0) {
                customStopLossPrice = buyPrice * (1 - stopLossPercent);
                customStopLossMethod = `åŸºæ–¼è²·å…¥åƒ¹æ ¼ä¸‹èª¿ ${(stopLossPercent * 100).toFixed(1)}%`;
            } else {
                customStopLossPrice = customBuyPrice * (1 - stopLossPercent);
                customStopLossMethod = `åŸºæ–¼ç”¨æˆ·è²·å…¥åƒ¹ä¸‹èª¿ ${(stopLossPercent * 100).toFixed(1)}%`;
            }
            let customSellPrice;
            let customSellMethod;
            if (buyPrice !== null && buyPrice > 0) {
                customSellPrice = buyPrice * (1 + profitTargetPercent);
                customSellMethod = `åŸºæ–¼è²·å…¥åƒ¹æ ¼ä¸Šèª¿ ${(profitTargetPercent * 100).toFixed(1)}%`;
            } else {
                customSellPrice = customBuyPrice * (1 + profitTargetPercent);
                customSellMethod = `åŸºæ–¼ç”¨æˆ·è²·å…¥åƒ¹ä¸Šèª¿ ${(profitTargetPercent * 100).toFixed(1)}%`;
            }
            
            // ä¿®æ”¹ï¼šä½¿ç”¨å°ˆæ¥­ç®—æ³•è¨ˆç®—AIå»ºè­°åƒ¹æ ¼
            const aiBuyResult = ProfessionalPriceCalculator.calculateProfessionalBuyPrice(
                currentPrice, historicalPrices, monthlyVolatility, rsi, marketTrend, score
            );
            
            const aiStopLossResult = ProfessionalPriceCalculator.calculateProfessionalStopLoss(
                buyPrice || aiBuyResult.price, historicalPrices, monthlyVolatility, score
            );
            
            const aiSellResult = ProfessionalPriceCalculator.calculateProfessionalSellPrice(
                buyPrice || aiBuyResult.price, 
                historicalPrices, monthlyVolatility, rsi, marketTrend, score
            );
            
            let recommendation = '';
            let recommendationClass = '';
            let recommendationReason = '';
            if (score >= 80) {
                recommendation = 'å¼·çƒˆå»ºè­°è²·å…¥';
                recommendationClass = 'buy';
                recommendationReason = `(ç¶œåˆè©•åˆ† ${score} åˆ†,å¤šé …æŒ‡æ¨™å‘ˆç¾å¼·çƒˆè²·å…¥ä¿¡è™Ÿ)`;
            } else if (score >= 65) {
                recommendation = 'å»ºè­°è²·å…¥';
                recommendationClass = 'buy';
                recommendationReason = `(ç¶œåˆè©•åˆ† ${score} åˆ†,æ•´é«”æ¢ä»¶è‰¯å¥½)`;
            } else if (score >= 50) {
                recommendation = 'å¯è€ƒæ…®è²·å…¥';
                recommendationClass = 'buy';
                recommendationReason = `(ç¶œåˆè©•åˆ† ${score} åˆ†,æ¢ä»¶å°šå¯,å»ºè­°å°é¡è©¦å–®)`;
            } else if (score >= 35) {
                recommendation = 'æŒå€‰è§€æœ›';
                recommendationClass = 'hold';
                recommendationReason = `(ç¶œåˆè©•åˆ† ${score} åˆ†,å»ºè­°ç­‰å¾…æ›´å¥½æ™‚æ©Ÿ)`;
            } else if (score >= 20) {
                recommendation = 'å»ºè­°è§€æœ›';
                recommendationClass = 'hold';
                recommendationReason = `(ç¶œåˆè©•åˆ† ${score} åˆ†,ç•¶å‰ä¸æ˜¯å¥½çš„é€²å ´æ™‚æ©Ÿ)`;
            } else {
                recommendation = 'å»ºè­°è³£å‡ºæˆ–è§€æœ›';
                recommendationClass = 'sell';
                recommendationReason = `(ç¶œåˆè©•åˆ† ${score} åˆ†,å¤šé …æŒ‡æ¨™å‘ˆç¾è³£å‡ºä¿¡è™Ÿ)`;
            }
            if (adjustedKelly <= 0) {
                recommendation = 'ä¸å»ºè­°æŠ•è³‡';
                recommendationClass = 'sell';
                recommendationReason = '(å‡±åˆ©æ¯”ä¾‹ç‚ºè² ,æœŸæœ›å ±é…¬ç‚ºè² )';
            } else if (currentPrice >= historicalHighValue * 0.98) {
                recommendation = 'å»ºè­°ç­‰å¾…å›èª¿';
                recommendationClass = 'hold';
                recommendationReason = '(ç•¶å‰åƒ¹æ ¼æ¥è¿‘æ­·å²é«˜ä½)';
            }
            document.getElementById('resultStockCode').textContent = `${stockCode} ${stockName ? `(${stockName})` : ''}`;
            document.getElementById('resultCurrentPrice').textContent = `${currentPrice.toFixed(2)}`;
            document.getElementById('actualBuyPrice').textContent = buyPrice !== null ? buyPrice.toFixed(2) : 'æœªå¡«å¯«';
            document.getElementById('scoreValue').textContent = `${score} / 100 åˆ† (${scoreReasons.join(', ')})`;
            const recommendationElement = document.getElementById('recommendation');
            recommendationElement.textContent = `${recommendation} ${recommendationReason}`;
            recommendationElement.className = 'recommendation ' + recommendationClass;
            const rsiElement = document.getElementById('rsiValue');
            if (rsiCalculated) {
                let rsiAdvice = '';
                if (rsi < 30) {
                    rsiAdvice = ' - ğŸ“Š è™•æ–¼è¶…è³£å€,è‚¡åƒ¹å¯èƒ½è¢«ä½ä¼°,å¯è€ƒæ…®é€¢ä½è²·é€²';
                    rsiElement.className = 'rsi-value oversold';
                } else if (rsi > 70) {
                    rsiAdvice = ' - âš ï¸ è™•æ–¼è¶…è²·å€,è‚¡åƒ¹å¯èƒ½éé«˜,å»ºè­°è¬¹æ…è¿½é«˜æˆ–è€ƒæ…®è³£å‡º';
                    rsiElement.className = 'rsi-value overbought';
                } else if (rsi >= 40 && rsi <= 60) {
                    rsiAdvice = ' - âœ“ è™•æ–¼ä¸­æ€§å€é–“,å¸‚å ´å¤šç©ºåŠ›é‡ç›¸å°å‡è¡¡';
                    rsiElement.className = 'rsi-value neutral';
                } else if (rsi < 40) {
                    rsiAdvice = ' - ğŸ“ˆ åå‘è¶…è³£,è‚¡åƒ¹ç›¸å°åä½,å¯ç•™æ„åå½ˆæ©Ÿæœƒ';
                    rsiElement.className = 'rsi-value neutral';
                } else {
                    rsiAdvice = ' - ğŸ“‰ åå‘è¶…è²·,è‚¡åƒ¹ç›¸å°åé«˜,å»ºè­°æ³¨æ„å›èª¿é¢¨éšª';
                    rsiElement.className = 'rsi-value neutral';
                }
                rsiElement.textContent = rsi.toFixed(2) + rsiAdvice;
            } else {
                rsiElement.textContent = 'æ•¸æ“šä¸è¶³,ç„¡æ³•è¨ˆç®—';
                rsiElement.className = 'rsi-value';
            }
            const macdInfoEl = document.getElementById('macdInfo');
            const macdSignalEl = document.getElementById('macdSignal');
            const macdToggleEl = document.getElementById('macdToggle');
            const macdNoteEl = document.getElementById('macdNote');
            if (macdCalculated) {
                macdInfoEl.style.display = 'block';
                macdToggleEl.style.display = 'flex';
                macdToggleEl.style.visibility = 'visible';
                macdToggleEl.style.opacity = '1';
                let macdText = '';
                let macdClass = '';
                let macdAdvice = '';
                if (macdSignal === 'golden_cross') {
                    macdText = `é»ƒé‡‘äº¤å‰(è²·å…¥ä¿¡è™Ÿ) MACD: ${macdValue.toFixed(2)}, Signal: ${macdSignalLine.toFixed(2)}, Histogram: ${macdHistogram.toFixed(2)}`;
                    macdClass = 'buy';
                    macdAdvice = ' - ğŸš€ çŸ­æœŸè¶¨å‹¢ç”±å¼±è½‰å¼·,å½¢æˆè²·å…¥ä¿¡è™Ÿ,ä½†å»ºè­°çµåˆå…¶ä»–æŒ‡æ¨™ç¢ºèª';
                } else if (macdSignal === 'death_cross') {
                    macdText = `æ­»äº¡äº¤å‰(è³£å‡ºä¿¡è™Ÿ) MACD: ${macdValue.toFixed(2)}, Signal: ${macdSignalLine.toFixed(2)}, Histogram: ${macdHistogram.toFixed(2)}`;
                    macdClass = 'sell';
                    macdAdvice = ' - ğŸ“‰ çŸ­æœŸè¶¨å‹¢ç”±å¼·è½‰å¼±,å½¢æˆè³£å‡ºä¿¡è™Ÿ,å»ºè­°è€ƒæ…®æ¸›å€‰æˆ–è§€æœ›';
                } else if (macdSignal === 'bullish') {
                    macdText = `å¤šé ­(MACD > Signal) MACD: ${macdValue.toFixed(2)}, Signal: ${macdSignalLine.toFixed(2)}, Histogram: ${macdHistogram.toFixed(2)}`;
                    macdClass = 'buy';
                    macdAdvice = ' - ğŸ“ˆ ç¶­æŒå¤šé ­æ ¼å±€,çŸ­æœŸè¶¨å‹¢å‘ä¸Š,å¯æŒçºŒæŒæœ‰æˆ–é€¢ä½åŠ ç¢¼';
                } else if (macdSignal === 'bearish') {
                    macdText = `ç©ºé ­(MACD < Signal) MACD: ${macdValue.toFixed(2)}, Signal: ${macdSignalLine.toFixed(2)}, Histogram: ${macdHistogram.toFixed(2)}`;
                    macdClass = 'sell';
                    macdAdvice = ' - ğŸ“Š ç¶­æŒç©ºé ­æ ¼å±€,çŸ­æœŸè¶¨å‹¢å‘ä¸‹,å»ºè­°è§€æœ›æˆ–ç­‰å¾…è¶¨å‹¢åè½‰';
                } else {
                    macdText = `ä¸­æ€§ MACD: ${macdValue.toFixed(2)}, Signal: ${macdSignalLine.toFixed(2)}, Histogram: ${macdHistogram.toFixed(2)}`;
                    macdClass = 'hold';
                    macdAdvice = ' - âš–ï¸ è¶¨å‹¢ä¸æ˜ç¢º,å»ºè­°ç­‰å¾…æ›´æ¸…æ™°çš„ä¿¡è™Ÿ';
                }
                macdSignalEl.textContent = macdText + macdAdvice;
                macdSignalEl.className = 'recommendation ' + macdClass;
            } else {
                macdInfoEl.style.display = 'none';
                macdToggleEl.style.display = 'none';
                macdNoteEl.style.display = 'none';
            }
            document.getElementById('customBuyPrice').textContent = `${customBuyPrice.toFixed(2)} (${customBuyMethod})`;
            document.getElementById('customStopLossPrice').textContent = `${customStopLossPrice.toFixed(2)} (${customStopLossMethod})`;
            document.getElementById('customSellPrice').textContent = `${customSellPrice.toFixed(2)} (${customSellMethod})`;
            
            // ä¿®æ”¹ï¼šé¡¯ç¤ºå°ˆæ¥­ç®—æ³•çš„AIå»ºè­°åƒ¹æ ¼
            const buyPriceDisplay = aiBuyResult.price.toFixed(2);
            const buyMethod = aiBuyResult.method;
            const buyAdjustment = aiBuyResult.adjustment;
            
            const sellPriceDisplay = aiSellResult.price.toFixed(2);
            const sellMethod = aiSellResult.method;
            const sellAdjustment = aiSellResult.adjustment;
            
            const stopLossPriceDisplay = aiStopLossResult.price.toFixed(2);
            const stopLossMethod = aiStopLossResult.method;
            const stopLossAdjustment = aiStopLossResult.adjustment;
            
            document.getElementById('aiSuggestedBuyPrice').innerHTML = 
                `<strong>${buyPriceDisplay}</strong><br><small>${buyMethod}<br>èª¿æ•´å› ç´ : ${buyAdjustment}</small>`;
            
            document.getElementById('aiSellPrice').innerHTML = 
                `<strong>${sellPriceDisplay}</strong><br><small>${sellMethod}<br>èª¿æ•´å› ç´ : ${sellAdjustment}${aiSellResult.riskRewardRatio ? `<br>é¢¨éšªå ±é…¬æ¯”: ${aiSellResult.riskRewardRatio}:1` : ''}</small>`;
            
            document.getElementById('aiStopLossPrice').innerHTML = 
                `<strong>${stopLossPriceDisplay}</strong><br><small>${stopLossMethod}<br>èª¿æ•´å› ç´ : ${stopLossAdjustment}</small>`;
            
            // æª¢æŸ¥åƒ¹æ ¼é‚è¼¯ä¸€è‡´æ€§
            const stopLossWarningEl = document.getElementById('stopLossWarning');
            stopLossWarningEl.style.display = 'none';
            
            // ç¢ºä¿æ­¢æåƒ¹ä½æ–¼è²·å…¥åƒ¹
            if (aiStopLossResult.price >= (buyPrice || aiBuyResult.price)) {
                stopLossWarningEl.innerHTML = `
                    <strong>âš ï¸ é‚è¼¯éŒ¯èª¤:</strong> AIå»ºè­°æ­¢æåƒ¹(${aiStopLossResult.price.toFixed(2)})ä¸ä½æ–¼è²·å…¥åƒ¹(${(buyPrice || aiBuyResult.price).toFixed(2)})ã€‚<br>
                    é€™è¡¨ç¤ºä¸€è²·å…¥å°±é æœŸè™§æï¼Œä¸ç¬¦åˆç²åˆ©é¿éšªåŸå‰‡ã€‚
                `;
                stopLossWarningEl.style.display = 'block';
            }
            // ç¢ºä¿è³£å‡ºåƒ¹é«˜æ–¼è²·å…¥åƒ¹
            else if (aiSellResult.price <= (buyPrice || aiBuyResult.price)) {
                stopLossWarningEl.innerHTML = `
                    <strong>âš ï¸ é‚è¼¯éŒ¯èª¤:</strong> AIå»ºè­°è³£å‡ºåƒ¹(${aiSellResult.price.toFixed(2)})ä¸é«˜æ–¼è²·å…¥åƒ¹(${(buyPrice || aiBuyResult.price).toFixed(2)})ã€‚<br>
                    é€™è¡¨ç¤ºé æœŸè™§æäº¤æ˜“ï¼Œä¸ç¬¦åˆç²åˆ©åŸå‰‡ã€‚
                `;
                stopLossWarningEl.style.display = 'block';
            }
            // æª¢æŸ¥é¢¨éšªå ±é…¬æ¯”
            else {
                const risk = (buyPrice || aiBuyResult.price) - aiStopLossResult.price;
                const reward = aiSellResult.price - (buyPrice || aiBuyResult.price);
                const riskRewardRatio = reward / risk;
                
                if (riskRewardRatio < 1) {
                    stopLossWarningEl.innerHTML = `
                        <strong>âš ï¸ é¢¨éšªè­¦å‘Š:</strong> é¢¨éšªå ±é…¬æ¯”åƒ… ${riskRewardRatio.toFixed(2)}:1ï¼Œä½æ–¼ä¸€èˆ¬å»ºè­°çš„ 2:1 æ¨™æº–ã€‚<br>
                        æ¯æ‰¿æ“”1å…ƒé¢¨éšªåƒ…æœŸæœ›ç²å¾— ${riskRewardRatio.toFixed(2)} å…ƒå›å ±ã€‚
                    `;
                    stopLossWarningEl.style.display = 'block';
                }
            }
            
            let calculatedWinRateText = `${(calculatedP * 100).toFixed(2)}%`;
            if (userProvidedWinRate !== null) { calculatedWinRateText += '(ä¾†è‡ªç”¨æˆ·è¼¸å…¥)'; } else { calculatedWinRateText += '(è¨ˆç®—å…¬å¼:0.45 + (0.5 - åƒ¹æ ¼ä½ç½®) Ã— 0.15 Â± RSIèª¿æ•´)'; }
            document.getElementById('calculatedWinRate').textContent = calculatedWinRateText;
            document.getElementById('calculatedOdds').innerHTML = `${calculatedB.toFixed(2)}<br><small>(åŸºæ–¼æ³¢å‹•ç‡ã€åƒ¹æ ¼ä½ç½®ã€æ­·å²å›æ’¤ç¶œåˆè¨ˆç®—)<br>${comprehensiveOdds.summary}</small>`;
            let kellyAdvice = '';
            if (adjustedKelly <= 0) { kellyAdvice = 'âŒ å»ºè­°:ä¸è¦æŠ•è³‡æ­¤æ¨™çš„,æœŸæœ›å ±é…¬ç‚ºè² '; } else if (adjustedKelly < 0.05) { kellyAdvice = 'âš ï¸ å»ºè­°:æŠ•è³‡åƒ¹å€¼æ¥µä½,å»ºè­°å°‹æ‰¾æ›´å¥½çš„æ©Ÿæœƒ'; } else if (adjustedKelly < 0.15) { kellyAdvice = 'å»ºè­°:å¯å°é¡è©¦å–®,å¯¦éš›æŠ•è³‡é‡‘é¡å»ºè­°ä¸è¶…éç¸½è³‡é‡‘çš„ 3-7%'; } else if (adjustedKelly < 0.25) { kellyAdvice = 'å»ºè­°:é©åº¦æŠ•è³‡,å¯¦éš›æŠ•è³‡é‡‘é¡å»ºè­°ç´„ç¸½è³‡é‡‘çš„ 6-12%'; } else if (adjustedKelly < 0.50) { kellyAdvice = 'å»ºè­°:è¼ƒä½³æŠ•è³‡æ©Ÿæœƒ,å¯¦éš›æŠ•è³‡é‡‘é¡å»ºè­°ç´„ç¸½è³‡é‡‘çš„ 10-20%'; } else if (adjustedKelly < 0.75) { kellyAdvice = 'å»ºè­°:å„ªè³ªæŠ•è³‡æ©Ÿæœƒ,å¯¦éš›æŠ•è³‡é‡‘é¡å»ºè­°ç´„ç¸½è³‡é‡‘çš„ 15-30%(ä½†è«‹æ³¨æ„é¢¨éšª)'; } else { kellyAdvice = 'å»ºè­°:æ¥µä½³æŠ•è³‡æ©Ÿæœƒ,ä½†å¯¦éš›æŠ•è³‡ä»å»ºè­°ä¸è¶…éç¸½è³‡é‡‘çš„ 30-40% ä»¥åˆ†æ•£é¢¨éšª'; }
            const winRateSource = userProvidedWinRate !== null ? '(ä½¿ç”¨æ‚¨è¼¸å…¥çš„é æœŸå‹ç‡)' : '(AIåŸºæ–¼æ•¸æ“šå¤šé‡è¨ˆç®—,æ¥è¿‘çœŸå¯¦æ•¸å€¼ã€‚)';
            document.getElementById('adjustedWinRate').textContent = `${(adjustedP * 100).toFixed(2)}% ${winRateSource}`;
            let oddsAdvice = '';
            if (b < 1) { oddsAdvice = 'âŒ é¢¨éšªå ±é…¬æ¯”ä¸ä½³,ç›ˆåˆ©ç›®æ¨™ä½æ–¼æ­¢æå¹…åº¦,å»ºè­°èª¿æ•´åƒæ•¸'; } else if (b < 1.5) { oddsAdvice = 'âš ï¸ é¢¨éšªå ±é…¬æ¯”åä½,å»ºè­°æé«˜ç›ˆåˆ©ç›®æ¨™æˆ–é™ä½æ­¢æå¹…åº¦'; } else if (b < 2) { oddsAdvice = 'âœ“ é¢¨éšªå ±é…¬æ¯”åˆç†,ç¬¦åˆä¸€èˆ¬äº¤æ˜“æ¨™æº–'; } else if (b < 3) { oddsAdvice = 'âœ“âœ“ é¢¨éšªå ±é…¬æ¯”è‰¯å¥½,æ¯æ‰¿æ“”1å…ƒé¢¨éšªå¯æœŸæœ›ç²å¾—2-3å…ƒå›å ±'; } else { oddsAdvice = 'âœ“âœ“âœ“ é¢¨éšªå ±é…¬æ¯”å„ªç•°,æ¯æ‰¿æ“”1å…ƒé¢¨éšªå¯æœŸæœ›ç²å¾—3å…ƒä»¥ä¸Šå›å ±'; }
            document.getElementById('adjustedOdds').textContent = `${b.toFixed(2)} (AIåŸºæ–¼è²¡å‹™æ‘©æ“¦ã€ç­–ç•¥å¤±æ•ˆã€å¸‚å ´ç‹€æ…‹ã€æ¥µç«¯æ³¢å‹•ç­‰å¤šç¶­åº¦è©•ä¼°ã€‚) - ${oddsAdvice}`;
            let kellyDisplay = `${(adjustedKelly * 100).toFixed(2)}%<br><small>è¨ˆç®—å¼:${kellyFormula}</small><br><strong>${kellyAdvice}</strong>`;
            if (adjustedKelly <= 0) { kellyDisplay = `<span class="warning">${(adjustedKelly * 100).toFixed(2)}%</span><br><small>${kellyFormula}</small><br><strong>${kellyAdvice}</strong>`; } else if (adjustedKelly < 0.05) { kellyDisplay = `<span class="warning">${(adjustedKelly * 100).toFixed(2)}%</span><br><small>${kellyFormula}</small><br><strong>${kellyAdvice}</strong>`; }
            if (userProvidedWinRate === null) { kellyDisplay += '<br><br><span class="warning">âš ï¸ é‡è¦æé†’:ç”±æ–¼å‹ç‡æ˜¯åŸºæ–¼æŠ€è¡“æŒ‡æ¨™è¨ˆç®—,å¯¦éš›æŠ•è³‡å‰è«‹å‹™å¿…æ ¹æ“šæ‚¨çš„äº¤æ˜“æ­·å²èª¿æ•´é æœŸå‹ç‡ã€‚</span>'; }
            document.getElementById('kellyRatio').innerHTML = kellyDisplay;
            let dailyVolAdvice = '';
            if (dailyVolatility < 1) { dailyVolAdvice = 'æ³¢å‹•æ¥µä½,é©åˆä¿å®ˆå‹æŠ•è³‡è€…,ä½†ç²åˆ©ç©ºé–“æœ‰é™'; } else if (dailyVolatility < 2) { dailyVolAdvice = 'æ³¢å‹•è¼ƒä½,é¢¨éšªç›¸å°å¯æ§,é©åˆç©©å¥å‹æŠ•è³‡'; } else if (dailyVolatility < 3) { dailyVolAdvice = 'æ³¢å‹•é©ä¸­,é¢¨éšªèˆ‡æ©Ÿæœƒä¸¦å­˜,é©åˆä¸€èˆ¬æŠ•è³‡è€…'; } else if (dailyVolatility < 5) { dailyVolAdvice = 'æ³¢å‹•è¼ƒé«˜,éœ€è¦è¼ƒå¼·çš„é¢¨éšªæ‰¿å—èƒ½åŠ›'; } else { dailyVolAdvice = 'æ³¢å‹•æ¥µé«˜,é«˜é¢¨éšªé«˜å›å ±,åƒ…é©åˆç©æ¥µå‹æŠ•è³‡è€…'; }
            let weeklyVolAdvice = '';
            if (weeklyVolatility < 5) { weeklyVolAdvice = 'å‘¨æ³¢å‹•ç‡ä½,é©åˆçŸ­æœŸäº¤æ˜“è€…'; } else if (weeklyVolatility < 10) { weeklyVolAdvice = 'å‘¨æ³¢å‹•ç‡é©ä¸­,é©åˆæ³¢æ®µæ“ä½œ'; } else { weeklyVolAdvice = 'å‘¨æ³¢å‹•ç‡é«˜,éœ€è¦å¯†åˆ‡é—œæ³¨å¸‚å ´è®ŠåŒ–'; }
            let monthlyVolAdvice = '';
            if (monthlyVolatility < 10) { monthlyVolAdvice = 'æœˆæ³¢å‹•ç‡ä½,é©åˆä¸­é•·æœŸæŠ•è³‡è€…'; } else if (monthlyVolatility < 20) { monthlyVolAdvice = 'æœˆæ³¢å‹•ç‡é©ä¸­,å¹³è¡¡é¢¨éšªèˆ‡å›å ±'; } else { monthlyVolAdvice
            = 'æœˆæ³¢å‹•ç‡é«˜,éœ€è¦è¼ƒå¼·çš„é¢¨éšªæ‰¿å—èƒ½åŠ›å’Œå¸‚å ´åˆ¤æ–·èƒ½åŠ›'; }
            document.getElementById('dailyVolatility').textContent = `${dailyVolatility.toFixed(2)}% - ${dailyVolAdvice}`;
            document.getElementById('weeklyVolatility').textContent = `${weeklyVolatility.toFixed(2)}% - ${weeklyVolAdvice}`;
            document.getElementById('monthlyVolatility').textContent = `${monthlyVolatility.toFixed(2)}% - ${monthlyVolAdvice}`;
            document.getElementById('annualVolatility').textContent = `${annualVolatility.toFixed(2)}%`;
            document.getElementById('results').classList.add('show');
            setupIndicatorToggles();
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
        
        // ä¿®æ”¹ï¼šé é¢åŠ è¼‰æ™‚åˆå§‹åŒ–å°ˆæ¥­åˆ†ææŒ‰éˆ•
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDateRange();
            loadStockList();
            
            // ä¿®æ”¹ï¼šç¢ºä¿å°ˆæ¥­åˆ†ææŒ‰éˆ•åˆå§‹åŒ–
            setupProfessionalAnalysisButton();
        });
    </script>
</body>
</html>